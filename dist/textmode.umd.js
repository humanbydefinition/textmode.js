(function(b,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):T((b=typeof globalThis<"u"?globalThis:b||self).textmode={})})(this,function(b){"use strict";var hi=Object.defineProperty;var oi=(b,T,B)=>T in b?hi(b,T,{enumerable:!0,configurable:!0,writable:!0,value:B}):b[T]=B;var a=(b,T,B)=>oi(b,typeof T!="symbol"?T+"":T,B);class T extends Error{constructor(t,e={}){super(T.i(t,e)),this.name="TextmodeError"}static i(t,e){return`${t}${e&&Object.keys(e).length>0?`

ðŸ“‹ Context:${Object.entries(e).map(([i,r])=>`
  - ${i}: ${T.o(r)}`).join("")}`:""}

${"â†“".repeat(24)}
`}static o(t){if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return`"${t}"`;if(typeof t=="number"||typeof t=="boolean")return String(t);if(Array.isArray(t))return t.length===0?"[]":t.length<=5?`[${t.map(e=>T.o(e)).join(", ")}]`:`[${t.slice(0,3).map(e=>T.o(e)).join(", ")}, ... +${t.length-3} more]`;if(typeof t=="object"){const e=Object.keys(t);return e.length===0?"{}":e.length<=3?`{ ${e.map(i=>`${i}: ${T.o(t[i])}`).join(", ")} }`:`{ ${e.slice(0,2).map(i=>`${i}: ${T.o(t[i])}`).join(", ")}, ... +${e.length-2} more }`}return String(t)}}var B=(h=>(h[h.SILENT=0]="SILENT",h[h.WARNING=1]="WARNING",h[h.ERROR=2]="ERROR",h[h.THROW=3]="THROW",h))(B||{});const G=class G{constructor(){a(this,"l",{globalLevel:3})}static u(){return G.h||(G.h=new G),G.h}v(t,e){const i="%c[textmode.js] Oops! (â•¯Â°â–¡Â°)â•¯ï¸µ Something went wrong in your code.",r="color: #f44336; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px;";switch(this.l.globalLevel){case 0:return!1;case 1:return console.group(i,r),console.warn(T.i(t,e)),console.groupEnd(),!1;case 2:return console.group(i,r),console.error(T.i(t,e)),console.groupEnd(),!1;default:throw new T(t,e)}}m(t,e,i){return!!t||(this.v(e,i),!1)}_(t){this.l.globalLevel=t}};a(G,"h",null);let ct=G;const lt=ct.u();class k{constructor(t,e,i){a(this,"A");a(this,"C");a(this,"M",new Map);a(this,"$",new Map);a(this,"F",0);a(this,"P",new Map);a(this,"U");this.A=t,this.U=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)??16,this.C=this.S(e,i),this.R()}R(){const t=this.A.getProgramParameter(this.C,this.A.ACTIVE_UNIFORMS);for(let e=0;e<t;e++){const i=this.A.getActiveUniform(this.C,e);if(i){const r=i.name.replace(/\[0\]$/,""),s=this.A.getUniformLocation(this.C,r);s&&(this.M.set(r,s),this.$.set(r,{type:i.type,size:i.size}))}}}S(t,e){const i=this.k(this.A.VERTEX_SHADER,t),r=this.k(this.A.FRAGMENT_SHADER,e),s=this.A.createProgram();if(this.A.attachShader(s,i),this.A.attachShader(s,r),this.A.linkProgram(s),!this.A.getProgramParameter(s,this.A.LINK_STATUS)){const n=this.A.getProgramInfoLog(s);throw new Error(`Shader program link error: ${n}`)}return this.A.deleteShader(i),this.A.deleteShader(r),s}k(t,e){const i=this.A.createShader(t);if(this.A.shaderSource(i,e),this.A.compileShader(i),!this.A.getShaderParameter(i,this.A.COMPILE_STATUS)){const r=this.A.getShaderInfoLog(i);throw this.A.deleteShader(i),new Error(`Shader compilation error: ${r}`)}return i}L(){this.A.useProgram(this.C),this.D()}D(){this.F=0,this.P.clear()}O(t){for(const e in t)this.H(e,t[e])}H(t,e){var c,l;const i=this.M.get(t);if(!i)return;const r=this.$.get(t);if(!r)return;const{type:s,size:n}=r,o=this.A;if(e instanceof WebGLTexture){const u=this.I(t);return o.uniform1i(i,u),o.activeTexture(o.TEXTURE0+u),void o.bindTexture(o.TEXTURE_2D,e)}if(e instanceof D){const u=this.I(t);return o.uniform1i(i,u),o.activeTexture(o.TEXTURE0+u),void o.bindTexture(o.TEXTURE_2D,e.textures[0])}if(typeof e=="number")return void(s===o.INT||s===o.BOOL?o.uniform1i(i,e):o.uniform1f(i,e));if(typeof e=="boolean")return void o.uniform1i(i,e?1:0);if(Array.isArray(e[0])){const u=e.flat(),f={[o.FLOAT_VEC2]:()=>o.uniform2fv(i,u),[o.FLOAT_VEC3]:()=>o.uniform3fv(i,u),[o.FLOAT_VEC4]:()=>o.uniform4fv(i,u)};(c=f[s])==null||c.call(f)}else{const u=e,f={[o.FLOAT]:()=>n>1?o.uniform1fv(i,u):o.uniform1f(i,u[0]),[o.FLOAT_VEC2]:()=>o.uniform2fv(i,u),[o.FLOAT_VEC3]:()=>o.uniform3fv(i,u),[o.FLOAT_VEC4]:()=>o.uniform4fv(i,u),[o.INT]:()=>n>1?o.uniform1iv(i,u):o.uniform1i(i,u[0]),[o.INT_VEC2]:()=>o.uniform2iv(i,u),[o.INT_VEC3]:()=>o.uniform3iv(i,u),[o.INT_VEC4]:()=>o.uniform4iv(i,u),[o.BOOL]:()=>o.uniform1iv(i,u),[o.FLOAT_MAT2]:()=>o.uniformMatrix2fv(i,!1,u),[o.FLOAT_MAT3]:()=>o.uniformMatrix3fv(i,!1,u),[o.FLOAT_MAT4]:()=>o.uniformMatrix4fv(i,!1,u)};(l=f[s])==null||l.call(f)}}I(t){const e=this.P.get(t);if(e!==void 0)return e;if(this.F>=this.U)throw new Error(`[textmode.js] Shader attempted to bind more than ${this.U} texture samplers. Uniform "${t}" cannot be assigned.`);const i=this.F++;return this.P.set(t,i),i}get program(){return this.C}dispose(){this.A.deleteProgram(this.C)}}function Et(h,t,e,i){return 180*Math.atan2(i-t,e-h)/Math.PI}function H(h,t,e,i){return Math.hypot(e-h,i-t)}function X(h,t,e){return Math.min(Math.max(h,t),e)}function bt(h){return(h%360+360)%360/360}function Tt(h,t,e){h.bindTexture(h.TEXTURE_2D,t),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,1),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,e),h.bindTexture(h.TEXTURE_2D,null)}function ut(h,t,e,i,r){h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,t),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,r)}function ft(h,t,e,i,r,s=0,n=WebGL2RenderingContext.FLOAT,o=!1){h.enableVertexAttribArray(t),h.vertexAttribPointer(t,e,n,o,i,r),h.vertexAttribDivisor(t,s)}function xt(h,t,e,i,r){h.bindBuffer(t,e),h.bufferData(t,i,r),h.bindBuffer(t,null)}const J=`#version 300 es
in vec2 A0;in vec2 A1;in vec2 A2;in vec2 A3;in vec3 A4;in vec4 A5;in vec4 A6;in vec4 A7;in vec3 A8;in vec3 A9;in vec4 Aa;in vec4 Ab;in vec3 Ac;uniform vec2 Ur;uniform float Us;uniform float Ut;out vec2 v_uv;out vec3 v_glyphIndex;out vec4 v_glyphColor;out vec4 v_cellColor;out vec4 v_glyphFlags;out vec3 v_worldPosition;out vec3 v_normal;out float v_geometryType;const float A=6.28318530718f;const int B=2;const int C=3;const int D=4;vec2 E(float F,vec2 G,vec2 H,vec2 I,vec2 J){float K=1.0f-F;float L=K*K;float M=L*K;float N=F*F;float O=N*F;return M*G+3.0f*L*F*H+3.0f*K*N*I+O*J;}vec2 P(float F,vec2 G,vec2 H,vec2 I,vec2 J){float K=1.0f-F;float L=K*K;float N=F*F;return-3.0f*L*G+3.0f*(L-2.0f*K*F)*H+3.0f*(2.0f*K*F-N)*I+3.0f*N*J;}vec3 Q(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x,R.y*T-R.z*U,R.y*U+R.z*T);}vec3 V(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x*T+R.z*U,R.y,-R.x*U+R.z*T);}vec3 W(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x*T-R.y*U,R.x*U+R.y*T,R.z);}vec3 X(vec3 R,vec3 Y){vec3 Z=R;if(Y.z!=0.0f){Z=W(Z,Y.z);}if(Y.y!=0.0f){Z=V(Z,Y.y);}if(Y.x!=0.0f){Z=Q(Z,Y.x);}return Z;}void main(){v_uv=A1;v_glyphIndex=A4;v_glyphColor=A5;v_cellColor=A6;v_glyphFlags=A7;vec4 a=Aa;vec4 b=Ab;vec2 c=A3;vec2 d=A2;float e=Ac.x;float f=Ac.y;int g=int(Ac.z);vec2 h=d;vec2 i=h+c*0.5f;float j=f+e*0.5f;vec3 k=vec3(i,j);vec3 l;if(g==D){float F=clamp(A0.x,0.0f,1.0f);vec2 G=b.xy;vec2 H=a.xy;vec2 I=a.zw;vec2 J=b.zw;vec2 m=E(F,G,H,I,J);vec2 n=P(F,G,H,I,J);float o=length(n);vec2 p=o>0.0f?n/o:vec2(1.0f,0.0f);vec2 q=vec2(-p.y,p.x);vec2 r=m;vec2 s=r+q*A0.y*c.y;l=vec3(s,f);}else if(g==C){float t=mod(a.x,A);if(t<0.0f){t+=A;}float u=mod(a.y,A);if(u<0.0f){u+=A;}float v=t-u;if(v<=0.0f){v+=A;}float S=t-A0.x*v;vec2 w=vec2(cos(S),sin(S))*A0.y;vec2 s=w*c+h;l=vec3(s,f);}else if(g==B){vec2 s=A0.xy*c+h;l=vec3(s,f);}vec3 x=X(l,A9);vec3 y=x+A8;vec3 z=vec3(0.0f,0.0f,1.0f);v_worldPosition=y;v_normal=z;v_geometryType=float(g);vec2 AA=(y.xy/Ur)*2.0f;AA.y=-AA.y;float AB=y.z/Ur.y;float AC=clamp(-AB*Us,-0.99f,0.99f);if(Ut>0.5f){gl_Position=vec4(AA,AC,1.0f);}else{float AD=0.5f;float AE=1.0f/(1.0f-AB*AD);AA*=AE;gl_Position=vec4(AA,AC,1.0f);}}`,j=class j{constructor(t,e,i=e,r=1,s={},n){a(this,"N");a(this,"G");a(this,"l");a(this,"A");a(this,"j");a(this,"X",[]);a(this,"Y",null);a(this,"K");a(this,"W");a(this,"Z",null);a(this,"q",new Map);this.N=e,this.G=i,this.A=t,this.K=X(r,1,8),this.W=n,this.l={filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte",depth:!0,...s},j.V||(j.V=new k(t,J,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D U0;uniform sampler2D U1;uniform sampler2D U2;uniform sampler2D U3;uniform vec2 U4;uniform bool U5;uniform bool U6;uniform bool U7;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;void main(){vec2 B=vec2(v_uv.x,1.-v_uv.y);vec2 C=B*U4;vec2 D=(floor(C)+0.5f)/U4;vec4 E=texture(U0,D);vec4 F=U5?texture(U1,D):vec4(0.);if(U5&&F.a==0.){discard;}vec4 G=U6?texture(U2,D):vec4(0.);vec4 H=U7?texture(U3,D):vec4(0.);o_character=E;o_primaryColor=F;o_secondaryColor=G;A=H;}`));const o=t.getParameter(t.MAX_DRAW_BUFFERS),c=t.getParameter(t.MAX_COLOR_ATTACHMENTS);this.K=Math.min(this.K,o,c),this.j=t.createFramebuffer(),this.J(),this.tt(),this.l.depth&&this.st()}J(){const t=this.A,e=this.l.filter==="linear"?t.LINEAR:t.NEAREST,i=this.l.wrap==="repeat"?t.REPEAT:t.CLAMP_TO_EDGE,r=this.l.type==="float"?t.FLOAT:t.UNSIGNED_BYTE,s=r===t.FLOAT?t.RGBA32F:t.RGBA8,n=t.RGBA;for(let o=0;o<this.K;o++){const c=t.createTexture();t.bindTexture(t.TEXTURE_2D,c),ut(t,e,e,i,i),t.texImage2D(t.TEXTURE_2D,0,s,this.N,this.G,0,n,r,null),this.X.push(c)}t.bindTexture(t.TEXTURE_2D,null)}tt(){const t=this.A;if(t.bindFramebuffer(t.FRAMEBUFFER,this.j),this.K===1)t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.X[0],0);else{const e=[];for(let i=0;i<this.K;i++){const r=t.COLOR_ATTACHMENT0+i;t.framebufferTexture2D(t.FRAMEBUFFER,r,t.TEXTURE_2D,this.X[i],0),e.push(r)}t.drawBuffers(e)}t.bindFramebuffer(t.FRAMEBUFFER,null)}st(){const t=this.A;this.Y=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.Y),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT24,this.N,this.G),t.bindFramebuffer(t.FRAMEBUFFER,this.j),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.Y),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}et(t){Tt(this.A,this.X[0],t)}resize(t,e){this.N=t,this.G=e,this.q.clear();const i=this.A,r=this.l.type==="float"?i.FLOAT:i.UNSIGNED_BYTE,s=r===i.FLOAT?i.RGBA32F:i.RGBA8,n=i.RGBA;for(const o of this.X)i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,s,this.N,this.G,0,n,r,null);i.bindTexture(i.TEXTURE_2D,null),this.Y&&(i.bindRenderbuffer(i.RENDERBUFFER,this.Y),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT24,this.N,this.G),i.bindRenderbuffer(i.RENDERBUFFER,null))}readPixels(t){const e=this.q.get(t);if(e)return e;const i=this.A,r=this.N,s=this.G,n=new Uint8Array(r*s*4),o=i.getParameter(i.READ_FRAMEBUFFER_BINDING);i.bindFramebuffer(i.READ_FRAMEBUFFER,this.j),i.readBuffer(i.COLOR_ATTACHMENT0+t),i.readPixels(0,0,r,s,i.RGBA,i.UNSIGNED_BYTE,n),i.bindFramebuffer(i.READ_FRAMEBUFFER,o);const c=4*r,l=new Uint8Array(n.length);for(let u=0;u<s;u++){const f=(s-1-u)*c,d=u*c;l.set(n.subarray(f,f+c),d)}return this.q.set(t,l),l}begin(){const t=this.A;this.q.clear(),this.W.it(),this.W.rt(this.j,this.N,this.G,this.K),this.l.depth&&t.clear(t.DEPTH_BUFFER_BIT),this.W.state.nt()}end(){this.W.state.ot(),this.W.ht(),this.W.ct()}lt(){return this.Z||this.ut(),this.Z}ut(){if(!this.W)return;const t=this.K>1,e=this.K>2,i=this.K>3,r={U0:this.X[0],U1:t?this.X[1]:this.X[0],U2:e?this.X[2]:this.X[0],U3:i?this.X[3]:this.X[0],U4:[this.N,this.G],U5:t,U6:e,U7:i},s=j.V;this.Z=this.W.dt.ft(s,r,!0)}dispose(){const t=this.A;t.deleteFramebuffer(this.j),this.X.forEach(e=>{t.deleteTexture(e)}),this.Y&&t.deleteRenderbuffer(this.Y)}get width(){return this.N}get height(){return this.G}get textures(){return this.X}get attachmentCount(){return this.K}};a(j,"V",null);let D=j;const Rt=new WeakMap;function dt(h,t){Rt.set(h,t)}function Pt(h){return Rt.get(h)}function $(h,t,e,i,r=255){h[0]=t/255,h[1]=(e??t)/255,h[2]=(i??t)/255,h[3]=r/255}class tt{constructor(){a(this,"vt",1);a(this,"gt",0);a(this,"_t",0);a(this,"yt",0);a(this,"At",0);a(this,"wt",0);a(this,"bt",0);a(this,"Ct",[0,0,0]);a(this,"xt",[1,1,1,1]);a(this,"Mt",[0,0,0,1]);a(this,"$t",!1);a(this,"Ft",!1);a(this,"Pt",!1);a(this,"Tt",0);a(this,"St",[0,0,0,1]);a(this,"Rt",!1);a(this,"Et",[]);a(this,"kt",[])}static Lt(){return{zt:1,Dt:0,Ot:0,Ht:0,At:0,wt:0,bt:0,Tt:0,Bt:!1,It:!1,Pt:!1,Rt:!1,Nt:[0,0,0],Gt:[1,1,1,1],jt:[0,0,0,1]}}Qt(t){t.zt=this.vt,t.Dt=this.gt,t.Ot=this._t,t.Ht=this.yt,t.At=this.At,t.wt=this.wt,t.bt=this.bt,t.Bt=this.$t,t.It=this.Ft,t.Pt=this.Pt,t.Tt=this.Tt,t.Rt=this.Rt,t.Nt[0]=this.Ct[0],t.Nt[1]=this.Ct[1],t.Nt[2]=this.Ct[2],t.Gt[0]=this.xt[0],t.Gt[1]=this.xt[1],t.Gt[2]=this.xt[2],t.Gt[3]=this.xt[3],t.jt[0]=this.Mt[0],t.jt[1]=this.Mt[1],t.jt[2]=this.Mt[2],t.jt[3]=this.Mt[3]}Xt(t){this.vt=t.zt,this.gt=t.Dt,this._t=t.Ot,this.yt=t.Ht,this.At=t.At,this.wt=t.wt,this.bt=t.bt,this.$t=t.Bt,this.Ft=t.It,this.Pt=t.Pt,this.Tt=t.Tt,this.Rt=t.Rt,this.Ct[0]=t.Nt[0],this.Ct[1]=t.Nt[1],this.Ct[2]=t.Nt[2],this.xt[0]=t.Gt[0],this.xt[1]=t.Gt[1],this.xt[2]=t.Gt[2],this.xt[3]=t.Gt[3],this.Mt[0]=t.jt[0],this.Mt[1]=t.jt[1],this.Mt[2]=t.jt[2],this.Mt[3]=t.jt[3]}nt(){let t=this.kt.pop();t||(t=tt.Lt()),this.Qt(t),this.Et.push(t)}ot(){const t=this.Et.pop();t?(this.Xt(t),this.kt.push(t)):console.warn("pop() called without matching push()")}Yt(t){this.Qt(t)}Kt(t){this.vt=Math.abs(t)}Wt(){this.gt=0,this._t=0,this.yt=0,this.At=0,this.wt=0,this.bt=0,this.Rt=!1}Zt(t){t!==0&&(this.At+=t*Math.PI/180)}qt(t){t!==0&&(this.wt+=t*Math.PI/180)}Vt(t){t!==0&&(this.bt+=t*Math.PI/180)}Jt(t=0,e=0,i=0){t===0&&e===0&&i===0||(this.gt+=t,this._t+=e,this.yt+=i)}ts(t){this.Jt(t,0,0)}ss(t){this.Jt(0,t,0)}es(t){this.Jt(0,0,t)}rs(t){this.Ct[0]=t[0],this.Ct[1]=t[1],this.Ct[2]=t[2]}ns(t,e,i,r=255){$(this.xt,t,e,i,r)}hs(t,e,i,r=255){$(this.Mt,t,e,i,r)}cs(t){this.$t=t}ls(t){this.Ft=t}us(t){this.Pt=t}fs(t){this.Tt=bt(t)}ds(t,e,i,r){$(this.St,t,e,i,r)}ps(t){this.Rt=t}get canvasBackgroundColor(){return this.St}get useOrtho(){return this.Rt}get rotationX(){return this.At}get rotationY(){return this.wt}get rotationZ(){return this.bt}}const gt=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,-.5,.5,0,1,-.5,.5,0,1,.5,-.5,1,0,.5,.5,1,1]),z={vs:16,gs:WebGL2RenderingContext.TRIANGLES,_s:{As:{size:2,offset:0},ws:{size:2,offset:8}}};class ie{constructor(t){a(this,"A");a(this,"bs");a(this,"Cs");this.A=t,this.bs=t.createBuffer(),this.Cs=new Float32Array(gt.length)}Ms(t,e,i,r){const s=this.A,n=Pt(this.A),o=n[2],c=n[3],l=t/o*2-1,u=(t+i)/o*2-1,f=1-(e+r)/c*2,d=1-e/c*2,g=gt,p=this.Cs;for(let v=0;v<g.length;v+=4){const m=g[v],w=g[v+1],A=g[v+2],y=g[v+3],E=l+(m+.5)*(u-l),x=f+(w+.5)*(d-f);p[v]=E,p[v+1]=x,p[v+2]=A,p[v+3]=y}s.bindBuffer(s.ARRAY_BUFFER,this.bs),s.bufferData(s.ARRAY_BUFFER,p,s.DYNAMIC_DRAW),s.enableVertexAttribArray(0),s.vertexAttribPointer(0,2,s.FLOAT,!1,16,0),s.enableVertexAttribArray(1),s.vertexAttribPointer(1,2,s.FLOAT,!1,16,8),s.drawArrays(s.TRIANGLES,0,6),s.disableVertexAttribArray(1),s.disableVertexAttribArray(0),s.bindBuffer(s.ARRAY_BUFFER,null)}$s(){this.A.deleteBuffer(this.bs)}}var F=(h=>(h.RECTANGLE="rectangle",h.LINE="line",h.ELLIPSE="ellipse",h.ARC="arc",h.TRIANGLE="triangle",h.BEZIER_CURVE="bezier_curve",h))(F||{});const re={rectangle:2,line:2,ellipse:2,triangle:2,arc:3,bezier_curve:4};class se{constructor(t){a(this,"A");a(this,"Fs",new Map);this.A=t}Ps(t,e,i,r){const s=this.A;let n=this.Fs.get(t);n||(n=new Map,this.Fs.set(t,n));let o=n.get(e)||null;if(!o){o=s.createVertexArray(),n.set(e,o),s.bindVertexArray(o),s.bindBuffer(s.ARRAY_BUFFER,r);const c=s.getAttribLocation(t,"A0");c!==-1&&ft(s,c,i._s.As.size,i.vs,i._s.As.offset,0,s.FLOAT,!1);const l=s.getAttribLocation(t,"A1");l!==-1&&ft(s,l,i._s.ws.size,i.vs,i._s.ws.offset,0,s.FLOAT,!1)}s.bindVertexArray(o)}Ts(){this.A.bindVertexArray(null)}$s(){for(const[,t]of this.Fs)for(const[,e]of t)e&&this.A.deleteVertexArray(e)}}const L=class L{static Ss(t,e,i=0){const r=e||new Float32Array(L.FLOATS_PER_INSTANCE);let s=i;r[s++]=t.As[0],r[s++]=t.As[1],r[s++]=t.Rs[0],r[s++]=t.Rs[1],r[s++]=t.Nt[0],r[s++]=t.Nt[1],r[s++]=t.Nt[2],r[s++]=t.Gt[0],r[s++]=t.Gt[1],r[s++]=t.Gt[2],r[s++]=t.Gt[3],r[s++]=t.jt[0],r[s++]=t.jt[1],r[s++]=t.jt[2],r[s++]=t.jt[3],r[s++]=t.Es[0],r[s++]=t.Es[1],r[s++]=t.Es[2],r[s++]=t.Tt;const n=t.ks;r[s++]=(n==null?void 0:n[0])??0,r[s++]=(n==null?void 0:n[1])??0,r[s++]=(n==null?void 0:n[2])??0;const o=t.Ls;r[s++]=(o==null?void 0:o[0])??0,r[s++]=(o==null?void 0:o[1])??0,r[s++]=(o==null?void 0:o[2])??0;const c=t.zs,l=t.Ds,u=t.Os,f=t.Hs,d=t.Bs,g=!(!l||!u);return g?(r[s++]=(f==null?void 0:f[0])??0,r[s++]=(f==null?void 0:f[1])??0,r[s++]=(d==null?void 0:d[0])??0,r[s++]=(d==null?void 0:d[1])??0,r[s++]=l[0],r[s++]=l[1],r[s++]=u[0],r[s++]=u[1]):!g&&!!c?(r[s++]=c[0],r[s++]=c[1],r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0):(r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0),r[s++]=t.Is??0,r[s++]=t.Ns??0,r[s++]=t.Gs??0,r}static js(t,e){const i=t.length*L.FLOATS_PER_INSTANCE,r=e||new Float32Array(i);for(let s=0;s<t.length;s++){const n=s*L.FLOATS_PER_INSTANCE;L.Ss(t[s],r,n)}return r}};a(L,"BYTES_PER_INSTANCE",144),a(L,"FLOATS_PER_INSTANCE",36);let _=L;const I=class I{};a(I,"STRIDE",_.BYTES_PER_INSTANCE),a(I,"ATTRIBUTES",{A2:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:0,divisor:1},A3:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:8,divisor:1},A4:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:16,divisor:1},A5:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:28,divisor:1},A6:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:44,divisor:1},A7:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:60,divisor:1},A8:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:76,divisor:1},A9:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:88,divisor:1},Aa:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:100,divisor:1},Ab:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:116,divisor:1},Ac:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:I.STRIDE,offset:132,divisor:1}});let Q=I;class ne{constructor(t=1e3,e=1.5){a(this,"Qs");a(this,"Xs");a(this,"Ys");a(this,"Ks",0);a(this,"Ws",0);this.Xs=t,this.Ys=e;const i=t*_.FLOATS_PER_INSTANCE;this.Qs=new Float32Array(i)}Zs(t){if(t<=this.Xs)return;const e=Math.ceil(t*this.Ys),i=this.Xs;this.Xs=e;const r=e*_.FLOATS_PER_INSTANCE,s=new Float32Array(r),n=i*_.FLOATS_PER_INSTANCE;s.set(this.Qs.subarray(0,Math.min(n,this.Ks))),this.Qs=s}qs(){return{buffer:this.Qs,offset:this.Ks}}Vs(t){this.Ks+=t,this.Ws++}Js(){this.Ks=0,this.Ws=0}te(t=0,e){return this.Qs.subarray(t,e??this.Ks)}get se(){return this.Ws}get ee(){return this.Xs}get ie(){return this.Ks}get re(){return this.Ws===0}}class he{constructor(t){a(this,"Qs");this.Qs=t}ne(t){this.Qs.Zs(this.Qs.se+1);const{buffer:e,offset:i}=this.Qs.qs();e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.width,e[i+3]=t.height,e[i+4]=t.char0,e[i+5]=t.char1,e[i+6]=t.char2,e[i+7]=t.r1,e[i+8]=t.g1,e[i+9]=t.b1,e[i+10]=t.a1,e[i+11]=t.r2,e[i+12]=t.g2,e[i+13]=t.b2,e[i+14]=t.a2,e[i+15]=t.invert,e[i+16]=t.flipX,e[i+17]=t.flipY,e[i+18]=t.charRot,e[i+19]=t.translationX,e[i+20]=t.translationY,e[i+21]=t.translationZ,e[i+22]=t.rotationX,e[i+23]=t.rotationY,e[i+24]=t.rotationZ;const r=t.curveParams0,s=t.curveParams1;return e[i+25]=r[0],e[i+26]=r[1],e[i+27]=r[2],e[i+28]=r[3],e[i+29]=s[0],e[i+30]=s[1],e[i+31]=s[2],e[i+32]=s[3],e[i+33]=t.depth,e[i+34]=t.baseZ,e[i+35]=t.geometryType,this.Qs.Vs(_.FLOATS_PER_INSTANCE),this.Qs.se-1}get se(){return this.Qs.se}}class oe{constructor(t,e=1e3){a(this,"A");a(this,"oe",null);a(this,"he",0);a(this,"ae",new Map);this.A=t,this.ce(e)}ce(t){const e=this.A;this.oe&&e.deleteBuffer(this.oe),this.oe=e.createBuffer();const i=t*_.BYTES_PER_INSTANCE;xt(e,e.ARRAY_BUFFER,this.oe,i,e.DYNAMIC_DRAW),this.he=t}le(t){this.ce(t)}get ee(){return this.he}ue(t,e){if(e===0)return;const i=this.A;i.bindBuffer(i.ARRAY_BUFFER,this.oe);const r=e*_.FLOATS_PER_INSTANCE;i.bufferSubData(i.ARRAY_BUFFER,0,t,0,r)}fe(t){let e=this.ae.get(t);if(!e){e=new Map;const i=this.A;for(const r in Q.ATTRIBUTES){const s=i.getAttribLocation(t,r);s!==-1&&e.set(r,s)}this.ae.set(t,e)}return e}de(t){const e=this.A,i=t.program,r=this.fe(i);for(const[s,n]of r){const o=Q.ATTRIBUTES[s];o&&ft(e,n,o.size,o.stride,o.offset,o.divisor,o.type,o.normalized)}}pe(t){const e=this.A,i=this.fe(t.program);for(const[r,s]of i)Q.ATTRIBUTES[r]&&(e.disableVertexAttribArray(s),e.vertexAttribDivisor(s,0))}$s(){this.oe&&(this.A.deleteBuffer(this.oe),this.oe=null),this.ae.clear()}}class ae{constructor(t,e=1e3,i=1.5){a(this,"A");a(this,"Qs");a(this,"ve");a(this,"ge");this.A=t,this.Qs=new ne(e,i),this.ve=new he(this.Qs),this.ge=new oe(t,e)}me(t){var r,s,n,o,c,l,u,f,d,g;const e=[0,0,0,0],i=[0,0,0,0];return t.Ds&&t.Os?(e[0]=((r=t.Hs)==null?void 0:r[0])??0,e[1]=((s=t.Hs)==null?void 0:s[1])??0,e[2]=((n=t.Bs)==null?void 0:n[0])??0,e[3]=((o=t.Bs)==null?void 0:o[1])??0,i[0]=t.Ds[0],i[1]=t.Ds[1],i[2]=t.Os[0],i[3]=t.Os[1]):t.zs&&(e[0]=t.zs[0],e[1]=t.zs[1]),this.ne({x:t.As[0],y:t.As[1],width:t.Rs[0],height:t.Rs[1],char0:t.Nt[0],char1:t.Nt[1],char2:t.Nt[2],r1:t.Gt[0],g1:t.Gt[1],b1:t.Gt[2],a1:t.Gt[3],r2:t.jt[0],g2:t.jt[1],b2:t.jt[2],a2:t.jt[3],invert:t.Es[0],flipX:t.Es[1],flipY:t.Es[2],charRot:t.Tt,translationX:((c=t.ks)==null?void 0:c[0])??0,translationY:((l=t.ks)==null?void 0:l[1])??0,translationZ:((u=t.ks)==null?void 0:u[2])??0,rotationX:((f=t.Ls)==null?void 0:f[0])??0,rotationY:((d=t.Ls)==null?void 0:d[1])??0,rotationZ:((g=t.Ls)==null?void 0:g[2])??0,curveParams0:e,curveParams1:i,depth:t.Is||0,baseZ:t.Ns||0,geometryType:t.Gs||0})}ne(t){const e=this.ve.ne(t);return this.Qs.ee>this.ge.ee&&this.ge.le(this.Qs.ee),e}get _e(){return this.Qs.se}get re(){return this.Qs.re}ye(){this.Qs.Js()}de(t){const e=this.Qs.se;if(e===0)return;const i=this.Qs.te();this.ge.ue(i,e),this.ge.de(t)}pe(t){this.ge.pe(t)}Ms(t,e){const i=this.Qs.se;i!==0&&this.A.drawArraysInstanced(t,0,e,i)}$s(){this.ge.$s()}}class Y{constructor(t,e,i,r){a(this,"A");a(this,"Ae");a(this,"we");a(this,"be");a(this,"Ce",null);this.A=t,this.Ae=e,this.we=i,this.be=r;const s=this.A.createBuffer();xt(this.A,this.A.ARRAY_BUFFER,s,this.be.xe,this.A.STATIC_DRAW),this.Ce=s}get type(){return this.we}get unitGeometry(){return this.be}get unitBuffer(){return this.Ce}get batch(){return this.Ae}Me(){this.Ae.ye()}$e(){return!this.Ae.re}$s(){this.Ae.$s(),this.A.deleteBuffer(this.Ce)}Fe(t,e,i){return this.Ae.me(t)}Pe(t,e,i,r,s,n){const o=s.Dt??0,c=s.Ot??0,l=s.Ht??0,u=s.At??0,f=s.wt??0,d=s.bt??0,g=[0,0,0,0],p=[0,0,0,0];n&&(n.bezStartX!==void 0&&n.bezStartY!==void 0&&n.bezEndX!==void 0&&n.bezEndY!==void 0?(g[0]=n.cp1x??0,g[1]=n.cp1y??0,g[2]=n.cp2x??0,g[3]=n.cp2y??0,p[0]=n.bezStartX??0,p[1]=n.bezStartY??0,p[2]=n.bezEndX??0,p[3]=n.bezEndY??0):n.arcStart===void 0&&n.arcStop===void 0||(g[0]=n.arcStart??0,g[1]=n.arcStop??0));const v={x:t,y:e,width:i,height:r,char0:s.Nt[0],char1:s.Nt[1],char2:s.Nt[2],r1:s.Gt[0],g1:s.Gt[1],b1:s.Gt[2],a1:s.Gt[3],r2:s.jt[0],g2:s.jt[1],b2:s.jt[2],a2:s.jt[3],invert:s.Pt?1:0,flipX:s.Bt?1:0,flipY:s.It?1:0,charRot:s.Tt,translationX:o,translationY:c,translationZ:l,rotationX:u,rotationY:f,rotationZ:d,curveParams0:g,curveParams1:p,depth:(n==null?void 0:n.depth)??0,baseZ:(n==null?void 0:n.baseZ)??0,geometryType:re[this.we]??0};return this.Ae.ne(v)}}const ce={xe:gt,Te:6,...z},le={xe:new Float32Array([0,-.5,0,0,1,-.5,1,0,0,.5,0,1,0,.5,0,1,1,-.5,1,0,1,.5,1,1]),Te:6,...z},ue={xe:function(h=32){const t=[],e=2*Math.PI/h;for(let i=0;i<h;i++){const r=i*e,s=(i+1)%h*e,n=Math.cos(r),o=Math.sin(r),c=.5*(n+1),l=.5*(o+1),u=Math.cos(s),f=Math.sin(s),d=.5*(u+1),g=.5*(f+1);t.push(0,0,.5,.5,n,o,c,l,u,f,d,g)}return new Float32Array(t)}(32),Te:96,...z};let fe={xe:function(h){const t=[];for(let e=0;e<h;e++){const i=e/h,r=(e+1)/h;t.push(i,0,i,0,i,1,i,1,r,1,r,1)}return new Float32Array(t)}(32),Te:96,...z};const de={xe:new Float32Array([0,0,0,0,1,0,1,0,.5,1,.5,1]),Te:3,...z},ge={xe:function(h=16){const t=[];for(let e=0;e<h;e++){const i=e/h,r=(e+1)/h;t.push(i,-.5,i,0,r,-.5,r,0,i,.5,i,1,i,.5,i,1,r,-.5,r,0,r,.5,r,1)}return new Float32Array(t)}(16),Te:96,...z},pe={[F.RECTANGLE]:class extends Y{constructor(h,t){super(h,t,F.RECTANGLE,ce)}me(h,t){return this.Pe(0,0,h.width,h.height,t)}},[F.LINE]:class extends Y{constructor(h,t){super(h,t,F.LINE,le)}me(h,t){const e=h.x2-h.x1,i=h.y2-h.y1,r=Math.hypot(e,i),s=Math.atan2(i,e),n=t.zt||1,o=h.x1+e/2-r/2,c=h.y1+i/2,l={...t,bt:(t.bt||0)+s};return this.Pe(o,c,r,n,l)}},[F.ELLIPSE]:class extends Y{constructor(h,t){super(h,t,F.ELLIPSE,ue)}me(h,t){return this.Pe(0,0,h.width,h.height,t)}},[F.ARC]:class extends Y{constructor(h,t){super(h,t,F.ARC,fe)}me(h,t){const e=h.start*Math.PI/180,i=h.stop*Math.PI/180;return this.Pe(0,0,h.width,h.height,t,{arcStart:e,arcStop:i})}},[F.TRIANGLE]:class extends Y{constructor(h,t){super(h,t,F.TRIANGLE,de)}me(h,t){const e=Math.min(h.x1,h.x2,h.x3),i=Math.max(h.x1,h.x2,h.x3),r=Math.min(h.y1,h.y2,h.y3),s=i-e,n=Math.max(h.y1,h.y2,h.y3)-r;return this.Pe(e,r,s,n,t)}},[F.BEZIER_CURVE]:class extends Y{constructor(h,t){super(h,t,F.BEZIER_CURVE,ge)}me(h,t){return this.Pe(0,0,1,t.zt||1,t,{cp1x:h.cp1x,cp1y:h.cp1y,cp2x:h.cp2x,cp2y:h.cp2y,bezStartX:h.x1,bezStartY:h.y1,bezEndX:h.x2,bezEndY:h.y2})}}};class me{constructor(t){a(this,"A");a(this,"Se");a(this,"Re");this.A=t,this.Re=new se(t),this.Se=new Map;for(const e of Object.values(F)){const i=new ae(t),r=new pe[e](t,i);this.Se.set(e,r)}}Ee(t){this.ke(t).forEach(e=>{this.Le(e)})}ke(t){const e=[];let i=null,r=null,s=null;for(const n of t)r!==n.material||s!==n.type?(i&&i.length>0&&e.push({material:r,type:s,commands:i}),i=[n],r=n.material,s=n.type):i.push(n);return i&&i.length>0&&e.push({material:r,type:s,commands:i}),e}Le(t){const{material:e,type:i,commands:r}=t,s=this.Se.get(i);e.shader.L(),e.shader.O(e.uniforms);const n=Pt(this.A),o=r.length>0&&r[0].state.Rt;if(e.shader.O({Uu:n[2]/n[3],Ur:[n[2],n[3]],Us:1,Ut:o?1:0}),s.Me(),r.forEach(c=>{s.me(c.params,c.state)}),s.$e()){const c=s.unitGeometry,l=s.unitBuffer;try{this.Re.Ps(e.shader.program,String(i),c,l),s.batch.de(e.shader),s.batch.Ms(c.gs,c.Te)}finally{s.batch.pe(e.shader),this.Re.Ts(),s.Me()}}}$s(){for(const t of this.Se.values())t.$s();this.Se.clear(),this.Re.$s()}}function Ft(h){let t=0;for(let e=0;e<h.length;e++)t=(t<<5)-t+h.charCodeAt(e),t&=t;return t}const Ct=new WeakMap;let ve=1;function Mt(h){if(h==null)return 0;if(typeof h!="object"&&typeof h!="function")return Ft(String(h));let t=Ct.get(h);return t||(t=ve++,Ct.set(h,t)),t}function Z(h,t){return(h<<5)-h+t}class Ae{constructor(t){a(this,"ze",0);a(this,"De");a(this,"Oe");a(this,"He",new Map);this.De=new k(t,J,`#version 300 es
precision highp float;in vec3 v_glyphIndex;in vec4 v_glyphColor;in vec4 v_cellColor;in vec4 v_glyphFlags;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;void main(){int B=int(v_glyphFlags.r>0.5?1:0);int C=int(v_glyphFlags.g>0.5?1:0);int D=int(v_glyphFlags.b>0.5?1:0);float E=float(B|(C<<1)|(D<<2))/255.;o_character=vec4(v_glyphIndex.xy,E,clamp(v_glyphFlags.a,0.,1.));o_primaryColor=vec4(v_glyphColor.rgb,v_glyphColor.a);o_secondaryColor=vec4(v_cellColor.rgb,v_cellColor.a);A=vec4(0.);}`),this.Oe={id:this.ze++,shader:this.De,uniforms:Object.freeze({}),hash:this.Be(this.De,{}),isBuiltIn:!0}}get Ie(){return this.Oe}ft(t,e={},i=!1){const r=this.Be(t,e),s=this.He.get(r);if(s)return s;const n={id:this.ze++,shader:t,uniforms:Object.freeze({...e}),hash:r,isBuiltIn:i};return this.He.set(r,n),n}Ne(t,e={}){return{id:this.ze++,shader:t,uniforms:Object.freeze({...e}),hash:0,isBuiltIn:!1}}Be(t,e){const i=Mt(t.program),r=function(s,n){let o=0;const c=Object.keys(s).sort();for(const l of c)o=Z(o,Ft(l)),o=Z(o,n(s[l]));return o}(e,this.Ge.bind(this));return Z(i,r)}Ge(t){return typeof t=="number"||typeof t=="boolean"?function(e){return typeof e=="boolean"?e?1:0:Math.floor(e)}(t):Array.isArray(t)?function(e){let i=0;const r=Array.isArray(e[0])?e.flat():e;for(const s of r)i=Z(i,typeof s=="number"?s:0);return i}(t):t instanceof Float32Array||t instanceof Int32Array?function(e){let i=0;const r=Math.min(e.length,16);for(let s=0;s<r;s++)i=Z(i,e[s]);return i}(t):t instanceof WebGLTexture?Mt(t):0}$s(){this.De!=this.De&&this.De.dispose(),this.De.dispose(),this.He.clear()}}class ye{constructor(){a(this,"je",[]);a(this,"Qe",1);a(this,"Rs",0)}Xe(t,e){if(this.Rs>=this.je.length){const r={id:this.Qe++,type:t,params:{},state:tt.Lt(),material:e};this.je.push(r)}const i=this.je[this.Rs];return i.id=this.Qe++,i.type=t,i.material=e,this.Rs++,i}Ye(t,e,i){const r=this.Xe(F.RECTANGLE,i),s=r.params;return s.width=t.width,s.height=t.height,e.Yt(r.state),r.id}Ke(t,e,i){const r=this.Xe(F.LINE,i),s=r.params;return s.x1=t.x1,s.y1=t.y1,s.x2=t.x2,s.y2=t.y2,s.thickness=t.thickness,e.Yt(r.state),r.id}We(t,e,i){const r=this.Xe(F.ELLIPSE,i),s=r.params;return s.width=t.width,s.height=t.height,s.startAngle=t.startAngle,s.endAngle=t.endAngle,s.segments=t.segments,e.Yt(r.state),r.id}Ze(t,e,i){const r=this.Xe(F.ARC,i),s=r.params;return s.width=t.width,s.height=t.height,s.start=t.start,s.stop=t.stop,e.Yt(r.state),r.id}qe(t,e,i){const r=this.Xe(F.TRIANGLE,i),s=r.params;return s.x1=t.x1,s.y1=t.y1,s.x2=t.x2,s.y2=t.y2,s.x3=t.x3,s.y3=t.y3,e.Yt(r.state),r.id}Ve(t,e,i){const r=this.Xe(F.BEZIER_CURVE,i),s=r.params;return s.x1=t.x1,s.y1=t.y1,s.cp1x=t.cp1x,s.cp1y=t.cp1y,s.cp2x=t.cp2x,s.cp2y=t.cp2y,s.x2=t.x2,s.y2=t.y2,s.thickness=t.thickness,s.segments=t.segments,e.Yt(r.state),r.id}ye(){this.Rs=0}[Symbol.iterator](){let t=0;const e=this.Rs,i=this.je;return{next:()=>t<e?{value:i[t++],done:!1}:{value:void 0,done:!0}}}}class we{constructor(t){a(this,"A");a(this,"Je",null);a(this,"ti");a(this,"dt");a(this,"si");a(this,"ei");a(this,"ii");a(this,"ri",null);a(this,"ni",{});a(this,"oi",[]);a(this,"hi",[]);a(this,"ai",[]);a(this,"ci",null);a(this,"li",[0,0,0,0]);a(this,"ui",1);this.A=t,t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clearDepth(1),t.depthMask(!0),t.disable(t.CULL_FACE),this.si=new tt,this.dt=new Ae(t),this.ei=new ye,this.ti=new me(t),this.ii=new ie(t);const e=[0,0,t.canvas.width,t.canvas.height];dt(t,e),this.oi.push(null),this.hi.push(e),this.ai.push(1),this.ci=null,this.li=e,this.ui=1}it(){this.oi.push(this.ci),this.hi.push([...this.li]),this.ai.push(this.ui)}ct(){const t=this.oi.pop()??null,e=this.hi.pop()??[0,0,this.A.canvas.width,this.A.canvas.height],i=this.ai.pop()??1;this.rt(t,e[2],e[3],i)}rt(t,e,i,r=1){const s=this.A;this.ci!==t&&(s.bindFramebuffer(s.FRAMEBUFFER,t),this.ci=t),this.ui=r;const n=[0,0,e,i];this.li[0]===n[0]&&this.li[1]===n[1]&&this.li[2]===n[2]&&this.li[3]===n[3]||(s.viewport(...n),dt(s,n),this.li=n)}fi(t){this.Je!==t&&(this.Je=t,t.L())}di(t,e){return new k(this.A,t,e)}pi(t){this.ri=t,t&&(this.ni={})}H(t,e){this.ni[t]=e}gi(t){Object.assign(this.ni,t)}mi(t){return new k(this.A,J,t)}_i(t,e,i,r){t instanceof D||!r||t.yi(r),this.ei.Ye({width:e??t.width,height:i??t.height},this.si,t.lt())}Ai(t,e,i,r){this.ii.Ms(t,e,i,r)}wi(t,e){if(this.ri){const i=this.dt.Ne(this.ri,this.ni);this.ei.Ye({width:t,height:e},this.si,i),this.ri=null,this.ni={}}else this.ei.Ye({width:t,height:e},this.si,this.dt.Ie)}bi(t,e,i,r){this.ei.Ke({x1:t,y1:e,x2:i,y2:r},this.si,this.dt.Ie)}Ci(t,e){this.ei.We({width:t,height:e},this.si,this.dt.Ie)}xi(t,e,i,r,s,n){this.ei.qe({x1:t,y1:e,x2:i,y2:r,x3:s,y3:n},this.si,this.dt.Ie)}Mi(t,e,i,r,s,n,o,c){this.ei.Ve({x1:t,y1:e,cp1x:i,cp1y:r,cp2x:s,cp2y:n,x2:o,y2:c},this.si,this.dt.Ie)}$i(t,e,i,r){this.ei.Ze({width:t,height:e,start:i,stop:r},this.si,this.dt.Ie)}Fi(t,e,i=1,r={}){return new D(this.A,t,e,i,r,this)}Pi(t,e=t,i=t,r=255){this.si.ds(t,e??t,i??t,r);const[s,n,o,c]=this.si.canvasBackgroundColor;this.Ti(s,n,o,c,!1)}ye(t=0,e=0,i=0,r=0){this.Ti(t,e,i,r,!0)}Ti(t,e,i,r,s){const n=this.A;if(this.ui>1){const o=s?[1,1,0,0]:[0,0,0,0];n.clearBufferfv(n.COLOR,0,new Float32Array(o)),n.clearBufferfv(n.COLOR,1,new Float32Array([0,0,0,0])),this.ui>=3&&n.clearBufferfv(n.COLOR,2,new Float32Array([t,e,i,r]));for(let c=3;c<this.ui;c++)n.clearBufferfv(n.COLOR,c,new Float32Array([0,0,0,0]))}else n.clearColor(t,e,i,r),n.clear(n.COLOR_BUFFER_BIT)}Si(){const t=[0,0,this.A.canvas.width,this.A.canvas.height];this.A.viewport(...t),dt(this.A,t),this.li=t,this.hi.length>0&&(this.hi[0]=t)}ht(){const t=this.ei;this.ti.Ee(t),t.ye(),this.Je=null}$s(){this.dt.$s(),this.ti.$s(),this.ii.$s()}get context(){return this.A}get state(){return this.si}get materialManager(){return this.dt}}const C={readShort:(h,t)=>(C.t.uint16[0]=h[t]<<8|h[t+1],C.t.int16[0]),readUshort:(h,t)=>h[t]<<8|h[t+1],readUshorts(h,t,e){const i=[];for(let r=0;r<e;r++)i.push(C.readUshort(h,t+2*r));return i},readUint(h,t){const e=C.t.uint8;return e[3]=h[t],e[2]=h[t+1],e[1]=h[t+2],e[0]=h[t+3],C.t.uint32[0]},readASCII(h,t,e){let i="";for(let r=0;r<e;r++)i+=String.fromCharCode(h[t+r]);return i},t:(()=>{const h=new ArrayBuffer(8);return{uint8:new Uint8Array(h),int16:new Int16Array(h),uint16:new Uint16Array(h),uint32:new Uint32Array(h)}})()};function et(h){return h+3&-4}function it(h,t,e){h[t]=e>>>8&255,h[t+1]=255&e}function O(h,t,e){h[t]=e>>>24&255,h[t+1]=e>>>16&255,h[t+2]=e>>>8&255,h[t+3]=255&e}function Ee(h,t,e){for(let i=0;i<e.length;i++)h[t+i]=255&e.charCodeAt(i)}function pt(h,t,e){const i=t+e;let r=0;const s=C.t;for(let n=t;n<i;n+=4)s.uint8[3]=h[n]||0,s.uint8[2]=h[n+1]||0,s.uint8[1]=h[n+2]||0,s.uint8[0]=h[n+3]||0,r=r+(s.uint32[0]>>>0)>>>0;return r>>>0}class be{constructor(t){a(this,"b");a(this,"p",0);a(this,"bitbuf",0);a(this,"bitcnt",0);this.b=t}readBits(t){for(;this.bitcnt<t;){const i=this.b[this.p++]||0;this.bitbuf|=i<<this.bitcnt,this.bitcnt+=8}const e=this.bitbuf&(1<<t)-1;return this.bitbuf>>>=t,this.bitcnt-=t,e}alignToByte(){this.bitbuf=0,this.bitcnt=0}get offset(){return this.p}}function V(h){let t=32,e=0;for(const o of h)o&&(o<t&&(t=o),o>e&&(e=o));if(e===0)return{min:0,max:0,table:new Map};const i=new Uint32Array(e+1);for(const o of h)o&&i[o]++;const r=new Uint32Array(e+1);let s=0;i[0]=0;for(let o=1;o<=e;o++)s=s+i[o-1]<<1,r[o]=s;const n=new Map;for(let o=0;o<h.length;o++){const c=h[o];if(!c)continue;const l=r[c]++;let u=n.get(c);u||(u=[],n.set(c,u)),u[Te(l,c)]=o}return{min:t,max:e,table:n}}function mt(h,t){let e=0;for(let i=1;i<=t.max;i++){e|=h.readBits(1)<<i-1;const r=t.table.get(i);if(r&&e<r.length){const s=r[e];if(s!==void 0)return s}}throw new Error("Invalid Huffman code")}function Te(h,t){let e=0;for(let i=0;i<t;i++)e=e<<1|1&h,h>>>=1;return e>>>0}function xe(h){if(h.length<2)throw new Error("ZLIB data too short");const t=h[0],e=h[1];if((15&t)!=8)throw new Error("Unsupported ZLIB compression method");if(((t<<8)+e)%31!=0)throw new Error("Bad ZLIB header check");let i=2;32&e&&(i+=4);const r=[];return function(s,n){const o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],c=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],u=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];let f=0;for(;!f;){f=s.readBits(1);const d=s.readBits(2);if(d===0){s.alignToByte();const g=s.readBits(16);if((65535&(65535^g))!==s.readBits(16))throw new Error("DEFLATE uncompressed LEN/NLEN mismatch");for(let p=0;p<g;p++)n.push(s.readBits(8))}else{if(d!==1&&d!==2)throw new Error("Unsupported DEFLATE type");{let g,p;if(d===1){const v=new Array(288).fill(0);for(let m=0;m<=143;m++)v[m]=8;for(let m=144;m<=255;m++)v[m]=9;for(let m=256;m<=279;m++)v[m]=7;for(let m=280;m<=287;m++)v[m]=8;g=V(v),p=V(new Array(32).fill(5))}else{const v=s.readBits(5)+257,m=s.readBits(5)+1,w=s.readBits(4)+4,A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],y=new Array(19).fill(0);for(let P=0;P<w;P++)y[A[P]]=s.readBits(3);const E=V(y),x=[];for(;x.length<v+m;){const P=mt(s,E);if(P<=15)x.push(P);else if(P===16){const U=s.readBits(2)+3,S=x[x.length-1]||0;for(let at=0;at<U;at++)x.push(S)}else if(P===17){const U=s.readBits(3)+3;for(let S=0;S<U;S++)x.push(0)}else{if(P!==18)throw new Error("Invalid code length symbol");{const U=s.readBits(7)+11;for(let S=0;S<U;S++)x.push(0)}}}const R=x.slice(0,v),M=x.slice(v,v+m);g=V(R),p=V(M)}for(;;){const v=mt(s,g);if(v<256)n.push(v);else{if(v===256)break;if(v>256&&v<286){const m=v-257;let w=o[m];const A=c[m];A&&(w+=s.readBits(A));const y=mt(s,p);if(y>=30)throw new Error("Invalid distance symbol");let E=l[y];const x=u[y];x&&(E+=s.readBits(x));const R=n.length-E;if(R<0)throw new Error("Invalid distance");for(let M=0;M<w;M++)n.push(n[R+M]||0)}else if(v===286||v===287)throw new Error("Reserved length symbol")}}}}}}(new be(h.subarray(i)),r),new Uint8Array(r)}function Re(h){const t=C,e=new Uint8Array(h);if(t.readASCII(e,0,4)!=="wOFF")throw new Error("Invalid WOFF signature");const i=t.readUint(e,4),r=t.readUshort(e,12),s=t.readUint(e,16),n=[];let o=44;for(let A=0;A<r;A++){const y=t.readASCII(e,o,4),E=t.readUint(e,o+4),x=t.readUint(e,o+8),R=t.readUint(e,o+12),M=t.readUint(e,o+16);n.push({tag:y,offset:E,compLength:x,origLength:R,checksum:M}),o+=20}for(const A of n){const y=new Uint8Array(e.buffer,A.offset,A.compLength);if(A.compLength===A.origLength)A.data=new Uint8Array(y);else if(A.data=xe(y),A.data.length!==A.origLength)if(A.data.length<A.origLength){const E=new Uint8Array(A.origLength);E.set(A.data),A.data=E}else A.data=A.data.subarray(0,A.origLength)}const c=r;let l=1,u=0;for(;l<<1<=c;)l<<=1,u++;const f=16*l,d=16*c-f;let g=12+16*c;const p={};for(const A of n)p[A.tag]=g,g=et(g+A.data.length);const v=Math.max(s||0,g),m=new Uint8Array(v);O(m,0,i),it(m,4,c),it(m,6,f),it(m,8,u),it(m,10,d);let w=12;for(const A of n){Ee(m,w,A.tag),w+=4;let y=A.data;if(A.tag==="head"&&y.length>=12){const E=new Uint8Array(y);O(E,8,0),O(m,w,pt(E,0,et(E.length))),w+=4}else O(m,w,pt(y,0,et(y.length))),w+=4;O(m,w,p[A.tag]),w+=4,O(m,w,A.data.length),w+=4}for(const A of n){const y=p[A.tag];m.set(A.data,y)}if(n.find(A=>A.tag==="head")){const A=p.head,y=function(E,x){const R=x+8,M=[E[R],E[R+1],E[R+2],E[R+3]];O(E,R,0);const P=2981146554-(pt(E,0,et(E.length))>>>0)>>>0;return E[R]=M[0],E[R+1]=M[1],E[R+2]=M[2],E[R+3]=M[3],P>>>0}(m,A);O(m,A+8,y)}return m.buffer}const Pe={parseTab(h,t,e){const i={tables:[],ids:{},off:t};h=new Uint8Array(h.buffer,t,e),t=0;const r=C,s=r.readUshort;s(h,t);const n=s(h,t+=2);t+=2;const o=[];for(let c=0;c<n;c++){const l=s(h,t),u=s(h,t+=2);t+=2;const f=r.readUint(h,t);t+=4;const d=`p${l}e${u}`;let g=o.indexOf(f);if(g===-1){let p;g=i.tables.length,o.push(f);const v=s(h,f);p=v===4?this.parse4(h,f):v===12?this.parse12(h,f):{format:v},i.tables.push(p)}i.ids[d]=g}return i},parse4(h,t){const e=C,i=e.readUshort,r=e.readUshorts,s=t,n=i(h,t+=2);i(h,t+=2);const o=i(h,t+=2)>>>1,c={format:4,searchRange:i(h,t+=2),entrySelector:0,rangeShift:0,endCount:[],startCount:[],idDelta:[],idRangeOffset:[],glyphIdArray:[]};t+=2,c.entrySelector=i(h,t),t+=2,c.rangeShift=i(h,t),t+=2,c.endCount=r(h,t,o),t+=2*o,t+=2,c.startCount=r(h,t,o),t+=2*o;for(let l=0;l<o;l++)c.idDelta.push(e.readShort(h,t)),t+=2;return c.idRangeOffset=r(h,t,o),t+=2*o,c.glyphIdArray=r(h,t,s+n-t>>1),c},parse12(h,t){const e=C.readUint;e(h,t+=4),e(h,t+=4);const i=e(h,t+=4);t+=4;const r=new Uint32Array(3*i);for(let s=0;s<3*i;s+=3)r[s]=e(h,t+(s<<2)),r[s+1]=e(h,t+(s<<2)+4),r[s+2]=e(h,t+(s<<2)+8);return{format:12,groups:r}}},Fe={parseTab(h,t,e){const i=C;t+=18;const r=i.readUshort(h,t);t+=2,t+=16;const s=i.readShort(h,t);t+=2;const n=i.readShort(h,t);t+=2;const o=i.readShort(h,t);t+=2;const c=i.readShort(h,t);return t+=2,t+=6,{unitsPerEm:r,xMin:s,yMin:n,xMax:o,yMax:c,indexToLocFormat:i.readShort(h,t)}}},Ce={parseTab(h,t,e){const i=C;t+=4;const r=["ascender","descender","lineGap","advanceWidthMax","minLeftSideBearing","minRightSideBearing","xMaxExtent","caretSlopeRise","caretSlopeRun","caretOffset","res0","res1","res2","res3","metricDataFormat","numberOfHMetrics"],s={};for(let n=0;n<r.length;n++){const o=r[n],c=o==="advanceWidthMax"||o==="numberOfHMetrics"?i.readUshort:i.readShort;s[o]=c(h,t+2*n)}return s}},Me={parseTab(h,t,e,i){const r=C,s=[],n=[],o=i.maxp.numGlyphs,c=i.hhea.numberOfHMetrics;let l=0,u=0,f=0;for(;f<c;)l=r.readUshort(h,t+(f<<2)),u=r.readShort(h,t+(f<<2)+2),s.push(l),n.push(u),f++;for(;f<o;)s.push(l),n.push(u),f++;return{aWidth:s,lsBearing:n}}},Nt={cmap:Pe,head:Fe,hhea:Ce,maxp:{parseTab(h,t,e){const i=C;return i.readUint(h,t),t+=4,{numGlyphs:i.readUshort(h,t)}}},hmtx:Me,loca:{parseTab(h,t,e,i){const r=C,s=[],n=i.head.indexToLocFormat,o=i.maxp.numGlyphs+1;if(n===0)for(let c=0;c<o;c++)s.push(r.readUshort(h,t+(c<<1))<<1);else if(n===1)for(let c=0;c<o;c++)s.push(r.readUint(h,t+(c<<2)));return s}},glyf:{parseTab(h,t,e,i){const r=[],s=i.maxp.numGlyphs;for(let n=0;n<s;n++)r.push(null);return r},Ri(h,t){const e=C,i=h.Ei,r=h.loca;if(r[t]===r[t+1])return null;const s=K.findTable(i,"glyf",h.ki);if(!s)return null;let n=s[0]+r[t];const o={};if(o.noc=e.readShort(i,n),n+=2,o.xMin=e.readShort(i,n),n+=2,o.yMin=e.readShort(i,n),n+=2,o.xMax=e.readShort(i,n),n+=2,o.yMax=e.readShort(i,n),n+=2,o.xMin>=o.xMax||o.yMin>=o.yMax)return null;if(o.noc>0){o.endPts=[];for(let d=0;d<o.noc;d++)o.endPts.push(e.readUshort(i,n)),n+=2;const c=e.readUshort(i,n);if(n+=2,i.length-n<c)return null;n+=c;const l=o.endPts[o.noc-1]+1;o.flags=[];for(let d=0;d<l;d++){const g=i[n];if(n++,o.flags.push(g),8&g){const p=i[n];n++;for(let v=0;v<p;v++)o.flags.push(g),d++}}o.xs=[];for(let d=0;d<l;d++){const g=o.flags[d],p=!!(16&g);2&g?(o.xs.push(p?i[n]:-i[n]),n++):p?o.xs.push(0):(o.xs.push(e.readShort(i,n)),n+=2)}o.ys=[];for(let d=0;d<l;d++){const g=o.flags[d],p=!!(32&g);4&g?(o.ys.push(p?i[n]:-i[n]),n++):p?o.ys.push(0):(o.ys.push(e.readShort(i,n)),n+=2)}let u=0,f=0;for(let d=0;d<l;d++)u+=o.xs[d],f+=o.ys[d],o.xs[d]=u,o.ys[d]=f}else o.parts=[],o.endPts=[],o.flags=[],o.xs=[],o.ys=[];return o}}},K={parse(h){const t=new Uint8Array(h);C.readASCII(t,0,4)==="wOFF"&&(h=Re(h));const e=new Uint8Array(h),i=Nt,r={},s={Ei:e,Li:0,ki:0};for(const n in i){const o=n,c=K.findTable(e,o,0);if(c){const[l,u]=c;let f=r[l];f==null&&(f=i[o].parseTab(e,l,u,s),r[l]=f),s[o]=f}}return[s]},findTable(h,t,e){const i=C,r=i.readUshort(h,e+4);let s=e+12;for(let n=0;n<r;n++){const o=i.readASCII(h,s,4);i.readUint(h,s+4);const c=i.readUint(h,s+8),l=i.readUint(h,s+12);if(o===t)return[c,l];s+=16}return null},T:Nt,B:C};class Ne{zi(t){var i;const e=[];return(i=t.cmap)!=null&&i.tables?(t.cmap.tables.forEach(r=>{if(r.format===4){const s=this.Di(r);e.push(...s)}else if(r.format===12){const s=this.Oi(r);e.push(...s)}}),[...new Set(e)]):[]}Di(t){const e=[];if(!(t.startCount&&t.endCount&&t.idRangeOffset&&t.idDelta))return e;for(let i=0;i<t.startCount.length;i++){const r=t.startCount[i],s=t.endCount[i];if(r!==65535||s!==65535){for(let n=r;n<=s;n++)if(this.Hi(t,n,i)>0)try{const o=String.fromCodePoint(n);e.push(o)}catch{}}}return e}Oi(t){const e=[];if(!t.groups)return e;for(let i=0;i<t.groups.length;i+=3){const r=t.groups[i],s=t.groups[i+1],n=t.groups[i+2];for(let o=r;o<=s;o++)if(n+(o-r)>0)try{const c=String.fromCodePoint(o);e.push(c)}catch{}}return e}Hi(t,e,i){if(t.idRangeOffset[i]===0)return e+t.idDelta[i]&65535;{const r=t.idRangeOffset[i]/2+(e-t.startCount[i])-(t.startCount.length-i);if(r>=0&&t.glyphIdArray&&r<t.glyphIdArray.length){const s=t.glyphIdArray[r];if(s!==0)return s+t.idDelta[i]&65535}}return 0}}class Ie{constructor(t){a(this,"Bi");a(this,"Ii");a(this,"W");this.W=t,this.Bi=document.createElement("canvas"),this.Ii=this.Bi.getContext("2d",{willReadFrequently:!0,alpha:!0})}Ni(t,e,i,r){const s=t.length,n=Math.ceil(Math.sqrt(s)),o=Math.ceil(s/n),c=e.width*n,l=e.height*o;this.Gi(c,l),this.ji(t,e,n,i,r);const u=this.W.Fi(c,l,1,{filter:"nearest"});return u.et(this.Bi),{framebuffer:u,columns:n,rows:o}}Gi(t,e){this.Bi.width=t,this.Bi.height=e,this.Bi.style.width=t+"px",this.Bi.style.height=e+"px",this.Ii.imageSmoothingEnabled=!1,this.Bi.style.imageRendering="pixelated",this.Ii.clearRect(0,0,t,e),this.Ii.textBaseline="top",this.Ii.textAlign="left",this.Ii.fillStyle="white"}ji(t,e,i,r,s){const n=r/s.head.unitsPerEm;for(let o=0;o<t.length;o++){const c=o%i,l=Math.floor(o/i),u=t[o].glyphData;if(!u)continue;const f=u.advanceWidth*n,d=c*e.width,g=l*e.height,p=d+.5*e.width,v=g+.5*e.height,m=Math.round(p-.5*e.width),w=Math.round(v-.5*r),A=m+.5*(e.width-f),y=w+s.hhea.ascender*n;this.Qi(u,A,y,n)}}Qi(t,e,i,r){if(!t||!t.xs||t.noc===0)return;let{xs:s,ys:n,endPts:o,flags:c}=t;if(!(s&&n&&o&&c))return;this.Ii.beginPath();let l=0;for(let u=0;u<o.length;u++){const f=o[u];if(!(f<l)){if(f>=l){const d=e+s[l]*r,g=i-n[l]*r;this.Ii.moveTo(d,g);let p=l+1;for(;p<=f;)if(1&c[p]){const v=e+s[p]*r,m=i-n[p]*r;this.Ii.lineTo(v,m),p++}else{const v=e+s[p]*r,m=i-n[p]*r;if(p+1>f){const A=e+s[l]*r,y=i-n[l]*r;if(1&c[l])this.Ii.quadraticCurveTo(v,m,A,y);else{const E=(v+A)/2,x=(m+y)/2;this.Ii.quadraticCurveTo(v,m,E,x)}break}const w=p+1;if(1&c[w]){const A=e+s[w]*r,y=i-n[w]*r;this.Ii.quadraticCurveTo(v,m,A,y),p=w+1}else{const A=(v+(e+s[w]*r))/2,y=(m+(i-n[w]*r))/2;this.Ii.quadraticCurveTo(v,m,A,y),p=w}}this.Ii.closePath()}l=f+1}}this.Ii.fill()}}class It{Xi(t,e){const i=t.cmap;if(!i||!i.tables)return 0;let r=0;for(const s of i.tables)if(s.format===4?r=this.Yi(e,s):s.format===12&&(r=this.Ki(e,s)),r>0)break;return r}Wi(t,e){const i=e.codePointAt(0);return i===void 0?0:this.Xi(t,i)}Zi(t,e){const i=t.hmtx;return i&&i.aWidth&&i.aWidth.length!==0?e<i.aWidth.length?i.aWidth[e]:i.aWidth[i.aWidth.length-1]:0}qi(t,e){const i=e/t.head.unitsPerEm,r=t.hhea.ascender*i,s=t.hhea.descender*i,n=t.hhea.lineGap*i;return{ascender:r,descender:s,lineGap:n,lineHeight:r-s+n,unitsPerEm:t.head.unitsPerEm,scale:i}}Yi(t,e){const i=e.endCount.length;let r=-1;for(let s=0;s<i;s++)if(t<=e.endCount[s]){r=s;break}if(r===-1||t<e.startCount[r])return 0;if(e.idRangeOffset[r]===0)return t+e.idDelta[r]&65535;{const s=e.idRangeOffset[r]/2+(t-e.startCount[r])-(i-r);if(s>=0&&s<e.glyphIdArray.length){const n=e.glyphIdArray[s];return n===0?0:n+e.idDelta[r]&65535}}return 0}Ki(t,e){const i=e.groups.length/3;for(let r=0;r<i;r++){const s=e.groups[3*r],n=e.groups[3*r+1],o=e.groups[3*r+2];if(t>=s&&t<=n)return o+(t-s)}return 0}}class Se{constructor(){a(this,"Vi");this.Vi=new It}Ji(t,e,i){let r=0;const s=this.Vi.qi(i,e),n=s.lineHeight;for(const o of t){const c=this.Vi.Wi(i,o);if(c===0)continue;const l=this.Vi.Zi(i,c)*s.scale;r=Math.max(r,l)}return{width:Math.ceil(r),height:Math.ceil(n)}}}class _e{constructor(){a(this,"tr");this.tr=new It}sr(t,e){const i=[],r=new Map;return t.forEach((s,n)=>{const o=s.codePointAt(0)||0,c={character:s,unicode:o,color:this.er(n),glyphData:this.ir(e,s)};i.push(c),r.set(s,c)}),{array:i,map:r}}er(t){return[t%256/255,Math.floor(t/256)%256/255,0]}ir(t,e){const i=e.codePointAt(0)||0,r=this.tr.Xi(t,i);if(r===0)return null;let s=0;t.hmtx&&t.hmtx.aWidth&&r>0&&t.hmtx.aWidth[r]!==void 0&&(s=t.hmtx.aWidth[r]);const n=K.T.glyf.Ri(t,r);return n?{...n,advanceWidth:s}:null}}class rt{constructor(t,e=16){a(this,"rr");a(this,"nr",[]);a(this,"hr",new Map);a(this,"ar");a(this,"cr",16);a(this,"lr",0);a(this,"ur",0);a(this,"dr",{width:0,height:0});a(this,"pr");a(this,"vr");a(this,"gr");a(this,"mr");a(this,"_r");a(this,"yr",!1);this.cr=e,this.vr=new Ne,this.gr=new Ie(t),this.mr=new Se,this._r=new _e}async Ar(t){if(this.yr)return;let e;if(t){const i=await fetch(t);if(!i.ok)throw new T(`Failed to load font file: ${i.status} ${i.statusText}`);e=await i.arrayBuffer()}else e=await(await fetch("data:font/woff;base64,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")).arrayBuffer();await this.wr(e),this.rr=K.parse(e)[0],await this.br()}Cr(t){if(t===void 0)return this.cr;this.cr=t,this.dr=this.mr.Ji(this.nr.map(i=>i.character),this.cr,this.rr);const e=this.gr.Ni(this.nr,this.dr,this.cr,this.rr);this.ar=e.framebuffer,this.lr=e.columns,this.ur=e.rows}async Mr(t){try{const e=await fetch(t);if(!e.ok)throw new T(`Failed to load font file: ${e.status} ${e.statusText}`);const i=await e.arrayBuffer();await this.wr(i);const r=K.parse(i);if(!r||r.length===0)throw new Error("Failed to parse font file");this.rr=r[0],await this.br()}catch(e){throw new T(`Failed to load font: ${e instanceof Error?e.message:"Unknown error"}`,e)}}async wr(t){const e=Date.now();this.pr=new FontFace(`CustomFont_${e}`,t),await this.pr.load(),document.fonts.add(this.pr)}async br(){const t=this.vr.zi(this.rr),{array:e,map:i}=this._r.sr(t,this.rr);this.nr=e,this.hr=i,this.dr=this.mr.Ji(t,this.cr,this.rr);const r=this.gr.Ni(this.nr,this.dr,this.cr,this.rr);this.ar=r.framebuffer,this.lr=r.columns,this.ur=r.rows,this.yr=!0}$r(t){const e=this.hr.get(t);return e?e.color:[0,0,0]}Fr(t){return Array.from(t).map(e=>{const i=this.hr.get(e);return i?i.color:[0,0,0]})}$s(){this.ar.dispose(),document.fonts.delete(this.pr)}get Pr(){return this.yr}get fontFramebuffer(){return this.ar}get characterMap(){return this.hr}get characters(){return this.nr}get textureColumns(){return this.lr}get textureRows(){return this.ur}get maxGlyphDimensions(){return this.dr}get fontSize(){return this.cr}get font(){return this.rr}}class St{constructor(t,e,i){a(this,"Tr");a(this,"Sr");a(this,"N");a(this,"G");a(this,"Rr");a(this,"Er");a(this,"kr");a(this,"Lr");a(this,"zr");a(this,"Dr",!1);a(this,"Or",new Set);this.kr=t,this.Lr=e,this.zr=i,this.Js()}Hr(){if(this.N=this.Tr*this.Lr,this.G=this.Sr*this.zr,this.Rr=Math.floor((this.kr.width-this.N)/2),this.Er=Math.floor((this.kr.height-this.G)/2),this.Or.size>0)for(const t of this.Or)t()}Br(t){this.Or.add(t)}Ir(t){this.Or.delete(t)}Js(){this.Dr||(this.Tr=Math.floor(this.kr.width/this.Lr),this.Sr=Math.floor(this.kr.height/this.zr)),this.Hr()}Nr(t,e){this.Lr=t,this.zr=e,this.Js()}get cellWidth(){return this.Lr}get cellHeight(){return this.zr}get cols(){return this.Tr}set cols(t){this.Dr=!0,this.Tr=Math.max(1,Math.floor(t)),typeof this.Sr!="number"&&(this.Sr=Math.max(1,Math.floor(this.kr.height/this.zr))),this.Hr()}get rows(){return this.Sr}set rows(t){this.Dr=!0,this.Sr=Math.max(1,Math.floor(t)),typeof this.Tr!="number"&&(this.Tr=Math.max(1,Math.floor(this.kr.width/this.Lr))),this.Hr()}get width(){return this.N}get height(){return this.G}get offsetX(){return this.Rr}get offsetY(){return this.Er}responsive(){this.Dr=!1}$s(){this.Or.clear()}}const Ue=/^rgba?\(([^)]+)\)$/i;function vt(h){return Number.isNaN(h)?0:Math.max(0,Math.min(255,h))}function Oe(h){if(!h)return null;const t=h.trim().toLowerCase();if(!t)return null;let e=null;return t.startsWith("rgb")&&(e=function(i){const r=Ue.exec(i.trim());if(!r)return null;const s=r[1].split(",").map(u=>u.trim());if(s.length<3)return null;const n=vt(parseFloat(s[0])),o=vt(parseFloat(s[1])),c=vt(parseFloat(s[2])),l=s[3]!==void 0?255*Math.max(0,Math.min(1,parseFloat(s[3]))):255;return[n,o,c,Math.round(l)]}(t)),e?e[3]===0?null:e:null}class _t{constructor(t={}){a(this,"kr");a(this,"Gr",null);a(this,"jr",!1);a(this,"Qr");this.jr=t.overlay??!1,this.jr&&t.canvas?(this.Gr=t.canvas,this.kr=this.Xr(),this.Qr=!0,this.Yr()):t.canvas?(this.kr=t.canvas,this.Qr=!1):(this.kr=this.Kr(t.width,t.height),this.Qr=!0),this.kr.style.imageRendering="pixelated"}Kr(t,e){const i=document.createElement("canvas");return i.className="textmodeCanvas",i.style.imageRendering="pixelated",i.width=t||800,i.height=e||600,document.body.appendChild(i),i}Xr(){const t=document.createElement("canvas");t.className="textmodeCanvas",t.style.imageRendering="pixelated";const e=this.Gr.getBoundingClientRect();let i=Math.round(e.width),r=Math.round(e.height);if(this.Gr instanceof HTMLVideoElement){const o=this.Gr;(i===0||r===0)&&o.videoWidth>0&&o.videoHeight>0&&(i=o.videoWidth,r=o.videoHeight)}t.width=i,t.height=r,t.style.position="absolute",t.style.pointerEvents="none";const s=window.getComputedStyle(this.Gr);let n=parseInt(s.zIndex||"0",10);return isNaN(n)&&(n=0),t.style.zIndex=(n+1).toString(),t}Yr(){var t;this.Wr(),(t=this.Gr.parentNode)==null||t.insertBefore(this.kr,this.Gr.nextSibling)}Zr(){const t=[];return this.jr&&this.Gr instanceof HTMLElement&&(t.push(this.Gr),this.Gr.parentElement&&t.push(this.Gr.parentElement)),this.kr.parentElement&&t.push(this.kr.parentElement),t.push(this.kr),t.push(document.body),t.push(document.documentElement),t}qr(){const t=this.Zr();for(const e of t){if(!e)continue;const i=Oe(window.getComputedStyle(e).backgroundColor);if(i)return i}return[255,255,255,255]}Wr(){if(!this.Gr)return;const t=this.Gr.getBoundingClientRect();let e=this.Gr.offsetParent;if(e&&e!==document.body){const i=e.getBoundingClientRect();this.kr.style.top=t.top-i.top+"px",this.kr.style.left=t.left-i.left+"px"}else this.kr.style.top=t.top+window.scrollY+"px",this.kr.style.left=t.left+window.scrollX+"px"}Vr(t,e){if(this.jr){const i=this.Gr.getBoundingClientRect();this.kr.width=Math.round(i.width),this.kr.height=Math.round(i.height),this.Wr()}else this.kr.width=t??this.kr.width,this.kr.height=e??this.kr.height}Jr(){const t=this.kr.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!0,stencil:!1,powerPreference:"high-performance"});if(!t)throw new T("`textmode.js` requires WebGL2 support.");return t}$s(){const t=this.kr.getContext("webgl")||this.kr.getContext("webgl2");if(t){const e=t.getExtension("WEBGL_lose_context");e==null||e.loseContext()}this.Qr&&this.kr.parentNode&&this.kr.parentNode.removeChild(this.kr)}get canvas(){return this.kr}get targetCanvas(){return this.Gr}get width(){return this.kr.width}get height(){return this.kr.height}}function st(h){return X(parseInt(h,16),0,255)}class N{constructor(t,e,i,r){a(this,"tn");a(this,"sn");a(this,"r");a(this,"g");a(this,"b");a(this,"a");this.r=X(t,0,255),this.g=X(e,0,255),this.b=X(i,0,255),this.a=X(r,0,255),this.tn=[this.r,this.g,this.b,this.a],this.sn=[this.r/255,this.g/255,this.b/255,this.a/255]}static en(t,e,i,r){if(N.rn(t))return t;if(Array.isArray(t)){if(t.length<3)throw new Error("Component tuples must include at least RGB values.");const[s,n,o]=t,c=t.length===4?t[3]:255;return N.nn(s,n,o,c)}if(typeof t=="string"){const s=t.trim();if(s.length===0)throw new Error("Color strings cannot be empty.");return N.hn(s)}if(typeof t=="number")return typeof e=="number"&&typeof i=="number"?N.nn(t,e,i,r??255):N.an(t);throw new Error("Unsupported color input passed to TextmodeColor.$from.")}static nn(t,e,i,r=255){return new N(t,e,i,r)}static an(t,e=255){return new N(t,t,t,e)}static hn(t){return new N(...function(e){const i=e.replace(/^#|0x/gi,""),r=(s=i).length===3||s.length===4?s.split("").map(n=>n+n).join(""):s;var s;if(r.length!==6&&r.length!==8)throw new Error(`Invalid hex color: ${e}`);return[st(r.slice(0,2)),st(r.slice(2,4)),st(r.slice(4,6)),r.length===8?st(r.slice(6,8)):255]}(t))}get rgb(){return[this.r,this.g,this.b]}get rgba(){return[...this.tn]}get normalized(){return[...this.sn]}withAlpha(t){return new N(this.r,this.g,this.b,t)}static rn(t){return t instanceof N}}class Ut{constructor(t,e,i,r,s,n,o,c){a(this,"A");a(this,"W");a(this,"cn");a(this,"ln");a(this,"un");a(this,"N");a(this,"G");a(this,"Z",null);a(this,"fn",null);a(this,"dn","brightness");a(this,"pn",null);a(this,"vn");a(this,"Pt",0);a(this,"Bt",0);a(this,"It",0);a(this,"Tt",0);a(this,"gn","sampled");a(this,"mn","fixed");a(this,"Gt",[1,1,1,1]);a(this,"jt",[0,0,0,1]);a(this,"_n",[0,0,0,1]);a(this,"yn",[[.1,0,0]]);a(this,"An",null);this.A=t,this.W=e,this.cn=i,this.vn=r,this.ln=s,this.un=n,this.N=o,this.G=c}conversionMode(t){return this.dn=t,this.pn=null,this.Z=null,this}$s(){this.A.deleteTexture(this.cn)}invert(t=!0){return this.Pt=t?1:0,this.Z=null,this}flipX(t=!0){return this.Bt=t?1:0,this.Z=null,this}flipY(t=!0){return this.It=t?1:0,this.Z=null,this}charRotation(t){return this.Tt=bt(t),this.Z=null,this}charColorMode(t){return this.gn=t,this.Z=null,this}cellColorMode(t){return this.mn=t,this.Z=null,this}charColor(t,e,i,r){return this.wn(this.Gt,t,e,i,r),this.Z=null,this}cellColor(t,e,i,r){return this.wn(this.jt,t,e,i,r),this.Z=null,this}background(t,e,i,r){return this.wn(this._n,t,e,i,r),this.Z=null,this}characters(t){return this.An=t,this.bn(t),this.Z=null,this}yi(t){this.fn!==t&&(this.fn=t,this.An&&this.bn(this.An),this.Z=null)}get texture(){return this.cn}get width(){return this.N}get height(){return this.G}get originalWidth(){return this.ln}get originalHeight(){return this.un}lt(){return this.Z||this.ut(),this.Z}Cn(){}ut(){this.Cn();const t=this.xn(),e=this.Mn(),i=t.createShader(e),r=t.createUniforms(e);this.Z=this.W.materialManager.Ne(i,r)}wn(t,e,i,r,s){const n=N.en(e,i,r,s);$(t,n.r,n.g,n.b,n.a)}bn(t){if(!this.fn)return;const e=this.fn.Fr(t).filter(i=>Array.isArray(i)).slice(0,255);this.yn=e.length>0?e:this.yn}createBaseConversionUniforms(){return{u_image:this.$n(),u_invert:!!this.Pt,u_flipX:!!this.Bt,u_flipY:!!this.It,u_charRotation:this.Tt,u_charColorFixed:this.gn==="fixed",u_charColor:this.Gt,u_cellColorFixed:this.mn==="fixed",u_cellColor:this.jt,u_backgroundColor:this._n,u_charCount:this.yn.length,u_charList:this.yn}}xn(){if(this.pn&&this.pn.id===this.dn)return this.pn;const t=this.vn.Fn(this.dn);if(!t)throw new Error(`[textmode.js] Conversion mode "${this.dn}" is not registered. If this mode is provided by an add-on, make sure its plugin is installed before loading sources.`);return this.pn=t,t}Mn(){if(!this.fn)throw new Error("[textmode.js] Cannot create conversion context: no active font set. Ensure $setActiveFont() is called before rendering.");return{renderer:this.W,gl:this.A,font:this.fn,source:this,gridWidth:this.N,gridHeight:this.G}}}class q extends Ut{constructor(t,e,i,r,s,n,o,c){const l=Math.min(o/s,c/n);super(t,e,i,r,s,n,Math.max(1,Math.floor(s*l)),Math.max(1,Math.floor(n*l)))}static Pn(t,e,i,r,s){const n=t.context,o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,1),ut(n,n.NEAREST,n.NEAREST,n.CLAMP_TO_EDGE,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),n.bindTexture(n.TEXTURE_2D,null);const c=i.naturalWidth??i.width??i.videoWidth??0,l=i.naturalHeight??i.height??i.videoHeight??0;return new q(n,t,o,e,c,l,r,s)}$n(){return this.cn}}class Ot{constructor(t=60){a(this,"Tn");a(this,"Sn");a(this,"Rn",null);a(this,"En",0);a(this,"kn",!0);a(this,"Ln",0);a(this,"zn",0);a(this,"Dn",[]);a(this,"On",10);a(this,"Hn",0);a(this,"Bn",0);a(this,"In",-1);this.Sn=t,this.Tn=1e3/t}Nn(t){if(!this.kn)return;this.In===-1&&(this.In=performance.now()),this.En=performance.now();const e=i=>{if(!this.kn)return void(this.Rn=null);const r=i-this.En;r>=this.Tn&&(t(),this.En=i-r%this.Tn),this.kn&&(this.Rn=requestAnimationFrame(e))};this.Rn=requestAnimationFrame(e)}Gn(){this.Rn&&(cancelAnimationFrame(this.Rn),this.Rn=null)}jn(){this.kn&&(this.kn=!1,this.Gn())}Qn(t){this.kn||(this.kn=!0,this.Nn(t))}Xn(t,e){if(t===void 0)return this.Ln;this.Sn=t,this.Tn=1e3/t,this.kn&&e&&(this.Gn(),this.Nn(e))}Yn(){const t=performance.now();if(this.zn>0){const e=t-this.zn;this.Hn=e,this.Dn.push(e),this.Dn.length>this.On&&this.Dn.shift();const i=this.Dn.reduce((r,s)=>r+s,0)/this.Dn.length;this.Ln=1e3/i}this.zn=t}get Kn(){return this.kn}get Wn(){return this.Ln}get Zn(){return this.Sn}set Zn(t){this.Sn=t,this.Tn=1e3/t}get qn(){return this.Bn}set qn(t){this.Bn=t}Vn(){this.Bn++}get Jn(){return this.In===-1?0:performance.now()-this.In}set Jn(t){this.In=performance.now()-t}get so(){return this.Jn/1e3}set so(t){this.Jn=1e3*t}get eo(){return this.Hn}}class Lt{constructor(t,e){a(this,"kr");a(this,"io");a(this,"ro",{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY});a(this,"no",{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY});a(this,"oo",null);a(this,"ho",0);a(this,"ao");a(this,"co");a(this,"lo");a(this,"uo");a(this,"fo");a(this,"do");a(this,"po",!1);a(this,"vo");a(this,"mo");a(this,"_o");a(this,"yo");a(this,"Ao");this.kr=t,this.io=e}wo(t){const e=performance.now()+Math.max(0,t);e>this.ho&&(this.ho=e)}bo(){return performance.now()<this.ho}Co(t){const e=this.kr.canvas;e.style.cursor=t==null||t===""?"":t}xo(){if(this.po)return;const t=this.kr.canvas;this.ao=e=>{this.Mo(e),this.$o(e)},this.co=()=>{this.no={...this.ro},this.ro.x=Number.NEGATIVE_INFINITY,this.ro.y=Number.NEGATIVE_INFINITY,this.oo=null},this.lo=e=>{this.Mo(e),this.Fo(e)},this.uo=e=>{this.Mo(e),this.Po(e)},this.fo=e=>{this.Mo(e),this.To(e)},this.do=e=>{this.Mo(e),this.Uo(e)},t.addEventListener("mousemove",this.ao,{passive:!0}),t.addEventListener("mouseleave",this.co,{passive:!0}),t.addEventListener("mousedown",this.lo,{passive:!0}),t.addEventListener("mouseup",this.uo,{passive:!0}),t.addEventListener("click",this.fo,{passive:!0}),t.addEventListener("wheel",this.do,{passive:!1}),this.po=!0}So(){if(!this.po)return;const t=this.kr.canvas;t.removeEventListener("mousemove",this.ao),t.removeEventListener("mouseleave",this.co),t.removeEventListener("mousedown",this.lo),t.removeEventListener("mouseup",this.uo),t.removeEventListener("click",this.fo),t.removeEventListener("wheel",this.do),this.po=!1}Ro(){if(!this.po)return;const t=this.io();if(t)try{if(this.oo){const e=new MouseEvent("mousemove",{clientX:this.oo.x,clientY:this.oo.y,bubbles:!1,cancelable:!1});this.Mo(e)}else{const e=Math.floor((t.cols-1)/2),i=Math.floor(t.rows/2);if(this.ro.x!==Number.NEGATIVE_INFINITY&&this.ro.y!==Number.NEGATIVE_INFINITY){const r=-e,s=t.cols-e-1,n=-i,o=t.rows-i-1;(this.ro.x<r||this.ro.x>s||this.ro.y<n||this.ro.y>o)&&(this.ro.x=Number.NEGATIVE_INFINITY,this.ro.y=Number.NEGATIVE_INFINITY)}}}catch{this.ro.x=Number.NEGATIVE_INFINITY,this.ro.y=Number.NEGATIVE_INFINITY}}Eo(t){this.vo=t}ko(t){this.mo=t}Lo(t){this._o=t}zo(t){this.yo=t}Do(t){this.Ao=t}Oo(){return{x:this.ro.x,y:this.ro.y}}$o(t){if(this.yo&&!this.bo()){const e={position:{...this.ro},previousPosition:{...this.no},originalEvent:t};this.yo(e)}}Fo(t){if(this.mo&&!this.bo()){const e={position:{...this.ro},previousPosition:{...this.no},button:t.button,originalEvent:t};this.mo(e)}}Po(t){if(this._o&&!this.bo()){const e={position:{...this.ro},previousPosition:{...this.no},button:t.button,originalEvent:t};this._o(e)}}To(t){if(this.vo&&!this.bo()){const e={position:{...this.ro},previousPosition:{...this.no},button:t.button,originalEvent:t};this.vo(e)}}Uo(t){if(this.Ao&&!this.bo()){const e={position:{...this.ro},previousPosition:{...this.no},delta:{x:t.deltaX,y:t.deltaY},originalEvent:t};this.Ao(e)}}Mo(t){const e=this.kr.canvas,i=this.io();if(this.no={...this.ro},this.oo={x:t.clientX,y:t.clientY},!i)return this.ro.x=Number.NEGATIVE_INFINITY,void(this.ro.y=Number.NEGATIVE_INFINITY);const r=e.getBoundingClientRect(),s=t.clientX-r.left,n=t.clientY-r.top,o=e.width/r.width,c=n*(e.height/r.height),l=s*o-i.offsetX,u=c-i.offsetY,f=Math.floor(l/i.cellWidth),d=Math.floor(u/i.cellHeight);if(f>=0&&f<i.cols&&d>=0&&d<i.rows){const g=Math.floor((i.cols-1)/2);this.ro.x=f-g,this.ro.y=d-Math.floor(i.rows/2)}else this.ro.x=Number.NEGATIVE_INFINITY,this.ro.y=Number.NEGATIVE_INFINITY}}const Le=Object.freeze(Object.defineProperty({__proto__:null,MouseManager:Lt},Symbol.toStringTag,{value:"Module"}));class Bt{constructor(){a(this,"Ho",new Map);a(this,"Bo",null);a(this,"Io",null);a(this,"No");a(this,"Go");a(this,"po",!1);a(this,"jo");a(this,"Qo");a(this,"Xo",{ArrowUp:"UP_ARROW",ArrowDown:"DOWN_ARROW",ArrowLeft:"LEFT_ARROW",ArrowRight:"RIGHT_ARROW",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",Enter:"ENTER",Return:"RETURN",Tab:"TAB",Escape:"ESCAPE",Backspace:"BACKSPACE",Delete:"DELETE",Insert:"INSERT",Home:"HOME",End:"END",PageUp:"PAGE_UP",PageDown:"PAGE_DOWN",Shift:"SHIFT",Control:"CONTROL",Alt:"ALT",Meta:"META"," ":"SPACE"})}xo(){this.po||(this.No=t=>{this.Yo(t)},this.Go=t=>{this.Ko(t)},window.addEventListener("keydown",this.No,{passive:!1}),window.addEventListener("keyup",this.Go,{passive:!1}),this.po=!0)}So(){this.po&&(window.removeEventListener("keydown",this.No),window.removeEventListener("keyup",this.Go),this.po=!1,this.Ho.clear(),this.Bo=null,this.Io=null)}ko(t){this.jo=t}Lo(t){this.Qo=t}Wo(t){const e=this.Zo(t),i=this.Ho.get(t)||this.Ho.get(e);return(i==null?void 0:i.isPressed)||!1}qo(){return this.Bo}Vo(){return this.Io}Jo(){const t=[];for(const[e,i]of this.Ho)i.isPressed&&t.push(e);return t}th(){return{ctrl:this.Wo("Control"),shift:this.Wo("Shift"),alt:this.Wo("Alt"),meta:this.Wo("Meta")}}sh(){this.Ho.clear(),this.Bo=null,this.Io=null}Yo(t){const e=t.key,i=Date.now();this.Ho.has(e)||this.Ho.set(e,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const r=this.Ho.get(e);if(!r.isPressed&&(r.isPressed=!0,r.lastPressTime=i,this.Bo=e,this.jo)){const s={key:e,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!0,originalEvent:t};this.jo(s)}}Ko(t){const e=t.key,i=Date.now();this.Ho.has(e)||this.Ho.set(e,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const r=this.Ho.get(e);if(r.isPressed=!1,r.lastReleaseTime=i,this.Io=e,this.Qo){const s={key:e,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!1,originalEvent:t};this.Qo(s)}}Zo(t){return this.Xo[t]||t.toLowerCase()}}const Be=Object.freeze(Object.defineProperty({__proto__:null,KeyboardManager:Bt},Symbol.toStringTag,{value:"Module"}));class Dt{constructor(t,e,i){a(this,"kr");a(this,"eh");a(this,"io");a(this,"ih",new Map);a(this,"rh",new Map);a(this,"nh",new Map);a(this,"oh",null);a(this,"hh");a(this,"ah");a(this,"uh");a(this,"fh");a(this,"dh");a(this,"ph");a(this,"po",!1);a(this,"gh");a(this,"mh");a(this,"_h");a(this,"yh");a(this,"Ah");a(this,"wh");a(this,"bh");a(this,"Ch");a(this,"xh");a(this,"Mh");a(this,"$h",320);a(this,"Fh",350);a(this,"Ph",10);a(this,"Th",550);a(this,"Sh",14);a(this,"Rh",48);a(this,"Eh",650);a(this,"kh",.02);a(this,"Lh",2);a(this,"zh",600);a(this,"Dh",0);a(this,"Oh",null);this.kr=t,this.io=e,this.eh=i;const r=this.kr.canvas;this.hh=r.style.touchAction,this.ah=r.style.userSelect,r.style.touchAction||(r.style.touchAction="none"),r.style.userSelect||(r.style.userSelect="none")}xo(){if(this.po)return;const t=this.kr.canvas;this.uh=e=>{this.Hh(e)},this.fh=e=>{this.Bh(e)},this.dh=e=>{this.Ih(e)},this.ph=e=>{this.Nh(e)},t.addEventListener("touchstart",this.uh,{passive:!1}),t.addEventListener("touchmove",this.fh,{passive:!1}),t.addEventListener("touchend",this.dh,{passive:!1}),t.addEventListener("touchcancel",this.ph,{passive:!1}),this.po=!0}So(){if(!this.po)return;const t=this.kr.canvas;t.removeEventListener("touchstart",this.uh),t.removeEventListener("touchmove",this.fh),t.removeEventListener("touchend",this.dh),t.removeEventListener("touchcancel",this.ph),this.po=!1,this.oh=null,this.ih.clear(),this.rh.clear(),this.nh.forEach(e=>{e.longPressTimer!==null&&window.clearTimeout(e.longPressTimer)}),this.nh.clear(),this.Oh=null,this.Dh=0,t.style.touchAction=this.hh,t.style.userSelect=this.ah}Ro(){if(!this.io()||this.ih.size===0)return;const t=new Map;for(const e of this.ih.values()){const i=this.Gh(e.clientX,e.clientY,e.id,e);t.set(e.id,i)}this.ih=t}jh(){return Array.from(this.ih.values()).map(t=>({...t}))}Qh(t){this.gh=t}zo(t){this.mh=t}Xh(t){this._h=t}Yh(t){this.yh=t}Kh(t){this.Ah=t}Wh(t){this.wh=t}Zh(t){this.bh=t}qh(t){this.Ch=t}Vh(t){this.xh=t}Jh(t){this.Mh=t}Hh(t){var r;if(!this.io())return;t.preventDefault(),(r=this.eh)==null||r.wo(this.zh);const e=performance.now(),i=this.ta(t.changedTouches);for(const s of i){const n=this.ih.get(s.id);n&&this.rh.set(s.id,this.sa(n)),this.ih.set(s.id,s);const o={id:s.id,startPosition:s,lastPosition:s,startTime:e,lastTime:e,longPressTimer:null,longPressFired:!1};this.bh&&(o.longPressTimer=window.setTimeout(()=>{const c=this.ih.get(s.id);c&&(o.longPressFired=!0,this.bh({touch:this.sa(c),duration:performance.now()-o.startTime,originalEvent:t}))},this.Th)),this.nh.set(s.id,o),this.gh&&this.gh(this.ea(s,t,void 0,e))}this.ih.size===2&&this.ia()}Bh(t){var r;if(!this.io())return;t.preventDefault(),(r=this.eh)==null||r.wo(this.zh);const e=performance.now(),i=this.ta(t.changedTouches);for(const s of i){const n=this.ih.get(s.id),o=n?this.sa(n):void 0;o&&this.rh.set(s.id,o),this.ih.set(s.id,s);const c=this.nh.get(s.id);c&&(c.lastPosition=s,c.lastTime=e,o)&&H(o.clientX,o.clientY,s.clientX,s.clientY)>this.Sh&&c.longPressTimer!==null&&(window.clearTimeout(c.longPressTimer),c.longPressTimer=null),this.mh&&this.mh(this.ea(s,t,o,e))}this.ih.size===2?this.ra(t):this.oh=null}Ih(t){if(!this.io())return;t.preventDefault();const e=performance.now(),i=this.ta(t.changedTouches);for(const r of i){const s=this.ih.get(r.id),n=s?this.sa(s):void 0,o=this.nh.get(r.id);o&&o.longPressTimer!==null&&(window.clearTimeout(o.longPressTimer),o.longPressTimer=null),this._h&&this._h(this.ea(r,t,n,e)),o&&this.na(o,t),this.nh.delete(r.id),this.rh.delete(r.id),this.ih.delete(r.id)}this.ih.size<2&&(this.oh=null)}Nh(t){if(!this.io())return;t.preventDefault();const e=performance.now(),i=this.ta(t.changedTouches);for(const r of i){const s=this.ih.get(r.id),n=s?this.sa(s):void 0,o=this.nh.get(r.id);o&&o.longPressTimer!==null&&(window.clearTimeout(o.longPressTimer),o.longPressTimer=null),this.yh&&this.yh(this.ea(r,t,n,e)),this.nh.delete(r.id),this.rh.delete(r.id),this.ih.delete(r.id)}this.ih.size<2&&(this.oh=null)}ta(t){const e=[];for(let i=0;i<t.length;i+=1){const r=t.item(i);r&&e.push(this.oa(r))}return e}oa(t){return this.Gh(t.clientX,t.clientY,t.identifier,{id:t.identifier,x:-1,y:-1,clientX:t.clientX,clientY:t.clientY,pressure:t.force,radiusX:t.radiusX,radiusY:t.radiusY,rotationAngle:t.rotationAngle})}Gh(t,e,i,r){const s=this.kr.canvas,n=this.io(),o=s.getBoundingClientRect(),c=t-o.left,l=e-o.top,u=c*(s.width/o.width),f=l*(s.height/o.height);if(!n)return{id:i,x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,clientX:t,clientY:e,pressure:r.pressure,radiusX:r.radiusX,radiusY:r.radiusY,rotationAngle:r.rotationAngle};const d=u-n.offsetX,g=f-n.offsetY,p=Math.floor(d/n.cellWidth),v=Math.floor(g/n.cellHeight);return p>=0&&p<n.cols&&v>=0&&v<n.rows?{id:i,x:p-Math.floor((n.cols-1)/2),y:v-Math.floor(n.rows/2),clientX:t,clientY:e,pressure:r.pressure,radiusX:r.radiusX,radiusY:r.radiusY,rotationAngle:r.rotationAngle}:{id:i,x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,clientX:t,clientY:e,pressure:r.pressure,radiusX:r.radiusX,radiusY:r.radiusY,rotationAngle:r.rotationAngle}}ea(t,e,i,r){const s=this.nh.get(t.id),n=Array.from(this.rh.values()).map(l=>this.sa(l)),o=Array.from(this.ih.values()).map(l=>this.sa(l)),c=this.ta(e.changedTouches);return{touch:this.sa(t),previousTouch:i?this.sa(i):void 0,touches:o,previousTouches:n,changedTouches:c,deltaTime:s?r-s.lastTime:0,originalEvent:e}}ia(){if(this.ih.size!==2)return void(this.oh=null);const t=Array.from(this.ih.values()),[e,i]=t,r=H(e.x,e.y,i.x,i.y),s=Et(e.clientX,e.clientY,i.clientX,i.clientY);this.oh={ids:[e.id,i.id],initialDistance:Math.max(r,1e-4),initialAngle:s,lastScale:1,lastRotation:0}}ra(t){if(this.oh||this.ia(),!this.oh)return;const[e,i]=this.oh.ids,r=this.ih.get(e),s=this.ih.get(i);if(!r||!s)return;const n=H(r.x,r.y,s.x,s.y)/this.oh.initialDistance,o=n-this.oh.lastScale;this.xh&&Math.abs(o)>this.kh&&(this.xh({touches:[this.sa(r),this.sa(s)],scale:n,deltaScale:o,center:this.ha(r,s),originalEvent:t}),this.oh.lastScale=n);let c=Et(r.clientX,r.clientY,s.clientX,s.clientY)-this.oh.initialAngle;c=(c+180)%360-180;const l=c-this.oh.lastRotation;this.Mh&&Math.abs(l)>this.Lh&&(this.Mh({touches:[this.sa(r),this.sa(s)],rotation:c,deltaRotation:l,center:this.ha(r,s),originalEvent:t}),this.oh.lastRotation=c)}ha(t,e){const i=(t.clientX+e.clientX)/2,r=(t.clientY+e.clientY)/2,s=this.Gh(i,r,-1,{id:-1,x:-1,y:-1,clientX:i,clientY:r});return{x:s.x,y:s.y}}na(t,e){const i=performance.now(),r=i-t.startTime,s=H(t.startPosition.clientX,t.startPosition.clientY,t.lastPosition.clientX,t.lastPosition.clientY);if(!t.longPressFired&&r<=this.$h&&s<=this.Ph)this.aa(t.lastPosition,i)&&this.wh?this.wh({touch:this.sa(t.lastPosition),taps:2,originalEvent:e}):this.Ah&&this.Ah({touch:this.sa(t.lastPosition),taps:1,originalEvent:e});else if(!t.longPressFired&&r<=this.Eh&&s>=this.Rh){const n={x:t.lastPosition.clientX-t.startPosition.clientX,y:t.lastPosition.clientY-t.startPosition.clientY},o=Math.max(Math.hypot(n.x,n.y),1e-4),c={x:n.x/o,y:n.y/o},l={x:n.x/r,y:n.y/r};this.Ch&&this.Ch({touch:this.sa(t.lastPosition),direction:c,distance:o,velocity:l,originalEvent:e})}this.Dh=i,this.Oh=this.sa(t.lastPosition)}aa(t,e){return!this.Oh||e-this.Dh>this.Fh?!1:H(t.clientX,t.clientY,this.Oh.clientX,this.Oh.clientY)<=this.Ph}sa(t){return{...t}}}const De=Object.freeze(Object.defineProperty({__proto__:null,TouchManager:Dt},Symbol.toStringTag,{value:"Module"}));class nt extends Ut{constructor(e,i,r,s,n,o,c,l,u){const f=o/c;let d,g;f>1?(d=l,g=Math.round(l/f)):(g=u,d=Math.round(u*f));super(e,i,r,s,o,c,d,g);a(this,"ca");this.ca=n}$s(){super.$s(),this.ca.pause(),this.ca.src="",this.ca.load()}la(){if(this.ca.readyState>=this.ca.HAVE_CURRENT_DATA){const e=this.A;e.bindTexture(e.TEXTURE_2D,this.cn),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.ca),e.bindTexture(e.TEXTURE_2D,null)}}$n(){return this.cn}lt(){return this.Z=null,super.lt()}Cn(){this.la()}static async Pn(e,i,r,s,n){const o=e.context;let c;c=document.createElement("video"),c.crossOrigin="anonymous",c.loop=!0,c.muted=!0,c.playsInline=!0,await new Promise((d,g)=>{c.addEventListener("loadedmetadata",()=>d(),{once:!0}),c.addEventListener("error",p=>{var m;const v=p.target;g(new Error(`Failed to load video: ${((m=v.error)==null?void 0:m.message)||"Unknown error"}`))},{once:!0}),c.src=r});const l=o.createTexture();o.bindTexture(o.TEXTURE_2D,l),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,1),ut(o,o.LINEAR,o.LINEAR,o.CLAMP_TO_EDGE,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,c),o.bindTexture(o.TEXTURE_2D,null);const u=c.videoWidth,f=c.videoHeight;return new nt(o,e,l,i,c,u,f,s,n)}async play(){await this.ca.play()}pause(){this.ca.pause()}stop(){this.ca.pause(),this.ca.currentTime=0}speed(e){return this.ca.playbackRate=e,this}loop(e=!0){return this.ca.loop=e,this}time(e){return this.ca.currentTime=e,this}volume(e){return this.ca.volume=Math.max(0,Math.min(1,e)),this}get videoElement(){return this.ca}get currentTime(){return this.ca.currentTime}get duration(){return this.ca.duration}get isPlaying(){return!this.ca.paused&&!this.ca.ended}}const We=h=>class extends h{ua(t,e,i,r){if(N.rn(t))return t;if(typeof t=="number"||typeof t=="string")return this.color(t,e,i,r);throw new Error("Unsupported color input passed to color-capable method.")}rotate(t=0,e=0,i=0){this.W.state.Zt(t),this.W.state.qt(e),this.W.state.Vt(i)}rotateX(t){this.W.state.Zt(t)}rotateY(t){this.W.state.qt(t)}rotateZ(t){this.W.state.Vt(t)}translate(t=0,e=0,i=0){this.W.state.Jt(t,e,i)}translateX(t){this.W.state.Jt(t,0,0)}translateY(t){this.W.state.Jt(0,t,0)}translateZ(t){this.W.state.Jt(0,0,t)}push(){this.W.state.nt()}pop(){this.W.state.ot()}color(t,e,i,r){return N.en(t,e,i,r)}rect(t=1,e=1){this.W.wi(t,e)}point(){this.W.wi(1,1)}line(t,e,i,r){this.W.bi(t,e,i,r)}lineWeight(t){this.W.state.Kt(t)}background(t,e,i,r=255){const s=this.ua(t,e,i,r);this.W.Pi(s.r,s.g,s.b,s.a)}char(t){const e=Array.from(t);if(e.length===0)throw new Error("char() requires at least one character.");this.W.state.rs(this.fa.font.$r(e[0]))}charColor(t,e,i,r){const s=this.ua(t,e,i,r);this.W.state.ns(s.r,s.g,s.b,s.a)}cellColor(t,e,i,r){const s=this.ua(t,e,i,r);this.W.state.hs(s.r,s.g,s.b,s.a)}flipX(t){this.W.state.cs(t)}flipY(t){this.W.state.ls(t)}charRotation(t){this.W.state.fs(t)}invert(t){this.W.state.us(t)}clear(){this.W.ye(0,0,0,0)}ellipse(t,e){this.W.Ci(t/2,e/2)}triangle(t,e,i,r,s,n){this.W.xi(t,e,i,r,s,n)}bezierCurve(t,e,i,r,s,n,o,c){this.W.Mi(t,e,i,r,s,n,o,c)}arc(t,e,i,r){this.W.$i(t/2,e/2,i,r)}shader(t){this.W.pi(t)}setUniform(t,e){this.W.H(t,e)}setUniforms(t){this.W.gi(t)}async createFilterShader(t){if(typeof t=="string"&&(t.startsWith("./")||t.startsWith("../")||t.endsWith(".frag")||t.endsWith(".glsl"))){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load shader from ${t}: ${e.statusText}`);const i=await e.text();return this.W.mi(i)}return this.W.mi(t)}async createShader(t,e){let i,r;if(typeof t=="string"&&(t.startsWith("./")||t.startsWith("../")||t.endsWith(".vert")||t.endsWith(".glsl"))){const s=await fetch(t);if(!s.ok)throw new Error(`Failed to load vertex shader from ${t}: ${s.statusText}`);i=await s.text()}else i=t;if(typeof e=="string"&&(e.startsWith("./")||e.startsWith("../")||e.endsWith(".frag")||e.endsWith(".glsl"))){const s=await fetch(e);if(!s.ok)throw new Error(`Failed to load fragment shader from ${e}: ${s.statusText}`);r=await s.text()}else r=e;return this.W.di(i,r)}createFramebuffer(t){return this.W.Fi(t.width??this.grid.cols,t.height??this.grid.rows,t.attachments??3)}image(t,e,i){var r;this.W._i(t,e,i,((r=this.fa)==null?void 0:r.font)??this.da.base.font),t instanceof D&&this.W.ht()}async loadImage(t){const e=t,i=await new Promise((r,s)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>r(n),n.onerror=o=>s(o),n.src=e});return q.Pn(this.W,this.vn,i,this.grid.cols,this.grid.rows)}async loadVideo(t){return await nt.Pn(this.W,this.vn,t,this.grid.cols,this.grid.rows)}},Ge=h=>class extends h{get frameCount(){return this.pa.qn}set frameCount(t){this.pa.qn=t}frameRate(t){return t===void 0?this.pa.Wn:this.pa.Xn(t,()=>this.va())}targetFrameRate(t){if(t===void 0)return this.pa.Zn;this.pa.Zn=t}noLoop(){this.pa.jn()}loop(){this.pa.Qn(()=>this.va())}redraw(t=1){if(lt.m(typeof t=="number"&&t>0&&Number.isInteger(t),"Redraw count must be a positive integer.",{method:"redraw",providedValue:t}))for(let e=0;e<t;e++)this.va()}isLooping(){return this.pa.Kn}get millis(){return this.pa.Jn}set millis(t){this.pa.Jn=t}get secs(){return this.pa.so}set secs(t){this.pa.so=t}deltaTime(){return this.pa.eo}},ke=h=>class extends h{constructor(...t){super(...t)}mouseClicked(t){this.eh.Eo(t)}mousePressed(t){this.eh.ko(t)}mouseReleased(t){this.eh.Lo(t)}mouseMoved(t){this.eh.zo(t)}mouseScrolled(t){this.eh.Do(t)}get mouse(){return this.eh.Oo()}cursor(t){this.eh.Co(t)}},Xe=h=>class extends h{constructor(...t){super(...t)}touchStarted(t){this.ga.Qh(t)}touchMoved(t){this.ga.zo(t)}touchEnded(t){this.ga.Xh(t)}touchCancelled(t){this.ga.Yh(t)}tap(t){this.ga.Kh(t)}doubleTap(t){this.ga.Wh(t)}longPress(t){this.ga.Zh(t)}swipe(t){this.ga.qh(t)}pinch(t){this.ga.Vh(t)}rotateGesture(t){this.ga.Jh(t)}get touches(){return this.ga.jh()}},ze=h=>class extends h{constructor(...t){super(...t)}keyPressed(t){this.ma.ko(t)}keyReleased(t){this.ma.Lo(t)}isKeyPressed(t){return this.ma.Wo(t)}get lastKeyPressed(){return this.ma.qo()}get lastKeyReleased(){return this.ma.Vo()}get pressedKeys(){return this.ma.Jo()}get modifierState(){return this.ma.th()}};class Wt{constructor(t){a(this,"_a");a(this,"ya",new Map);a(this,"wa",[]);a(this,"ba",new Map);a(this,"Ca",new Map);a(this,"xa",new Map);a(this,"Ma",new Map);a(this,"$a",new Map);a(this,"Fa",new Map);a(this,"Pa",new Map);a(this,"Ta",new Map);this._a=t}Sa(t){for(const e of t){if(this.ya.has(e.name))return void console.warn(`[textmode.js] Plugin "${e.name}" is already installed.`);const i=this.Ra(e.name);try{const r=e.install(this._a,i);r instanceof Promise&&r.catch(s=>{console.error(`[textmode.js] Async plugin "${e.name}" installation error:`,s),this.Ea(e.name)})}catch(r){throw this.Ea(e.name),r}this.ya.set(e.name,e),this.wa.push(e.name)}}async ka(t){for(const e of t){if(this.ya.has(e.name))return void console.warn(`[textmode.js] Plugin "${e.name}" is already installed.`);const i=this.Ra(e.name);try{await e.install(this._a,i)}catch(r){throw this.Ea(e.name),r}this.ya.set(e.name,e),this.wa.push(e.name)}}async La(t){const e=this.ya.get(t);if(!e)return;const i=this.Ra(t);e.uninstall&&await e.uninstall(this._a,i),this.ya.delete(t),this.wa.splice(this.wa.indexOf(t),1),this.Ea(t)}za(){this.Da(this.ba)}Oa(){this.Da(this.Ca)}Ha(t){this.Ba(this.xa,t)}Ia(t){this.Na(this.Ma,t)}Ga(t){this.Na(this.$a,t)}async ja(){await this.Qa(this.Fa)}async Xa(){await this.Qa(this.Pa)}async Ya(){const t=[...this.ya.keys()];for(const e of t)await this.La(e)}Ra(t){const e=this._a,i=this;return{get renderer(){return e.W},get canvas(){return e.kr},get layerManager(){return e.layers},get font(){return e.layers.base.font},get grid(){return e.layers.base.grid},get drawFramebuffer(){return e.layers.base.drawFramebuffer},get asciiFramebuffer(){return e.layers.base.asciiFramebuffer},registerPreDrawHook:r=>i.Ka(i.ba,t,r),registerPostDrawHook:r=>i.Ka(i.Ca,t,r),registerLayerDisposedHook:r=>i.Ka(i.xa,t,r),registerLayerPreRenderHook:r=>i.Ka(i.Ma,t,r),registerLayerPostRenderHook:r=>i.Ka(i.$a,t,r),registerPreSetupHook:r=>i.Ka(i.Fa,t,r),registerPostSetupHook:r=>i.Ka(i.Pa,t,r),extendLayer:(r,s)=>{i.Wa(t,r,s)},removeLayerExtension:r=>{i.Za(t,r)}}}Ka(t,e,i){const r=t.get(e)??new Set;return r.add(i),t.set(e,r),()=>{const s=t.get(e);s&&(s.delete(i),s.size===0&&t.delete(e))}}Ea(t){this.ba.delete(t),this.Ca.delete(t),this.xa.delete(t),this.Ma.delete(t),this.$a.delete(t),this.Fa.delete(t),this.Pa.delete(t);const e=this.Ta.get(t);if(e){for(const i of e.keys())this.qa(i);this.Ta.delete(t)}}Da(t){for(const e of this.wa){const i=t.get(e);i&&i.forEach(r=>r())}}Ba(t,e){for(const i of this.wa){const r=t.get(i);r&&r.forEach(s=>s(e))}}Na(t,e){for(const i of this.wa){const r=t.get(i);r&&r.forEach(s=>s(e))}}async Qa(t){for(const e of this.wa){const i=t.get(e);if(i)for(const r of i)await r()}}Wa(t,e,i){let r=this.Ta.get(t);r||(r=new Map,this.Ta.set(t,r));for(const[s,n]of this.Ta)s!==t&&n.has(e)&&console.warn(`[textmode.js] Plugin "${t}" is overwriting layer method "${e}" previously added by plugin "${s}".`);r.set(e,i),this.Va(e,i)}Za(t,e){const i=this.Ta.get(t);if(!i)return;i.delete(e);let r=!1;for(const[s,n]of this.Ta)if(s!==t&&n.has(e)){r=!0;const o=n.get(e);this.Va(e,o);break}r||this.qa(e)}Va(t,e){const i=Object.getPrototypeOf(this._a.layers.base);Object.defineProperty(i,t,{value:e,writable:!0,configurable:!0,enumerable:!1})}qa(t){const e=Object.getPrototypeOf(this._a.layers.base),i=Object.getOwnPropertyDescriptor(e,t);i&&i.configurable&&delete e[t]}}const Ye=Object.freeze(Object.defineProperty({__proto__:null,TextmodePluginManager:Wt},Symbol.toStringTag,{value:"Module"}));class Gt{constructor(){a(this,"Ja",new Map);a(this,"tc",[]);a(this,"sc",0);a(this,"ec",0);a(this,"rc")}get nc(){return this.sc}get oc(){if(this.sc===0)return 0;let t=0;for(const e of this.tc){const i=this.Ja.get(e);i&&(t+=Math.min(1,Math.max(0,i.progress))*i.weight)}return Math.min(1,t/this.sc)}hc(t){this.rc=t}ac(t,e=1){const i=`phase-${this.tc.length+1}-${Date.now()}`,r={id:i,label:t,weight:Math.max(.001,e),progress:0,status:"running"};return this.Ja.set(i,r),this.tc.push(i),this.sc+=r.weight,i}cc(t,e){const i=this.Ja.get(t);if(!i)return;i.progress=Math.max(0,Math.min(1,e)),i.status=i.progress>=1?"complete":"running";const r=this.oc;Math.abs(r-this.ec)>.001&&(this.ec=r,this.rc&&this.rc(r))}lc(t){const e=this.Ja.get(t);e&&(e.progress=1,e.status="complete",this.cc(t,1))}uc(t){const e=this.Ja.get(t);e&&(e.status="failed")}fc(){return this.tc.map(t=>{const e=this.Ja.get(t);return e?{id:e.id,label:e.label,weight:e.weight,progress:e.progress,status:e.status}:{id:t,label:t,weight:1,progress:0,status:"pending"}})}}class kt{constructor(t="active"){a(this,"dc");a(this,"vc","");a(this,"gc","");this.dc=t}get mc(){return this.dc}get _c(){return this.dc!=="disabled"}get yc(){return this.dc==="active"||this.dc==="transitioning"||this.dc==="error"}get wc(){return this.vc}get bc(){return this.gc}Cc(){this.dc!=="done"&&this.dc!=="transitioning"||(this.dc="active")}xc(){this.dc!=="disabled"&&(this.dc="done")}Mc(){this.dc!=="disabled"&&(this.dc="transitioning")}$c(){this.dc==="transitioning"&&(this.dc="done")}Fc(t){this.dc!=="disabled"&&(this.dc="error",t instanceof Error?(this.vc=t.message,this.gc=t.stack||""):(this.vc=t,this.gc=""))}Pc(){this.dc="disabled"}}class Xt{constructor(t,e){a(this,"Tc",0);a(this,"Sc",1);a(this,"Rc");a(this,"Ec");this.Rc=t,this.Ec=e}get kc(){return this.Sc}get Lc(){return this.Sc<1}Nn(){this.Rc!=="none"&&this.Ec>0&&(this.Tc=performance.now())}et(){if(this.Rc==="none"||this.Ec===0)return this.Sc=1,!1;const t=performance.now()-this.Tc,e=Math.min(1,t/this.Ec);return e>=1?(this.Sc=0,!0):(this.Sc=1-e,!1)}Js(){this.Sc=1,this.Tc=0}}function At(h,t){const e=h.tone??"auto";let i="dark";return e==="light"||e==="dark"?i=e:t&&(i=function(r){if(!r)return 0;const[s,n,o]=r.map(l=>l/255),c=l=>l<=.04045?l/12.92:Math.pow((l+.055)/1.055,2.4);return .2126*c(s)+.7152*c(n)+.0722*c(o)}(t)>.5?"light":"dark"),{mode:i,background:t,textColor:i==="light"?"#1A1A1A":"#F8F8F8",subtleColor:i==="light"?"#4A4A4A":"#C0C0C0"}}function zt(h){return h.mode==="light"?["#E91E63","#9C27B0","#FF6F00"]:["#8EF9F3","#F15BB5","#FF9B71"]}function Yt(h,t){return h.length?h.map(e=>t.color(e)):[t.color("#FFFFFF")]}class jt{constructor(t,e,i,r){this.zc=t,this.id=e,this.label=i,this.Dc=r}report(t){this.zc.cc(this.id,t)}complete(){this.zc.lc(this.id)}fail(t){this.zc.uc(this.id),this.Dc&&this.Dc(t??new Error(`Loading phase "${this.label}" failed`))}async track(t){try{const e=typeof t=="function"?await t():await t;return this.complete(),e}catch(e){throw this.fail(e instanceof Error?e:String(e)),e}}}const je=({textmodifier:h,grid:t,progress:e,frameCount:i,message:r,palette:s,theme:n,phases:o,transitionOpacity:c,isError:l,errorMessage:u})=>{const f="|/-\\",d=Math.floor(i/6)%4,g=h.color(n.textColor),p=Math.floor(255*c),v=h.color(g.r,g.g,g.b,p);if(h.charColor(v),h.cellColor(0,0,0,0),l){const m=h.color(n.mode==="light"?"#D32F2F":"#FF6B6B",p);h.charColor(m),h.push(),h.translate(0,-2,0),h.char("X"),h.rect(1,1),h.pop();const w="SETUP ERROR",A=-Math.floor(w.length/2);h.push(),h.translate(A,0,0);for(const y of w)h.char(y),h.rect(1,1),h.translateX(1);if(h.pop(),u){const y=h.color(n.subtleColor),E=h.color(y.r,y.g,y.b,p);h.charColor(E);const x=Math.floor(.8*t.cols),R=u.split(" "),M=[];let P="";for(const S of R)(P+" "+S).length<=x?P=P?P+" "+S:S:(P&&M.push(P),P=S);P&&M.push(P);const U=M.slice(0,3);M.length>3&&(U[2]=U[2].substring(0,x-3)+"..."),U.forEach((S,at)=>{const si=-Math.floor(S.length/2);h.push(),h.translate(si,3+at,0);for(const ni of S)h.char(ni),h.rect(1,1),h.translateX(1);h.pop()})}return}if(h.push(),h.translate(0,0,0),h.char(f[d]),h.rect(1,1),h.pop(),e>0||o.some(m=>m.status!=="pending")){const m=Math.max(6,Math.floor(.6*t.cols)),w=-Math.floor(m/2),A=Math.floor(m*e),y=s.length?s:[h.color("#FFFFFF")];h.push(),h.translate(w,3,0);for(let E=0;E<m;E++){const x=E<A?"*":".",R=y[E%y.length],M=h.color(R.r,R.g,R.b,p);h.charColor(M),h.char(x),h.rect(1,1),h.translateX(1)}h.pop()}if(r){const m=h.color(n.subtleColor),w=h.color(m.r,m.g,m.b,p);h.charColor(w);const A=-Math.floor(r.length/2);h.push(),h.translate(A,5,0);for(const y of r)h.char(y),h.rect(1,1),h.translateX(1);h.pop()}};class ht{constructor(t,e={}){a(this,"Oc");a(this,"kc");a(this,"Hc");a(this,"Bc");a(this,"Ic");a(this,"Nc");a(this,"Gc");a(this,"jc");a(this,"Qc");a(this,"Xc");a(this,"rr");a(this,"Yc");a(this,"Kc");a(this,"Wc");a(this,"Zc");a(this,"qc",()=>{});a(this,"Vc",[]);a(this,"Jc",new Map);this.Oc=e.visible??!0,this.kc=e.opacity??1,this.Hc=e.blendMode??"normal",this.Bc=e.offsetX??0,this.Ic=e.offsetY??0,this.Nc=e.rotationZ??0,this.Gc=e.fontSize??16,this.jc=e.fontSource,e.fontSource instanceof rt?this.rr=e.fontSource:this.rr=new rt(t,this.Gc)}async tl(t){this.Qc=t,this.rr.Pr||await this.rr.Ar(this.jc);const e=this.rr.maxGlyphDimensions;this.Xc=new St(this.Qc.canvas.canvas,e.width,e.height);const i=this.Xc;this.Yc=this.Qc.createFramebuffer(i.cols,i.rows,3),this.Kc=this.Qc.createFramebuffer(i.width,i.height,1),this.Wc=this.Qc.createFramebuffer(i.width,i.height,1),this.Zc=[this.Qc.createFramebuffer(i.width,i.height,1,{depth:!1}),this.Qc.createFramebuffer(i.width,i.height,1,{depth:!1})],this.Xc.Br(()=>{var r,s,n;this.Yc.resize(this.Xc.cols,this.Xc.rows),this.Kc.resize(this.Xc.width,this.Xc.height),(r=this.Wc)==null||r.resize(this.Xc.width,this.Xc.height),(s=this.Zc)==null||s[0].resize(this.Xc.width,this.Xc.height),(n=this.Zc)==null||n[1].resize(this.Xc.width,this.Xc.height)})}draw(t){this.qc=t}show(){this.Oc=!0}hide(){this.Oc=!1}opacity(t){if(t===void 0)return this.kc;this.kc=Math.min(1,Math.max(0,t))}blendMode(t){if(t===void 0)return this.Hc;this.Hc=t}offset(t,e=0){if(t===void 0)return{x:this.Bc,y:this.Ic};this.Bc=t,this.Ic=e}rotateZ(t){if(t===void 0)return this.Nc;this.Nc=t}filter(t,e){this.Vc.push({name:t,params:e})}setPluginState(t,e){this.Jc.set(t,e)}getPluginState(t){return this.Jc.get(t)}hasPluginState(t){return this.Jc.has(t)}deletePluginState(t){return this.Jc.delete(t)}fontSize(t){lt.m(typeof t=="number"&&t>0,"Font size must be a positive number greater than 0.",{method:"fontSize",providedValue:t})&&this.rr.fontSize!==t&&(this.rr.Cr(t),this.sl())}async loadFont(t){if(!this.rr)throw new Error("Layer font not initialized. Ensure layer is attached before loading fonts.");return t instanceof rt?(this.rr=t,this.rr.Pr||await this.rr.Ar()):await this.rr.Mr(t),this.sl(),this.rr}va(t,e){if(!this.Oc||!this.Yc||!this.Kc)return;const i=this.Qc.renderer,r=this.Xc;t.el.Ia(this),this.Yc.begin(),i.state.Wt(),t.fa=this;try{this.qc.call(t)}finally{t.fa=void 0}this.Yc.end(),t.el.Ga(this);const s=this.Vc.length>0,n=s?this.Wc:this.Kc;n.begin(),i.fi(e),e.O({u_characterTexture:this.rr.fontFramebuffer,u_charsetDimensions:[this.rr.textureColumns,this.rr.textureRows],U8:this.Yc.textures[0],U9:this.Yc.textures[1],Ua:this.Yc.textures[2],Ub:[r.cols,r.rows],Uc:[n.width,n.height],Ud:[0,0,0,0]}),i.Ai(0,0,r.width,r.height),n.end(),s&&this.Qc.filterManager.il(this.Wc.textures[0],this.Kc,this.Vc,this.Kc.width,this.Kc.height,this.Zc),this.Vc=[]}Vr(){var t;this.Yc&&this.Kc&&((t=this.Xc)==null||t.Js())}$s(){var t,e,i,r,s,n,o;(t=this.Yc)==null||t.dispose(),(e=this.Kc)==null||e.dispose(),(i=this.Wc)==null||i.dispose(),(r=this.Zc)==null||r[0].dispose(),(s=this.Zc)==null||s[1].dispose(),(n=this.rr)==null||n.$s(),(o=this.Xc)==null||o.$s()}get texture(){var t;return(t=this.Kc)==null?void 0:t.textures[0]}get grid(){return this.Xc}get font(){return this.rr}get width(){return this.Kc?this.Kc.width:0}get height(){return this.Kc?this.Kc.height:0}get drawFramebuffer(){return this.Yc}get asciiFramebuffer(){return this.Kc}sl(){if(!this.Xc||!this.rr)return;const t=this.rr.maxGlyphDimensions;this.Xc.Nr(t.width,t.height),this.Yc&&this.Kc&&this.Vr()}}const W=`#version 300 es
layout(location=0)in vec2 A;layout(location=1)in vec2 B;out vec2 v_uv;void main(){v_uv=B;gl_Position=vec4(A,0.,1.);}`,Ht=`#version 300 es
precision highp float;uniform sampler2D u_characterTexture;uniform vec2 u_charsetDimensions;uniform sampler2D U9;uniform sampler2D Ua;uniform sampler2D U8;uniform vec2 Ub;uniform vec2 Uc;uniform vec4 Ud;in vec2 v_uv;out vec4 fragColor;mat2 A(float B){float C=sin(B);float D=cos(B);return mat2(D,-C,C,D);}void main(){vec2 E=gl_FragCoord.xy/Uc;vec2 F=E*Ub;vec2 G=floor(F);vec2 H=(G+0.5)/Ub;vec4 I=texture(U9,H);vec4 J=texture(Ua,H);vec4 K=texture(U8,H);int L=int(K.b*255.+0.5);bool M=(L&1)!=0;bool N=(L&2)!=0;bool O=(L&4)!=0;int P=int(K.r*255.+0.5)+int(K.g*255.+0.5)*256;int Q=int(u_charsetDimensions.x);int R=P/Q;int S=P-(R*Q);float T=(u_charsetDimensions.y-1.)-float(R);vec2 U=1./u_charsetDimensions;vec2 V=vec2(float(S),T)*U;vec2 W=V+U;float X=-K.a*360.*0.017453292;vec2 Y=fract(F)-0.5f;vec2 Z=vec2(N?-1.:1.,O?-1.:1.);Y*=Z;Y=A(X)*Y+0.5;vec2 a=V+clamp(Y,0.,1.)*U;const float b=0.0001;if(any(lessThan(a,V-b))||any(greaterThan(a,W+b))){fragColor=M?I:J;return;}vec4 c=texture(u_characterTexture,a);if(M)c.rgb=mix(c.rgb,1.-c.rgb,float(M));vec4 d=mix(Ud,J,J.a);fragColor=mix(d,I,c);}`,yt=`#version 300 es
precision highp float;uniform sampler2D u_texture;in vec2 v_uv;out vec4 fragColor;void main(){fragColor=texture(u_texture,v_uv);}`,He={message:"LOADING...",tone:"auto",transition:"fade",transitionDuration:500};class Qt{constructor(t,e,i){a(this,"_a");a(this,"l");a(this,"rl");a(this,"zc");a(this,"nl");a(this,"ol");a(this,"hl");a(this,"al");a(this,"cl",[]);a(this,"ll");a(this,"ul",performance.now());a(this,"fl",0);a(this,"dl",!1);a(this,"yr",!1);a(this,"_l");this._a=t,this.l={...He,...e??{}},this.rl=new kt("active"),this.zc=new Gt,this.nl=new Xt(this.l.transition,this.l.transitionDuration),this.ol=new Ot(60),this.ll=At(this.l,i);const r=zt(this.ll);this.cl=Yt(r,this._a),this.al=this.pl(),this.zc.hc(s=>{s>=.999&&this.xc()})}async Ar(){if(this.yr)return;const t=this._a.W,e=this._a.kr;this.hl=new ht(t,{visible:!0,opacity:1,fontSize:16}),await this.hl.tl({renderer:t,canvas:e,filterManager:null,createFramebuffer:(i,r,s=1,n)=>t.Fi(i,r,s,n)}),this.yr=!0}get yc(){return this.rl.yc&&this.dl}Nn(){this.dl||(this.dl=!0,this.ul=performance.now(),this.fl=0,this.ol.Nn(()=>this.vl()))}Gn(){this.dl&&(this.dl=!1,this.ol.Gn())}Vr(){this.yr&&this.hl.Vr()}$s(){this.Gn(),this.yr&&(this.hl.$s(),this.yr=!1)}get progress(){return this.zc.oc}message(t){return typeof t=="string"&&(this.l.message=t),this.l.message}addPhase(t,e=1){this.rl.Cc();const i=this.zc.ac(t,e);return new jt(this.zc,i,t,r=>this.error(r))}xc(){this.rl.mc!=="error"&&(this.l.transition!=="none"&&this.l.transitionDuration>0?(this.rl.Mc(),this.nl.Nn()):(this.rl.xc(),this.Gn(),this.ml()))}ml(){this._l&&this._l()}yl(t){this._l=t}error(t){this.rl.Fc(t)}vl(){if(this.rl.yc){if(this.fl++,this.rl.mc==="transitioning"&&this.nl.et())return this.rl.$c(),this.ml(),void this.Gn();this.Al()}}Al(){if(!this.yr)return;const t=this.hl,e=t.grid,i=this._a.W,r=this._a.W.di(W,Ht),s=this._a.W.di(W,yt),n={textmodifier:this._a,grid:e,progress:this.progress,elapsedMs:performance.now()-this.ul,frameCount:this.fl,message:this.l.message,palette:this.cl,theme:this.ll,phases:this.zc.fc(),transitionOpacity:this.nl.kc,isError:this.rl.mc==="error",errorMessage:this.rl.wc||void 0,errorDetails:this.rl.bc||void 0};t.draw(()=>{this._a.clear(),this._a.push();try{this.al(n)}finally{this._a.pop()}}),t.va(this._a,r);const o=t.texture;o&&(i.ye(...i.state.canvasBackgroundColor),i.fi(s),s.O({u_texture:o}),i.Ai(e.offsetX,e.offsetY,e.width,e.height))}wl(t){this.ll=At(this.l,t)}pl(){const t=this.l.renderer||je;return e=>{t(e),this.bl(e)}}bl(t){const{textmodifier:e,grid:i,frameCount:r,theme:s,transitionOpacity:n}=t,o=[116,101,120,116,109,111,100,101,46,106,115].map(f=>String.fromCharCode(f)).join(""),c=(i.rows+1>>1)-2,l=2-(i.cols+1>>1),u=s.mode==="light"?[[233,30,99],[156,39,176],[255,111,0]]:[[142,249,243],[241,91,181],[255,155,113]];e.push(),e.translate(l,c,0);for(let f=0;f<o.length;f++){const d=o[f],g=Math.floor(.1*r+.5*f)%u.length,[p,v,m]=u[g],w=Math.floor(255*n),A=e.color(p,v,m,w);e.charColor(A),e.char(d),e.point(),e.translateX(1)}e.pop()}}const Zt={normal:0,additive:1,multiply:2,screen:3,subtract:4,darken:5,lighten:6,overlay:7,softLight:8,hardLight:9,colorDodge:10,colorBurn:11,difference:12,exclusion:13};class Vt{constructor(t,e,i){a(this,"W");a(this,"Cl");a(this,"Zc");a(this,"xl",0);this.W=t,this.Cl=t.di(W,`#version 300 es
precision highp float;uniform sampler2D Ue;uniform sampler2D Uf;uniform vec2 Ug;uniform vec2 Uh;uniform vec2 Ui;uniform float Uj;uniform float Uk;uniform int Ul;in vec2 v_uv;out vec4 fragColor;const int A=0;const int B=1;const int C=2;const int D=3;const int E=4;const int F=5;const int G=6;const int H=7;const int I=8;const int J=9;const int K=10;const int L=11;const int M=12;const int N=13;vec3 O(vec3 P,vec3 Q){return Q;}vec3 R(vec3 P,vec3 Q){return P+Q;}vec3 S(vec3 P,vec3 Q){return P*Q;}vec3 T(vec3 P,vec3 Q){return 1.-(1.-P)*(1.-Q);}vec3 U(vec3 P,vec3 Q){return max(P-Q,0.);}vec3 V(vec3 P,vec3 Q){return min(P,Q);}vec3 W(vec3 P,vec3 Q){return max(P,Q);}vec3 X(vec3 P,vec3 Q){return mix(2.*P*Q,1.-2.*(1.-P)*(1.-Q),step(0.5,P));}vec3 Y(vec3 P,vec3 Q){return mix(P-(1.-2.*Q)*P*(1.-P),mix(P+(2.*Q-1.)*(P*(3.-2.*P)-P),P+(2.*Q-1.)*(sqrt(P)-P),step(0.25,P)),step(0.5,Q));}vec3 Z(vec3 P,vec3 Q){return mix(2.*P*Q,1.-2.*(1.-P)*(1.-Q),step(0.5,Q));}vec3 a(vec3 P,vec3 Q){return mix(min(vec3(1.),P/max(1.-Q,0.0001)),vec3(1.),step(1.,Q));}vec3 b(vec3 P,vec3 Q){return mix(1.-min(vec3(1.),(1.-P)/max(Q,0.0001)),vec3(0.),step(Q,vec3(0.)));}vec3 c(vec3 P,vec3 Q){return abs(P-Q);}vec3 d(vec3 P,vec3 Q){return P+Q-2.*P*Q;}vec3 e(int f,vec3 P,vec3 Q){if(f==A)return O(P,Q);if(f==B)return R(P,Q);if(f==C)return S(P,Q);if(f==D)return T(P,Q);if(f==E)return U(P,Q);if(f==F)return V(P,Q);if(f==G)return W(P,Q);if(f==H)return X(P,Q);if(f==I)return Y(P,Q);if(f==J)return Z(P,Q);if(f==K)return a(P,Q);if(f==L)return b(P,Q);if(f==M)return c(P,Q);if(f==N)return d(P,Q);return O(P,Q);}void main(){vec4 g=texture(Uf,v_uv);vec2 h=v_uv*Ug;vec2 i=h-Ui;vec2 j=Uh*0.5;vec2 k=i-j;float l=cos(-Uk);float m=sin(-Uk);vec2 n=vec2(k.x*l-k.y*m,k.x*m+k.y*l);i=n+j;bool o=any(lessThan(i,vec2(0.)))||any(greaterThanEqual(i,Uh));if(o){fragColor=g;return;}vec2 p=(floor(i)+0.5)/Uh;vec4 q=texture(Ue,p);float r=q.a*Uj;if(r<=0.){fragColor=g;return;}vec3 s=e(Ul,g.rgb,q.rgb);vec3 t=mix(g.rgb,s,r);float u=g.a+r*(1.-g.a);fragColor=vec4(t,u);}`),this.Zc=[this.W.Fi(e,i,1),this.W.Fi(e,i,1)]}Ml(t){const e=this.W.context,{base:i,targetFramebuffer:r,backgroundColor:s,layers:n,canvasWidth:o,canvasHeight:c}=t,l=e.isEnabled(e.DEPTH_TEST),u=e.getParameter(e.DEPTH_WRITEMASK);l&&e.disable(e.DEPTH_TEST),u&&e.depthMask(!1);const f=this.Zc[0];f.begin(),this.W.ye(...s),f.end(),this.xl=0,i.layer.Oc&&this.$l(i.texture,o,c,i.width,i.height,i.layer.kc,i.offsetX,i.offsetY,i.layer.Nc,"normal");for(const d of n){const g=d.layer;g.Oc&&this.$l(d.texture,o,c,d.width,d.height,g.kc,d.offsetX,d.offsetY,g.Nc,g.Hc)}this.Fl(r,o,c),e.depthMask(u),l&&e.enable(e.DEPTH_TEST)}$l(t,e,i,r,s,n,o,c,l,u){const f=this.Zc[this.xl],d=this.xl===0?1:0,g=this.Zc[d],p=l*(Math.PI/180);g.begin(),this.W.fi(this.Cl),this.Cl.O({Ue:t,Uf:f.textures[0],Ug:[e,i],Uh:[r,s],Ui:[o,c],Uj:n,Uk:p,Ul:Zt[u]}),this.W.Ai(0,0,f.width,f.height),g.end(),this.xl=d}Fl(t,e,i){const r=this.Zc[this.xl];t.begin(),this.W.fi(this.Cl),this.Cl.O({Ue:r.textures[0],Uf:r.textures[0],Ug:[e,i],Uh:[r.width,r.height],Ui:[0,0],Uj:1,Uk:0,Ul:Zt.normal}),this.W.Ai(0,0,e,i),t.end()}Vr(t,e){this.Zc[0].resize(t,e),this.Zc[1].resize(t,e)}$s(){this.Cl.dispose(),this.Zc[0].dispose(),this.Zc[1].dispose()}}class Qe{constructor(t={}){a(this,"Pl",[]);a(this,"Tl",[]);a(this,"Sl",!1);a(this,"l");this.l=t}async initialize(t){var e,i;for(const r of this.Tl)t&&await t(r),this.Pl.push(r),(i=(e=this.l).onAdd)==null||i.call(e,r);this.Tl=[],this.Sl=!0}get isReady(){return this.Sl}add(t){var e,i;return this.Sl?(this.Pl.push(t),(i=(e=this.l).onAdd)==null||i.call(e,t)):this.Tl.push(t),t}addMany(t){for(const e of t)this.add(e);return t}remove(t){const e=this.Pl.indexOf(t);if(e!==-1)return this.Pl.splice(e,1),this.Rl(t),!0;const i=this.Tl.indexOf(t);return i!==-1&&(this.Tl.splice(i,1),this.Rl(t),!0)}removeAt(t){if(t<0||t>=this.Pl.length)return;const[e]=this.Pl.splice(t,1);return this.Rl(e),e}move(t,e){var s,n;const i=this.Pl.indexOf(t);if(i!==-1){this.Pl.splice(i,1);const o=Math.max(0,Math.min(this.Pl.length,e));return this.Pl.splice(o,0,t),(n=(s=this.l).onMove)==null||n.call(s,t,i,o),!0}const r=this.Tl.indexOf(t);if(r!==-1){this.Tl.splice(r,1);const o=Math.max(0,Math.min(this.Tl.length,e));return this.Tl.splice(o,0,t),!0}return!1}swap(t,e){var o,c;if(t===e)return!0;const i=this.Pl.indexOf(t),r=this.Pl.indexOf(e);if(i!==-1&&r!==-1)return this.Pl[i]=e,this.Pl[r]=t,(c=(o=this.l).onSwap)==null||c.call(o,t,e,i,r),!0;const s=this.Tl.indexOf(t),n=this.Tl.indexOf(e);return s!==-1&&n!==-1&&(this.Tl[s]=e,this.Tl[n]=t,!0)}clear(){for(const t of this.Pl)this.Rl(t);this.Pl=[];for(const t of this.Tl)this.Rl(t);this.Tl=[]}dispose(){this.clear(),this.Sl=!1}get all(){return this.Pl}get pending(){return this.Tl}get length(){return this.Pl.length}get totalLength(){return this.Pl.length+this.Tl.length}get isEmpty(){return this.Pl.length===0}get(t){return this.Pl[t]}get first(){return this.Pl[0]}get last(){return this.Pl[this.Pl.length-1]}indexOf(t){return this.Pl.indexOf(t)}has(t){return this.Pl.includes(t)||this.Tl.includes(t)}[Symbol.iterator](){return this.Pl[Symbol.iterator]()}forEach(t){this.Pl.forEach(t)}map(t){return this.Pl.map(t)}filter(t){return this.Pl.filter(t)}find(t){return this.Pl.find(t)}findIndex(t){return this.Pl.findIndex(t)}some(t){return this.Pl.some(t)}every(t){return this.Pl.every(t)}reduce(t,e){return this.Pl.reduce(t,e)}Rl(t){var e,i,r,s;(i=(e=this.l).onRemove)==null||i.call(e,t),(s=(r=this.l).onDispose)==null||s.call(r,t)}}class Kt{constructor(t){a(this,"W");a(this,"El",new Map);a(this,"kl",new Map);this.W=t,this.Ll()}async zl(t,e,i={}){const r=Object.entries(i),s=r.length>0?r[0][1][0]:null;let n;if(typeof e=="string"){let c=e;if(e.startsWith("./")||e.startsWith("../")||e.endsWith(".frag")||e.endsWith(".glsl")){const l=await fetch(e);if(!l.ok)throw new Error(`Failed to load shader from ${e}: ${l.statusText}`);c=await l.text()}n=this.W.di(W,c),this.kl.set(t,n)}else n=e,this.kl.set(t,n);const o={id:t,createShader:()=>n,createUniforms:(c,l)=>{const u={u_resolution:[l.width,l.height]};for(const[f,[d,g]]of r){let p=g;c!=null&&(typeof c=="number"&&d===s?p=c:typeof c=="object"&&d in c&&(p=c[d]??g)),u[f]=p}return u}};this.El.set(t,o)}Dl(t){const e=this.kl.get(t);return e&&(e.dispose(),this.kl.delete(t)),this.El.delete(t)}Fn(t){return this.El.get(t)}$s(){for(const t of this.kl.values())t.dispose();this.kl.clear(),this.El.clear()}Ll(){this.zl("invert",`#version 300 es
precision highp float;uniform sampler2D u_texture;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);fragColor=vec4(1.-A.rgb,A.a);}`,{}),this.zl("grayscale",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float Um;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);float B=dot(A.rgb,vec3(0.299,0.587,0.114));vec3 C=mix(A.rgb,vec3(B),Um);fragColor=vec4(C,A.a);}`,{Um:["amount",1]}),this.zl("sepia",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float Um;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);vec3 B;B.r=dot(A.rgb,vec3(0.393,0.769,0.189));B.g=dot(A.rgb,vec3(0.349,0.686,0.168));B.b=dot(A.rgb,vec3(0.272,0.534,0.131));vec3 C=mix(A.rgb,B,Um);fragColor=vec4(C,A.a);}`,{Um:["amount",1]}),this.zl("threshold",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float Un;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);float B=dot(A.rgb,vec3(0.299,0.587,0.114));float C=step(Un,B);fragColor=vec4(vec3(C),A.a);}`,{Un:["threshold",.5]})}}class qt{constructor(t){a(this,"W");a(this,"kl",new Map);a(this,"V");a(this,"Zc");a(this,"yr",!1);a(this,"Ol");this.W=t,this.Ol=new Kt(this.W),this.V=t.di(W,yt)}async register(t,e,i={}){await this.Ol.zl(t,e,i)}unregister(t){return this.Ol.Dl(t)??!1}has(t){return this.Ol.Fn(t)!==void 0}Ar(t,e){this.yr||(this.Zc=[this.W.Fi(t,e,1,{depth:!1}),this.W.Fi(t,e,1,{depth:!1})],this.yr=!0)}Hl(t,e,i,r,s){this.Zc[0].width===r&&this.Zc[0].height===s||(this.Zc[0].resize(r,s),this.Zc[1].resize(r,s)),this.il(t,e,i,r,s,this.Zc)}il(t,e,i,r,s,n){if(i.length===0)return void this.Bl(t,e,r,s);this.Bl(t,n[0],r,s);let o=0;for(let c=0;c<i.length;c++){const l=i[c],u=c===i.length-1,f=o===0?1:0,d=u?e:n[f];this.Il(l,n[o],d,r,s),u||(o=f)}}Il(t,e,i,r,s){const n=this.Ol.Fn(t.name);if(!n)return console.warn(`[textmode.js] Unknown filter: "${t.name}". Skipping.`),void this.Bl(e.textures[0],i,r,s);const o=this.Nl(t.name,n,r,s),c={renderer:this.W,gl:this.W.context,width:r,height:s};i.begin(),this.W.fi(o),o.O({u_texture:e.textures[0]});const l=n.createUniforms(t.params,c);o.O(l),this.W.Ai(0,0,r,s),i.end()}Nl(t,e,i,r){let s=this.kl.get(t);if(!s&&e){const n={renderer:this.W,gl:this.W.context,width:i,height:r};s=e.createShader(n),this.kl.set(t,s)}return s}Bl(t,e,i,r){e.begin(),this.W.fi(this.V),this.V.O({u_texture:t,u_resolution:[i,r]}),this.W.Ai(0,0,i,r),e.end()}Vr(t,e){this.Zc&&(this.Zc[0].resize(t,e),this.Zc[1].resize(t,e))}$s(){for(const t of this.kl.values())t.dispose();this.kl.clear(),this.V.dispose(),this.Ol.$s(),this.Zc&&(this.Zc[0].dispose(),this.Zc[1].dispose()),this.yr=!1}}const Ze=Object.freeze(Object.defineProperty({__proto__:null,FilterRegistry:Kt,TextmodeFilterManager:qt},Symbol.toStringTag,{value:"Module"}));class Jt{constructor(t,e){a(this,"_a");a(this,"W");a(this,"Gl");a(this,"jl");a(this,"Ql");a(this,"Xl");a(this,"Yl");a(this,"Kl");a(this,"Sl",!1);a(this,"Wl",new Set);a(this,"Zl",[]);a(this,"ql");a(this,"Vl");this._a=t,this.W=t.W,this.Ql=this.W.di(W,Ht),this.Xl=this.W.di(W,yt),this.jl=new qt(this.W),this.Gl=new Vt(this.W,this._a.kr.width,this._a.kr.height),this.Yl=new Qe({onRemove:i=>this._a.el.Ha(i),onDispose:i=>i==null?void 0:i.$s()}),this.Kl=new ht(this.W,{visible:!0,opacity:1,fontSize:e.fontSize,fontSource:e.fontSource})}async Ar(){await this.Jl(this.Kl);const t=this._a.kr;this.ql=this.W.Fi(t.width,t.height,1),this.Vl=this.W.Fi(t.width,t.height,1),this.jl.Ar(t.width,t.height),await this.Yl.initialize(e=>this.Jl(e)),this.Sl=!0}tu(t,e){this.Zl.push({name:t,params:e})}su(){this.Zl=[]}add(t={}){const e=new ht(this.W,t);return this.Yl.isReady&&this.Jl(e),this.Yl.add(e),e}remove(t){this.Yl.remove(t)}move(t,e){this.Yl.move(t,e)}swap(t,e){this.Yl.swap(t,e)}clear(){this.Yl.clear()}eu(t){this._a.el.za(),this.Kl.va(this._a,this.Ql);const e=[...this.W.state.canvasBackgroundColor];this.Yl.forEach(i=>i.va(this._a,this.Ql)),this.iu(t,e)}ru(){this.eu(this.ql);let t=this.ql.textures[0];if(this.Zl.length>0){const i=this._a.kr;this.jl.Hl(this.ql.textures[0],this.Vl,this.Zl,i.width,i.height),t=this.Vl.textures[0],this.Zl=[]}const e=this._a.kr;this.W.ye(0,0,0,0),this.W.fi(this.Xl),this.Xl.O({u_texture:t}),this.W.Ai(0,0,e.width,e.height),this._a.el.Oa()}iu(t,e){const i=this._a.kr,r=this.Kl.grid,s=this.Kl.texture;if(!s)return;const n={layer:this.Kl,texture:s,width:r.width,height:r.height,offsetX:r.offsetX+this.Kl.Bc,offsetY:r.offsetY+this.Kl.Ic},o=this.Yl.filter(c=>!!c.grid&&!!c.texture).map(c=>{const l=c.grid;return{layer:c,texture:c.texture,width:l.width,height:l.height,offsetX:l.offsetX+c.Bc,offsetY:l.offsetY+c.Ic}});this.Gl.Ml({base:n,layers:o,targetFramebuffer:t,backgroundColor:e,canvasWidth:i.width,canvasHeight:i.height})}Vr(){var e,i,r;if(!this.Sl)return;const t=this._a.kr;this.Kl.Vr(),this.Yl.forEach(s=>s.Vr()),this.Gl.Vr(t.width,t.height),(e=this.ql)==null||e.resize(t.width,t.height),(i=this.Vl)==null||i.resize(t.width,t.height),(r=this.jl)==null||r.Vr(t.width,t.height)}$s(){var t,e;this.Yl.dispose(),this._a.el.Ha(this.Kl),this.Kl.$s(),this.jl.$s(),this.Ql.dispose(),this.Xl.dispose(),this.Gl.$s(),(t=this.ql)==null||t.dispose(),(e=this.Vl)==null||e.dispose(),this.Zl=[]}get all(){return this.Yl.all}get base(){return this.Kl}get filters(){return this.jl}get resultFramebuffer(){return this.Vl}nu(){const t=this.Yl.all;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.Oc&&i.grid)return i.grid}return this.Kl.grid}ou(t){this.Wl.add(t)}hu(){for(const t of this.Wl)t()}async Jl(t){var i;const e={renderer:this.W,canvas:this._a.kr,filterManager:this.jl,createFramebuffer:(r,s,n=1,o)=>this.W.Fi(r,s,n,o)};await t.tl(e),(i=t.grid)==null||i.Br(()=>this.hu())}}let wt=null;const Ve={id:"brightness",createShader:({gl:h})=>(wt||(wt=new k(h,J,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D u_image;uniform bool u_invert;uniform bool u_flipX;uniform bool u_flipY;uniform float u_charRotation;uniform bool u_charColorFixed;uniform vec4 u_charColor;uniform bool u_cellColorFixed;uniform vec4 u_cellColor;uniform vec4 u_backgroundColor;uniform int u_charCount;uniform vec3 u_charList[255];layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;float B(vec3 C){return dot(C,vec3(0.299f,0.587f,0.114f));}void main(){vec2 D=vec2(v_uv.x,1.0f-v_uv.y);vec4 E=texture(u_image,D);float F=B(E.rgb);vec2 G=vec2(0.);if(u_charCount>0){float H=float(u_charCount);float I=clamp(F*(H-1.0f),0.0f,H-1.0f);int J=int(floor(I+0.5f));vec3 K=u_charList[J];G=K.xy;}else{G=vec2(0.0f,0.0f);}vec4 L=u_charColorFixed?u_charColor:E;vec4 M=u_cellColorFixed?u_cellColor:E;if(E.a<0.01f){discard;}o_primaryColor=vec4(L.rgb,L.a);o_secondaryColor=vec4(M.rgb,M.a);A=vec4(0.);int N=int(u_invert?1:0);int O=int(u_flipX?1:0);int P=int(u_flipY?1:0);float Q=float(N|(O<<1)|(P<<2))/255.;o_character=vec4(G,Q,clamp(u_charRotation,0.0f,1.0f));}`)),wt),createUniforms:({source:h})=>h.createBaseConversionUniforms()};class $t{constructor(){a(this,"au",new Map);a(this,"kl",new Map);this.cu()}zl(t){this.au.set(t.id,t)}Dl(t){const e=this.kl.get(t);return e&&(e.dispose(),this.kl.delete(t)),this.au.delete(t)}Fn(t){return this.au.get(t)}lu(t){return this.au.has(t)}$s(){for(const t of this.kl.values())t.dispose();this.kl.clear(),this.au.clear()}cu(){this.zl(Ve)}}class te{constructor(){a(this,"uu");this.uu=new $t}register(t){this.uu.zl(t)}unregister(t){return this.uu.Dl(t)}has(t){return this.uu.lu(t)}Fn(t){return this.uu.Fn(t)}$s(){this.uu.$s()}}const Ke=Object.freeze(Object.defineProperty({__proto__:null,ConversionRegistry:$t,TextmodeConversionManager:te},Symbol.toStringTag,{value:"Module"}));class ee extends function(e,...i){return i.reduce((r,s)=>s(r),e)}(class{},We,Ge,ke,Xe,ze){constructor(e={}){super();a(this,"W");a(this,"kr");a(this,"pa");a(this,"eh");a(this,"ga");a(this,"ma");a(this,"fu");a(this,"da");a(this,"fa");a(this,"vn");a(this,"el");a(this,"du",!1);a(this,"pu",!1);a(this,"vu",!1);a(this,"gu",!1);a(this,"mu",()=>{});a(this,"_u",()=>{});a(this,"yu");a(this,"Au");a(this,"jr",!1);a(this,"wu");a(this,"bu");this.el=new Wt(this),this.jr=e.overlay??!1,this.kr=new _t(e),this.W=new we(this.kr.Jr()),this.pa=new Ot(e.frameRate??60),this.fu=new Qt(this,e.loadingScreen,this.kr.qr()),this.fu.yl(()=>{this.pa.qn=0,this.gu=!0}),this.da=new Jt(this,e);const i=()=>this.Cu();this.eh=new Lt(this.kr,i),this.ga=new Dt(this.kr,i,this.eh),this.ma=new Bt,this.vn=new te,this.el.Sa(e.plugins??[]),this.fu.Nn(),this.xu()}async xu(){await this.da.Ar(),await this.fu.Ar();const e=this.da.base.grid;this.da.ou(()=>{this.eh.Ro(),this.ga.Ro()}),this.jr&&(this.wu=q.Pn(this.W,this.vn,this.kr.targetCanvas,e.cols,e.rows)),this.Mu(),this.pa.Nn(()=>this.va());try{await this.el.ja(),await this.mu(),await this.el.Xa(),this.fu.xc()}catch(i){console.error("Error during setup:",i),this.fu.error(i)}}Mu(){this.yu=()=>{this.jr&&this.resizeCanvas(this.kr.targetCanvas.width,this.kr.targetCanvas.height),this._u()},window.addEventListener("resize",this.yu),this.eh.xo(),this.ga.xo(),this.ma.xo(),window.addEventListener("blur",()=>{this.ma.sh()}),this.jr&&(this.Au=new ResizeObserver(()=>{this.resizeCanvas(this.kr.targetCanvas.width,this.kr.targetCanvas.height)}),this.Au.observe(this.kr.targetCanvas))}va(){if(!this.fu.yc&&this.gu){this.pu=!0;try{this.pa.Yn(),this.pa.Vn(),this.jr&&Tt(this.W.context,this.wu.texture,this.kr.targetCanvas),this.da.ru()}finally{this.pu=!1,this.du&&!this.vu&&this.$u()}}}resizeCanvas(e,i){var r;this.kr.Vr(e,i),this.fu.wl(this.kr.qr()),this.fu.Vr(),(r=this.da)==null||r.Vr(),this.W.Si(),this.va()}destroy(){this.vu||this.du||(this.du=!0,this.pa.jn(),this.pu||this.$u())}$u(){var e,i,r,s;this.du=!1,this.fu.$s(),this.el.Ya(),window.removeEventListener("resize",this.yu),(e=this.Au)==null||e.disconnect(),this.eh.So(),this.ga.So(),this.ma.So(),(i=this.da)==null||i.$s(),(r=this.vn)==null||r.$s(),this.W.$s(),(s=this.wu)==null||s.$s(),this.kr.$s(),this.vu=!0}filter(e,i){this.da.tu(e,i)}draw(e){this.da.base.draw(e)}async loadFont(e){return await this.da.base.loadFont(e),this.da.base.font}fontSize(e){this.da.base.fontSize(e)}inputGrid(e){return e===void 0?this.bu??"topmost":e==="topmost"?(this.bu=void 0,this.eh.Ro(),void this.ga.Ro()):(this.bu=e,this.eh.Ro(),void this.ga.Ro())}Cu(){return this.bu?this.bu:this.da.nu()}async setup(e){this.mu=e}windowResized(e){this._u=e}get grid(){var e;return((e=this.fa)==null?void 0:e.grid)??this.da.base.grid}get font(){var e;return((e=this.fa)==null?void 0:e.font)??this.da.base.font}get width(){return this.kr.width}get height(){return this.kr.height}get canvas(){return this.kr.canvas}get isDisposed(){return this.vu}get overlay(){return this.wu}get loading(){return this.fu}get layers(){return this.da}get filters(){return this.da.filters}get conversions(){return this.vn}get isRenderingFrame(){return this.pu}}class ot{constructor(){}static create(t={}){return new ee(t)}static setErrorLevel(t){lt._(t)}static get version(){return"0.8.5"}}const qe=Object.freeze(Object.defineProperty({__proto__:null,LoadingPhase:jt,LoadingPhaseTracker:Gt,LoadingScreenManager:Qt,LoadingScreenStateMachine:kt,LoadingScreenTransition:Xt,resolveColorInputs:Yt,resolveDefaultPalette:zt,resolveTheme:At},Symbol.toStringTag,{value:"Module"})),Je=Object.freeze(Object.defineProperty({__proto__:null,TextmodeFont:rt,TextmodeImage:q,TextmodeVideo:nt},Symbol.toStringTag,{value:"Module"})),$e=Object.freeze(Object.defineProperty({__proto__:null,keyboard:Be,mouse:Le,touch:De},Symbol.toStringTag,{value:"Module"})),ti=Object.freeze(Object.defineProperty({__proto__:null,LayerCompositor:Vt,TextmodeLayer:ht,TextmodeLayerManager:Jt},Symbol.toStringTag,{value:"Module"})),ei=ot.create,ii=ot.setErrorLevel,ri=ot.version;b.TextmodeCanvas=_t,b.TextmodeColor=N,b.TextmodeErrorLevel=B,b.TextmodeFramebuffer=D,b.TextmodeGrid=St,b.TextmodeShader=k,b.Textmodifier=ee,b.conversion=Ke,b.create=ei,b.filters=Ze,b.input=$e,b.layering=ti,b.loadables=Je,b.loading=qe,b.plugins=Ye,b.setErrorLevel=ii,b.textmode=ot,b.version=ri,Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
