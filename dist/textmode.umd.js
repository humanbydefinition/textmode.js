(function(x,R){typeof exports=="object"&&typeof module<"u"?R(exports):typeof define=="function"&&define.amd?define(["exports"],R):R((x=typeof globalThis<"u"?globalThis:x||self).textmode={})})(this,function(x){"use strict";var us=Object.defineProperty;var fs=(x,R,O)=>R in x?us(x,R,{enumerable:!0,configurable:!0,writable:!0,value:O}):x[R]=O;var o=(x,R,O)=>fs(x,typeof R!="symbol"?R+"":R,O);class R extends Error{constructor(t,i){super(R.i(t,i)),this.name="TextmodeError"}static i(t,i){return`${t}${i&&Object.keys(i).length>0?`

ðŸ“‹ Context:${Object.entries(i).map(([s,e])=>`
  - ${s}: ${R.h(e)}`).join("")}`:""}

${"â†“".repeat(24)}
`}static h(t){if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return`"${t}"`;if(typeof t=="number"||typeof t=="boolean")return String(t);if(Array.isArray(t))return t.length===0?"[]":t.length<=5?`[${t.map(i=>R.h(i)).join(", ")}]`:`[${t.slice(0,3).map(i=>R.h(i)).join(", ")}, ... +${t.length-3} more]`;if(typeof t=="object"){const i=Object.keys(t);return i.length===0?"{}":i.length<=3?`{ ${i.map(s=>`${s}: ${R.h(t[s])}`).join(", ")} }`:`{ ${i.slice(0,2).map(s=>`${s}: ${R.h(t[s])}`).join(", ")}, ... +${i.length-2} more }`}return String(t)}}var O=(n=>(n[n.SILENT=0]="SILENT",n[n.WARNING=1]="WARNING",n[n.ERROR=2]="ERROR",n[n.THROW=3]="THROW",n))(O||{});const Y=class Y{constructor(){o(this,"l",{globalLevel:3})}static u(){return Y.o||(Y.o=new Y),Y.o}v(t,i){const s="%c[textmode.js] Oops! (â•¯Â°â–¡Â°)â•¯ï¸µ Something went wrong in your code.",e="color: #f44336; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px;";switch(this.l.globalLevel){case 0:return!1;case 1:return console.group(s,e),console.warn(R.i(t,i)),console.groupEnd(),!1;case 2:return console.group(s,e),console.error(R.i(t,i)),console.groupEnd(),!1;default:throw new R(t,i)}}m(t,i,s){return!!t||(this.v(i,s),!1)}_(t){this.l.globalLevel=t}};o(Y,"o",null);let vt=Y;const At=vt.u();class tt{constructor(){o(this,"A",new Set)}C(t){this.A.add(t)}dispose(){for(const t of this.A)t();this.A.clear()}}function k(n){return n*(Math.PI/180)}function it(n){return n*(180/Math.PI)}function Tt(n,t,i,s){return it(Math.atan2(s-t,i-n))}function st(n,t,i,s){return Math.hypot(i-n,s-t)}function I(n,t,i){return Math.min(Math.max(n,t),i)}function Mt(n){return(n%360+360)%360/360}function Ft(n,t){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,1),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function et(n,t,i){n.bindTexture(n.TEXTURE_2D,t),Ft(n,i),n.bindTexture(n.TEXTURE_2D,null)}function yt(n,t,i=n.NEAREST,s=n.NEAREST,e=n.CLAMP_TO_EDGE,r=n.CLAMP_TO_EDGE){const h=function(l,u,f=l.NEAREST,m=l.NEAREST,p=l.CLAMP_TO_EDGE,g=l.CLAMP_TO_EDGE){const d=l.createTexture();return l.bindTexture(l.TEXTURE_2D,d),Pt(l,f,m,p,g),Ft(l,u),l.bindTexture(l.TEXTURE_2D,null),d}(n,t,i,s,e,r),{width:a,height:c}=function(l){let u=0,f=0;return l instanceof HTMLVideoElement?(u=l.videoWidth,f=l.videoHeight):l instanceof HTMLImageElement?(u=l.naturalWidth,f=l.naturalHeight):l instanceof HTMLCanvasElement&&(u=l.width,f=l.height),{width:u,height:f}}(t);return{texture:h,width:a,height:c}}function Pt(n,t,i,s,e){n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,e)}function V(n,t,i,s,e,r=0,h=WebGL2RenderingContext.FLOAT,a=!1){n.enableVertexAttribArray(t),n.vertexAttribPointer(t,i,h,a,s,e),n.vertexAttribDivisor(t,r)}function Ct(n,t,i,s,e){n.bindBuffer(t,i),n.bufferData(t,s,e),n.bindBuffer(t,null)}class $ extends tt{constructor(i,s,e=s,r=1,h={},a){super();o(this,"M");o(this,"F");o(this,"l");o(this,"$");o(this,"P");o(this,"S",[]);o(this,"U",null);o(this,"k");o(this,"R");o(this,"L",null);o(this,"D",new Map);this.M=s,this.F=e,this.$=i,this.k=I(r,1,8),this.R=a,this.l={filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte",depth:!0,...h};const c=i.getParameter(i.MAX_DRAW_BUFFERS),l=i.getParameter(i.MAX_COLOR_ATTACHMENTS);this.k=Math.min(this.k,c,l),this.P=i.createFramebuffer(),this.O(),this.H(),this.l.depth&&this.I()}O(){const i=this.$,s=this.l.filter==="linear"?i.LINEAR:i.NEAREST,e=this.l.wrap==="repeat"?i.REPEAT:i.CLAMP_TO_EDGE;for(let r=0;r<this.k;r++){const h=i.createTexture();i.bindTexture(i.TEXTURE_2D,h),Pt(i,s,s,e,e),this.G(h,!1),this.S.push(h)}i.bindTexture(i.TEXTURE_2D,null)}G(i,s=!0){const e=this.$,r=this.l.type==="float"?e.FLOAT:e.UNSIGNED_BYTE,h=r===e.FLOAT?e.RGBA32F:e.RGBA8,a=e.RGBA;s&&e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,h,this.M,this.F,0,a,r,null)}H(){const i=this.$;if(i.bindFramebuffer(i.FRAMEBUFFER,this.P),this.k===1)i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.S[0],0);else{const s=[];for(let e=0;e<this.k;e++){const r=i.COLOR_ATTACHMENT0+e;i.framebufferTexture2D(i.FRAMEBUFFER,r,i.TEXTURE_2D,this.S[e],0),s.push(r)}i.drawBuffers(s)}i.bindFramebuffer(i.FRAMEBUFFER,null)}I(){const i=this.$;this.U=i.createRenderbuffer(),this.N(),i.bindFramebuffer(i.FRAMEBUFFER,this.P),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this.U),i.bindFramebuffer(i.FRAMEBUFFER,null)}N(){if(!this.U)return;const i=this.$;i.bindRenderbuffer(i.RENDERBUFFER,this.U),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT24,this.M,this.F),i.bindRenderbuffer(i.RENDERBUFFER,null)}j(i){et(this.$,this.S[0],i)}resize(i,s){this.M=i,this.F=s,this.D.clear();const e=this.$;for(const r of this.S)this.G(r,!0);e.bindTexture(e.TEXTURE_2D,null),this.N(),this.L=null}readPixels(i){const s=this.D.get(i);if(s)return s;const e=this.$,r=this.M,h=this.F,a=new Uint8Array(r*h*4),c=e.getParameter(e.READ_FRAMEBUFFER_BINDING);e.bindFramebuffer(e.READ_FRAMEBUFFER,this.P),e.readBuffer(e.COLOR_ATTACHMENT0+i),e.readPixels(0,0,r,h,e.RGBA,e.UNSIGNED_BYTE,a),e.bindFramebuffer(e.READ_FRAMEBUFFER,c);const l=4*r,u=new Uint8Array(a.length);for(let f=0;f<h;f++){const m=(h-1-f)*l,p=f*l;u.set(a.subarray(m,m+l),p)}return this.D.set(i,u),u}begin(){const i=this.$;this.D.clear(),this.R.X(),this.R.Y(this.P,this.M,this.F,this.k),this.l.depth&&i.clear(i.DEPTH_BUFFER_BIT),this.R.state.K()}end(){this.R.state.W(),this.R.Z(),this.R.q()}V(){return this.L||this.J(),this.L}J(){if(!this.R)return;const i=this.k>1,s=this.k>2,e=this.k>3,r={U0:this.S[0],U1:i?this.S[1]:this.S[0],U2:s?this.S[2]:this.S[0],U3:e?this.S[3]:this.S[0],U4:[this.M,this.F],U5:i,U6:s,U7:e},h=this.R.materialManager.tt;this.L=this.R.materialManager.et(h,r)}dispose(){const i=this.$;i.deleteFramebuffer(this.P),this.S.forEach(s=>{i.deleteTexture(s)}),this.U&&i.deleteRenderbuffer(this.U),super.dispose()}get width(){return this.M}get height(){return this.F}get framebuffer(){return this.P}get textures(){return this.S}get attachmentCount(){return this.k}}function X(n){return typeof n=="object"&&n!==null&&"textures"in n&&Array.isArray(n.textures)}function St(n){if(typeof n=="number"||typeof n=="boolean")return!0;if(Array.isArray(n)){if(n.length===0)return!0;const t=n[0];return typeof t=="number"||!!Array.isArray(t)}return n instanceof Float32Array||n instanceof Int32Array||!!X(n)||typeof WebGLTexture<"u"&&n instanceof WebGLTexture}class H extends tt{constructor(i,s,e){super();o(this,"$");o(this,"st");o(this,"it",new Map);o(this,"rt",new Map);o(this,"nt",new Map);o(this,"ht",0);o(this,"ot",new Map);o(this,"ct");this.$=i,this.ct=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)??16,this.st=this.lt(s,e),this.ut()}ut(){const i=this.$.getProgramParameter(this.st,this.$.ACTIVE_UNIFORMS);for(let s=0;s<i;s++){const e=this.$.getActiveUniform(this.st,s);if(e){const r=e.name.replace(/\[0\]$/,""),h=this.$.getUniformLocation(this.st,r);h&&(this.it.set(r,h),this.rt.set(r,{type:e.type,size:e.size}))}}}lt(i,s){const e=this.ft(this.$.VERTEX_SHADER,i),r=this.ft(this.$.FRAGMENT_SHADER,s),h=this.$.createProgram();if(!h)throw new Error("Failed to create WebGL program");if(this.$.attachShader(h,e),this.$.attachShader(h,r),this.$.linkProgram(h),!this.$.getProgramParameter(h,this.$.LINK_STATUS)){const a=this.$.getProgramInfoLog(h);throw new Error(`Shader program link error: ${a}`)}return this.$.deleteShader(e),this.$.deleteShader(r),h}ft(i,s){const e=this.$.createShader(i);if(!e)throw new Error(`Failed to create shader of type ${i}`);if(this.$.shaderSource(e,s),this.$.compileShader(e),!this.$.getShaderParameter(e,this.$.COMPILE_STATUS)){const r=this.$.getShaderInfoLog(e);throw this.$.deleteShader(e),new Error(`Shader compilation error: ${r}`)}return e}dt(){this.$.useProgram(this.st),this.vt()}vt(){this.ht=0,this.ot.clear();for(const[i,s]of this.nt)(s instanceof WebGLTexture||X(s))&&this.nt.delete(i)}gt(i){for(const s in i)this._t(s,i[s])}_t(i,s){const e=this.it.get(i);if(!e)return;const r=this.nt.get(i);let h=!0;if(r!==void 0&&(typeof s=="number"||typeof s=="boolean"?r===s&&(h=!1):(s instanceof WebGLTexture||X(s))&&r===s&&(h=!1)),!h)return;typeof s=="number"||typeof s=="boolean"||s instanceof WebGLTexture||X(s)?this.nt.set(i,s):this.nt.delete(i);const a=this.rt.get(i);if(!a)return;const{type:c,size:l}=a,u=this.$;if(s instanceof WebGLTexture){const f=this.yt(i);return u.uniform1i(e,f),u.activeTexture(u.TEXTURE0+f),void u.bindTexture(u.TEXTURE_2D,s)}if(X(s)){const f=this.yt(i);return u.uniform1i(e,f),u.activeTexture(u.TEXTURE0+f),void u.bindTexture(u.TEXTURE_2D,s.textures[0])}if(St(s),typeof s!="number")if(typeof s!="boolean")if(Array.isArray(s)&&Array.isArray(s[0])){const f=s.flat();switch(c){case u.FLOAT_VEC2:u.uniform2fv(e,f);break;case u.FLOAT_VEC3:u.uniform3fv(e,f);break;case u.FLOAT_VEC4:u.uniform4fv(e,f)}}else{const f=s;switch(c){case u.FLOAT:l>1?u.uniform1fv(e,f):u.uniform1f(e,f[0]);break;case u.FLOAT_VEC2:u.uniform2fv(e,f);break;case u.FLOAT_VEC3:u.uniform3fv(e,f);break;case u.FLOAT_VEC4:u.uniform4fv(e,f);break;case u.INT:l>1?u.uniform1iv(e,f):u.uniform1i(e,f[0]);break;case u.INT_VEC2:u.uniform2iv(e,f);break;case u.INT_VEC3:u.uniform3iv(e,f);break;case u.INT_VEC4:u.uniform4iv(e,f);break;case u.BOOL:u.uniform1iv(e,f);break;case u.FLOAT_MAT2:u.uniformMatrix2fv(e,!1,f);break;case u.FLOAT_MAT3:u.uniformMatrix3fv(e,!1,f);break;case u.FLOAT_MAT4:u.uniformMatrix4fv(e,!1,f)}}else u.uniform1i(e,s?1:0);else c===u.INT||c===u.BOOL?u.uniform1i(e,s):u.uniform1f(e,s)}yt(i){const s=this.ot.get(i);if(s!==void 0)return s;if(this.ht>=this.ct)throw new Error(`[textmode.js] Shader attempted to bind more than ${this.ct} texture samplers. Uniform "${i}" cannot be assigned.`);const e=this.ht++;return this.ot.set(i,e),e}get program(){return this.st}dispose(){this.$.deleteProgram(this.st),super.dispose()}}const Lt=new WeakMap;function wt(n,t){Lt.set(n,t)}function Nt(n){return Lt.get(n)}function rt(n,t,i,s,e=255){n[0]=t/255,n[1]=(i??t)/255,n[2]=(s??t)/255,n[3]=e/255}class nt{constructor(){o(this,"wt",1);o(this,"At",0);o(this,"bt",0);o(this,"Ct",0);o(this,"xt",0);o(this,"Mt",0);o(this,"Ft",0);o(this,"$t",[0,0,0]);o(this,"Pt","");o(this,"Tt",[1,1,1,1]);o(this,"St",[0,0,0,1]);o(this,"Et",!1);o(this,"kt",!1);o(this,"Rt",!1);o(this,"Lt",0);o(this,"Dt",[0,0,0,1]);o(this,"Ot",!1);o(this,"Ht",[]);o(this,"zt",[])}static Bt(){return{It:1,At:0,bt:0,Ct:0,xt:0,Mt:0,Ft:0,Lt:0,Gt:!1,Nt:!1,Rt:!1,Ot:!1,jt:[0,0,0],Qt:"",Xt:[1,1,1,1],Yt:[0,0,0,1]}}Kt(t){t.It=this.wt,t.At=this.At,t.bt=this.bt,t.Ct=this.Ct,t.xt=this.xt,t.Mt=this.Mt,t.Ft=this.Ft,t.Gt=this.Et,t.Nt=this.kt,t.Rt=this.Rt,t.Lt=this.Lt,t.Ot=this.Ot,t.jt[0]=this.$t[0],t.jt[1]=this.$t[1],t.jt[2]=this.$t[2],t.Qt=this.Pt,t.Xt[0]=this.Tt[0],t.Xt[1]=this.Tt[1],t.Xt[2]=this.Tt[2],t.Xt[3]=this.Tt[3],t.Yt[0]=this.St[0],t.Yt[1]=this.St[1],t.Yt[2]=this.St[2],t.Yt[3]=this.St[3]}Wt(t){this.wt=t.It,this.At=t.At,this.bt=t.bt,this.Ct=t.Ct,this.xt=t.xt,this.Mt=t.Mt,this.Ft=t.Ft,this.Et=t.Gt,this.kt=t.Nt,this.Rt=t.Rt,this.Lt=t.Lt,this.Ot=t.Ot,this.$t[0]=t.jt[0],this.$t[1]=t.jt[1],this.$t[2]=t.jt[2],this.Pt=t.Qt,this.Tt[0]=t.Xt[0],this.Tt[1]=t.Xt[1],this.Tt[2]=t.Xt[2],this.Tt[3]=t.Xt[3],this.St[0]=t.Yt[0],this.St[1]=t.Yt[1],this.St[2]=t.Yt[2],this.St[3]=t.Yt[3]}K(){let t=this.zt.pop();t||(t=nt.Bt()),this.Kt(t),this.Ht.push(t)}W(){const t=this.Ht.pop();t?(this.Wt(t),this.zt.push(t)):console.warn("pop() called without matching push()")}Zt(t){this.Kt(t)}qt(t){this.wt=Math.abs(t)}Vt(){this.At=0,this.bt=0,this.Ct=0,this.xt=0,this.Mt=0,this.Ft=0,this.Ot=!1}Jt(t){t!==0&&(this.xt+=k(t))}te(t){t!==0&&(this.Mt+=k(t))}ee(t){t!==0&&(this.Ft+=k(t))}se(t=0,i=0,s=0){t===0&&i===0&&s===0||(this.At+=t,this.bt+=i,this.Ct+=s)}ie(t){this.se(t,0,0)}re(t){this.se(0,t,0)}ne(t){this.se(0,0,t)}he(t){this.$t[0]=t[0],this.$t[1]=t[1],this.$t[2]=t[2]}oe(t){this.Pt=t}ae(t,i,s,e=255){rt(this.Tt,t,i,s,e)}ce(t,i,s,e=255){rt(this.St,t,i,s,e)}le(t){this.Et=t}ue(t){this.kt=t}fe(t){this.Rt=t}de(t){this.Lt=Mt(t)}pe(t,i,s,e){rt(this.Dt,t,i,s,e)}ve(t){this.Ot=t}get canvasBackgroundColor(){return this.Dt}get charColor(){return this.Tt}get cellColor(){return this.St}get lineWeight(){return this.wt}get character(){return this.$t}get characterString(){return this.Pt}get useOrtho(){return this.Ot}get rotationX(){return this.xt}get rotationY(){return this.Mt}get rotationZ(){return this.Ft}get translationX(){return this.At}get translationY(){return this.bt}get translationZ(){return this.Ct}get charRotation(){return this.Lt}get flipX(){return this.Et}get flipY(){return this.kt}get invert(){return this.Rt}}const bt=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,-.5,.5,0,1,-.5,.5,0,1,.5,-.5,1,0,.5,.5,1,1]),G={ge:16,me:WebGL2RenderingContext.TRIANGLES,_e:{ye:{size:2,offset:0},we:{size:2,offset:8}}};class ai{constructor(t){o(this,"$");o(this,"Ae");o(this,"be");this.$=t,this.Ae=t.createBuffer(),this.be=new Float32Array(bt.length)}Ce(t,i,s,e){const r=this.$,h=Nt(this.$),a=h[2],c=h[3],l=t/a*2-1,u=(t+s)/a*2-1,f=1-(i+e)/c*2,m=1-i/c*2,p=bt,g=this.be;for(let d=0;d<p.length;d+=4){const v=p[d],w=p[d+1],A=p[d+2],y=p[d+3],b=l+(v+.5)*(u-l),T=f+(w+.5)*(m-f);g[d]=b,g[d+1]=T,g[d+2]=A,g[d+3]=y}r.bindBuffer(r.ARRAY_BUFFER,this.Ae),r.bufferData(r.ARRAY_BUFFER,g,r.DYNAMIC_DRAW),V(r,0,2,16,0),V(r,1,2,16,8),r.drawArrays(r.TRIANGLES,0,6),r.disableVertexAttribArray(1),r.disableVertexAttribArray(0),r.bindBuffer(r.ARRAY_BUFFER,null)}xe(){this.$.deleteBuffer(this.Ae)}}var P=(n=>(n.RECTANGLE="rectangle",n.LINE="line",n.ELLIPSE="ellipse",n.ARC="arc",n.TRIANGLE="triangle",n.BEZIER_CURVE="bezier_curve",n))(P||{});const ci={rectangle:2,line:2,ellipse:2,triangle:2,arc:3,bezier_curve:4};class li{constructor(t){o(this,"$");o(this,"Me",new Map);o(this,"Fe",null);this.$=t}$e(t,i,s,e){const r=this.$,h=t.program;let a=this.Me.get(t);a||(a=new Map,this.Me.set(t,a),t.C(()=>this.Pe(t)));let c=a.get(i)||null;if(c)this.Fe!==c&&(r.bindVertexArray(c),this.Fe=c);else{c=r.createVertexArray(),a.set(i,c),r.bindVertexArray(c),this.Fe=c,r.bindBuffer(r.ARRAY_BUFFER,e);const l=r.getAttribLocation(h,"A0");l!==-1&&V(r,l,s._e.ye.size,s.ge,s._e.ye.offset,0,r.FLOAT,!1);const u=r.getAttribLocation(h,"A1");u!==-1&&V(r,u,s._e.we.size,s.ge,s._e.we.offset,0,r.FLOAT,!1)}}Pe(t){const i=this.Me.get(t);if(i){for(const[,s]of i)s&&this.$.deleteVertexArray(s);this.Me.delete(t)}}Te(){this.Fe!==null&&(this.$.bindVertexArray(null),this.Fe=null)}xe(){for(const[,t]of this.Me)for(const[,i]of t)i&&this.$.deleteVertexArray(i);this.Me.clear()}}class N{}o(N,"BYTES_PER_INSTANCE",144),o(N,"FLOATS_PER_INSTANCE",36);function _(n,t){return{location:-1,size:n,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:N.BYTES_PER_INSTANCE,offset:t,divisor:1}}class ht{}o(ht,"STRIDE",N.BYTES_PER_INSTANCE),o(ht,"ATTRIBUTES",{A2:_(2,0),A3:_(2,8),A4:_(3,16),A5:_(4,28),A6:_(4,44),A7:_(4,60),A8:_(3,76),A9:_(3,88),Aa:_(4,100),Ab:_(4,116),Ac:_(3,132)});class ui{constructor(t=1e3,i=1.5){o(this,"Se");o(this,"Ee");o(this,"ke");o(this,"Re",0);o(this,"Le",0);this.Ee=t,this.ke=i;const s=t*N.FLOATS_PER_INSTANCE;this.Se=new Float32Array(s)}De(t){if(t<=this.Ee)return;const i=Math.ceil(t*this.ke),s=this.Ee;this.Ee=i;const e=new Float32Array(i*N.FLOATS_PER_INSTANCE),r=s*N.FLOATS_PER_INSTANCE;e.set(this.Se.subarray(0,Math.min(r,this.Re))),this.Se=e}Oe(t){this.Re+=t,this.Le++}He(){this.Re=0,this.Le=0}ze(t=0,i){return this.Se.subarray(t,i??this.Re)}get Be(){return this.Le}get Ie(){return this.Ee}get Ge(){return this.Re}get Ne(){return this.Le===0}}class fi{constructor(t){o(this,"Se");this.Se=t}je(t){this.Se.Le>=this.Se.Ee&&this.Se.De(this.Se.Le+1);const i=this.Se.Se,s=this.Se.Re;i[s+0]=t.x,i[s+1]=t.y,i[s+2]=t.width,i[s+3]=t.height,i[s+4]=t.char0,i[s+5]=t.char1,i[s+6]=t.char2,i[s+7]=t.r1,i[s+8]=t.g1,i[s+9]=t.b1,i[s+10]=t.a1,i[s+11]=t.r2,i[s+12]=t.g2,i[s+13]=t.b2,i[s+14]=t.a2,i[s+15]=t.invert,i[s+16]=t.flipX,i[s+17]=t.flipY,i[s+18]=t.charRot,i[s+19]=t.translationX,i[s+20]=t.translationY,i[s+21]=t.translationZ,i[s+22]=t.rotationX,i[s+23]=t.rotationY,i[s+24]=t.rotationZ;const e=t.curveParams0,r=t.curveParams1;return i[s+25]=e[0],i[s+26]=e[1],i[s+27]=e[2],i[s+28]=e[3],i[s+29]=r[0],i[s+30]=r[1],i[s+31]=r[2],i[s+32]=r[3],i[s+33]=t.depth,i[s+34]=t.baseZ,i[s+35]=t.geometryType,this.Se.Oe(N.FLOATS_PER_INSTANCE),this.Se.Le-1}get Be(){return this.Se.Be}}class di{constructor(t,i=1e3){o(this,"$");o(this,"Qe",null);o(this,"Xe",0);o(this,"Ye",new WeakMap);o(this,"Ke",0);o(this,"We",new WeakMap);this.$=t,this.Ze(i)}Ze(t){const i=this.$;this.Qe&&i.deleteBuffer(this.Qe),this.Ke++,this.Qe=i.createBuffer();const s=t*N.BYTES_PER_INSTANCE;Ct(i,i.ARRAY_BUFFER,this.Qe,s,i.DYNAMIC_DRAW),this.Xe=t}qe(t){this.Ze(t)}get Ie(){return this.Xe}Ve(t,i){if(i===0)return;const s=this.$;s.bindBuffer(s.ARRAY_BUFFER,this.Qe);const e=i*N.FLOATS_PER_INSTANCE;s.bufferSubData(s.ARRAY_BUFFER,0,t,0,e)}Je(t){let i=this.Ye.get(t);if(!i){i=new Map;const s=this.$;for(const e in ht.ATTRIBUTES){const r=e,h=s.getAttribLocation(t,r);h!==-1&&i.set(r,h)}this.Ye.set(t,i)}return i}ts(t){const i=this.$,s=t.program;if(this.We.get(s)===this.Ke)return;const e=this.Je(s);for(const[r,h]of e){const a=ht.ATTRIBUTES[r];a&&V(i,h,a.size,a.stride,a.offset,a.divisor,a.type,a.normalized)}this.We.set(s,this.Ke)}xe(){this.Qe&&(this.$.deleteBuffer(this.Qe),this.Qe=null)}}class gi{constructor(t,i=1e3,s=1.5){o(this,"$");o(this,"Se");o(this,"es");o(this,"ss");this.$=t,this.Se=new ui(i,s),this.es=new fi(this.Se),this.ss=new di(t,i)}rs(t){var r,h,a,c,l,u,f,m,p,g;const i=this.Se;i.Le>=i.Ee&&i.De(i.Le+1);const s=i.Se,e=i.Re;return s[e+0]=t.ye[0],s[e+1]=t.ye[1],s[e+2]=t.ns[0],s[e+3]=t.ns[1],s[e+4]=t.jt[0],s[e+5]=t.jt[1],s[e+6]=t.jt[2],s[e+7]=t.Xt[0],s[e+8]=t.Xt[1],s[e+9]=t.Xt[2],s[e+10]=t.Xt[3],s[e+11]=t.Yt[0],s[e+12]=t.Yt[1],s[e+13]=t.Yt[2],s[e+14]=t.Yt[3],s[e+15]=t.hs[0],s[e+16]=t.hs[1],s[e+17]=t.hs[2],s[e+18]=t.Lt,s[e+19]=((r=t.cs)==null?void 0:r[0])??0,s[e+20]=((h=t.cs)==null?void 0:h[1])??0,s[e+21]=((a=t.cs)==null?void 0:a[2])??0,s[e+22]=((c=t.ls)==null?void 0:c[0])??0,s[e+23]=((l=t.ls)==null?void 0:l[1])??0,s[e+24]=((u=t.ls)==null?void 0:u[2])??0,t.us&&t.fs?(s[e+25]=((f=t.ds)==null?void 0:f[0])??0,s[e+26]=((m=t.ds)==null?void 0:m[1])??0,s[e+27]=((p=t.ps)==null?void 0:p[0])??0,s[e+28]=((g=t.ps)==null?void 0:g[1])??0,s[e+29]=t.us[0],s[e+30]=t.us[1],s[e+31]=t.fs[0],s[e+32]=t.fs[1]):t.vs?(s[e+25]=t.vs[0],s[e+26]=t.vs[1],s[e+27]=0,s[e+28]=0,s[e+29]=0,s[e+30]=0,s[e+31]=0,s[e+32]=0):(s[e+25]=0,s[e+26]=0,s[e+27]=0,s[e+28]=0,s[e+29]=0,s[e+30]=0,s[e+31]=0,s[e+32]=0),s[e+33]=t.gs||0,s[e+34]=t._s||0,s[e+35]=t.ws||0,i.Oe(N.FLOATS_PER_INSTANCE),i.Le-1}As(){this.Se.Ie>this.ss.Ie&&this.ss.qe(this.Se.Ie)}get instanceBuffer(){return this.Se}get writer(){return this.es}get bs(){return this.Se.Be}get Ne(){return this.Se.Ne}Cs(){this.Se.He()}ts(t){const i=this.Se.Be;if(i===0)return;this.As();const s=this.Se.ze();this.ss.Ve(s,i),this.ss.ts(t)}Ce(t,i){const s=this.Se.Be;s!==0&&this.$.drawArraysInstanced(t,0,i,s)}xe(){this.ss.xe()}}class j{constructor(t,i,s,e){o(this,"$");o(this,"Ms");o(this,"Fs");o(this,"$s");o(this,"Ps",null);o(this,"Ts",[0,0,0,0]);o(this,"Ss",[0,0,0,0]);o(this,"Es");var r,h;this.$=t,this.Ms=i,this.Fs=s,this.$s=e,this.Es=(r=this.Ts,h=this.Ss,{x:0,y:0,width:0,height:0,char0:0,char1:0,char2:0,r1:0,g1:0,b1:0,a1:0,r2:0,g2:0,b2:0,a2:0,invert:0,flipX:0,flipY:0,charRot:0,translationX:0,translationY:0,translationZ:0,rotationX:0,rotationY:0,rotationZ:0,curveParams0:r,curveParams1:h,depth:0,baseZ:0,geometryType:0});const a=this.$.createBuffer();Ct(this.$,this.$.ARRAY_BUFFER,a,this.$s.ks,this.$.STATIC_DRAW),this.Ps=a}get type(){return this.Fs}get unitGeometry(){return this.$s}get unitBuffer(){return this.Ps}get batch(){return this.Ms}Rs(){this.Ms.Cs()}Ls(){return!this.Ms.Ne}xe(){this.Ms.xe(),this.$.deleteBuffer(this.Ps)}Ds(t,i,s){return this.Ms.rs(t)}Os(t,i,s,e,r,h){const a=r.At??0,c=r.bt??0,l=r.Ct??0,u=r.xt??0,f=r.Mt??0,m=r.Ft??0,p=this.Ts,g=this.Ss;p[0]=0,p[1]=0,p[2]=0,p[3]=0,g[0]=0,g[1]=0,g[2]=0,g[3]=0,h&&(h.bezStartX!==void 0&&h.bezStartY!==void 0&&h.bezEndX!==void 0&&h.bezEndY!==void 0?(p[0]=h.cp1x??0,p[1]=h.cp1y??0,p[2]=h.cp2x??0,p[3]=h.cp2y??0,g[0]=h.bezStartX??0,g[1]=h.bezStartY??0,g[2]=h.bezEndX??0,g[3]=h.bezEndY??0):h.arcStart===void 0&&h.arcStop===void 0||(p[0]=h.arcStart??0,p[1]=h.arcStop??0));const d=this.Es;return d.x=t,d.y=i,d.width=s,d.height=e,d.char0=r.jt[0],d.char1=r.jt[1],d.char2=r.jt[2],d.r1=r.Xt[0],d.g1=r.Xt[1],d.b1=r.Xt[2],d.a1=r.Xt[3],d.r2=r.Yt[0],d.g2=r.Yt[1],d.b2=r.Yt[2],d.a2=r.Yt[3],d.invert=r.Rt?1:0,d.flipX=r.Gt?1:0,d.flipY=r.Nt?1:0,d.charRot=r.Lt,d.translationX=a,d.translationY=c,d.translationZ=l,d.rotationX=u,d.rotationY=f,d.rotationZ=m,d.depth=(h==null?void 0:h.depth)??0,d.baseZ=(h==null?void 0:h.baseZ)??0,d.geometryType=ci[this.Fs]??0,this.Ms.writer.je(d)}}const mi={ks:bt,Hs:6,...G},pi={ks:new Float32Array([0,-.5,0,0,1,-.5,1,0,0,.5,0,1,0,.5,0,1,1,-.5,1,0,1,.5,1,1]),Hs:6,...G},vi={ks:function(n=32){const t=[],i=2*Math.PI/n;for(let s=0;s<n;s++){const e=s*i,r=(s+1)%n*i,h=Math.cos(e),a=Math.sin(e),c=.5*(h+1),l=.5*(a+1),u=Math.cos(r),f=Math.sin(r),m=.5*(u+1),p=.5*(f+1);t.push(0,0,.5,.5,h,a,c,l,u,f,m,p)}return new Float32Array(t)}(32),Hs:96,...G};let Ai={ks:function(n){const t=[];for(let i=0;i<n;i++){const s=i/n,e=(i+1)/n;t.push(s,0,s,0,s,1,s,1,e,1,e,1)}return new Float32Array(t)}(32),Hs:96,...G};const yi={ks:new Float32Array([0,0,0,0,1,0,1,0,.5,1,.5,1]),Hs:3,...G},wi={ks:function(n=16){const t=[];for(let i=0;i<n;i++){const s=i/n,e=(i+1)/n;t.push(s,-.5,s,0,e,-.5,e,0,s,.5,s,1,s,.5,s,1,e,-.5,e,0,e,.5,e,1)}return new Float32Array(t)}(16),Hs:96,...G},bi={[P.RECTANGLE]:class extends j{constructor(n,t){super(n,t,P.RECTANGLE,mi)}rs(n,t){return this.Os(0,0,n.width,n.height,t)}},[P.LINE]:class extends j{constructor(n,t){super(n,t,P.LINE,pi)}rs(n,t){const i=n.x2-n.x1,s=n.y2-n.y1,e=Math.hypot(i,s),r=Math.atan2(s,i),h=t.It||1,a=Math.cos(-r),c=Math.sin(-r),l=n.x1*a-n.y1*c,u=n.x1*c+n.y1*a,f={...t,Ft:(t.Ft||0)+r};return this.Os(l,u,e,h,f)}},[P.ELLIPSE]:class extends j{constructor(n,t){super(n,t,P.ELLIPSE,vi)}rs(n,t){return this.Os(0,0,n.width,n.height,t)}},[P.ARC]:class extends j{constructor(n,t){super(n,t,P.ARC,Ai)}rs(n,t){const i=k(n.start),s=k(n.stop);return this.Os(0,0,n.width,n.height,t,{arcStart:i,arcStop:s})}},[P.TRIANGLE]:class extends j{constructor(n,t){super(n,t,P.TRIANGLE,yi)}rs(n,t){const i=Math.min(n.x1,n.x2,n.x3),s=Math.max(n.x1,n.x2,n.x3),e=Math.min(n.y1,n.y2,n.y3),r=s-i,h=Math.max(n.y1,n.y2,n.y3)-e;return this.Os(i,e,r,h,t)}},[P.BEZIER_CURVE]:class extends j{constructor(n,t){super(n,t,P.BEZIER_CURVE,wi)}rs(n,t){return this.Os(0,0,1,t.It||1,t,{cp1x:n.cp1x,cp1y:n.cp1y,cp2x:n.cp2x,cp2y:n.cp2y,bezStartX:n.x1,bezStartY:n.y1,bezEndX:n.x2,bezEndY:n.y2})}}};class xi{constructor(t){o(this,"$");o(this,"zs");o(this,"Bs");o(this,"Is",null);o(this,"Gs",new Map);o(this,"Ns",null);this.$=t,this.Bs=new li(t),this.zs=new Map;for(const i of Object.values(P)){const s=new gi(t),e=new bi[i](t,s);this.zs.set(i,e)}}js(t){this.Is=null,this.Gs.clear(),this.Ns=null;let i=null,s=null,e=null,r=!1;for(const h of t)i===h.material&&s===h.type&&r===h.state.Ot||(e&&e.Ls()&&this.Qs(e,i,s,r),i=h.material,s=h.type,e=this.zs.get(s),r=h.state.Ot,e.Rs()),e.rs(h.params,h.state);e&&e.Ls()&&this.Qs(e,i,s,r),this.Bs.Te()}Qs(t,i,s,e){if(this.Is!==i.shader&&(i.shader.dt(),this.Is=i.shader),this.Ns!==i&&(i.shader.gt(i.uniforms),this.Ns=i),this.Gs.get(i.shader)!==e){const a=Nt(this.$);i.shader.gt({Ur:a[2]/a[3],Us:[a[2],a[3]],Ut:1,Uu:e?1:0}),this.Gs.set(i.shader,e)}const r=t.unitGeometry,h=t.unitBuffer;try{this.Bs.$e(i.shader,String(s),r,h),t.batch.ts(i.shader),t.batch.Ce(r.me,r.Hs)}finally{t.Rs()}}xe(){for(const t of this.zs.values())t.xe();this.zs.clear(),this.Bs.xe()}}function _t(n){let t=0;for(let i=0;i<n.length;i++)t=(t<<5)-t+n.charCodeAt(i),t&=t;return t}const It=new WeakMap;let Ei=1;function Ut(n){if(n==null)return 0;if(typeof n!="object"&&typeof n!="function")return _t(String(n));let t=It.get(n);return t||(t=Ei++,It.set(n,t)),t}function Z(n,t){return(n<<5)-n+t}const ot=`#version 300 es
in vec2 A0;in vec2 A1;in vec2 A2;in vec2 A3;in vec3 A4;in vec4 A5;in vec4 A6;in vec4 A7;in vec3 A8;in vec3 A9;in vec4 Aa;in vec4 Ab;in vec3 Ac;uniform vec2 Us;uniform float Ut;uniform float Uu;out vec2 v_uv;out vec3 v_glyphIndex;out vec4 v_glyphColor;out vec4 v_cellColor;out vec4 v_glyphFlags;out vec3 v_worldPosition;out vec3 v_normal;out float v_geometryType;const float A=6.28318530718f;const int B=2;const int C=3;const int D=4;vec2 E(float F,vec2 G,vec2 H,vec2 I,vec2 J){float K=1.0f-F;float L=K*K;float M=L*K;float N=F*F;float O=N*F;return M*G+3.0f*L*F*H+3.0f*K*N*I+O*J;}vec2 P(float F,vec2 G,vec2 H,vec2 I,vec2 J){float K=1.0f-F;float L=K*K;float N=F*F;return-3.0f*L*G+3.0f*(L-2.0f*K*F)*H+3.0f*(2.0f*K*F-N)*I+3.0f*N*J;}vec3 Q(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x,R.y*T-R.z*U,R.y*U+R.z*T);}vec3 V(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x*T+R.z*U,R.y,-R.x*U+R.z*T);}vec3 W(vec3 R,float S){float T=cos(S);float U=sin(S);return vec3(R.x*T-R.y*U,R.x*U+R.y*T,R.z);}vec3 X(vec3 R,vec3 Y){vec3 Z=R;if(Y.z!=0.0f){Z=W(Z,Y.z);}if(Y.y!=0.0f){Z=V(Z,Y.y);}if(Y.x!=0.0f){Z=Q(Z,Y.x);}return Z;}void main(){v_uv=A1;v_glyphIndex=A4;v_glyphColor=A5;v_cellColor=A6;v_glyphFlags=A7;vec4 a=Aa;vec4 b=Ab;vec2 c=A3;vec2 d=A2;float e=Ac.x;float f=Ac.y;int g=int(Ac.z);vec2 h=d;vec2 i=h+c*0.5f;float j=f+e*0.5f;vec3 k=vec3(i,j);vec3 l;if(g==D){float F=clamp(A0.x,0.0f,1.0f);vec2 G=b.xy;vec2 H=a.xy;vec2 I=a.zw;vec2 J=b.zw;vec2 m=E(F,G,H,I,J);vec2 n=P(F,G,H,I,J);float o=length(n);vec2 p=o>0.0f?n/o:vec2(1.0f,0.0f);vec2 q=vec2(-p.y,p.x);vec2 r=m;vec2 s=r+q*A0.y*c.y;l=vec3(s,f);}else if(g==C){float t=mod(a.x,A);if(t<0.0f){t+=A;}float u=mod(a.y,A);if(u<0.0f){u+=A;}float v=t-u;if(v<=0.0f){v+=A;}float S=t-A0.x*v;vec2 w=vec2(cos(S),sin(S))*A0.y;vec2 s=w*c+h;l=vec3(s,f);}else if(g==B){vec2 s=A0.xy*c+h;l=vec3(s,f);}vec3 x=X(l,A9);vec3 y=x+A8;vec3 z=vec3(0.0f,0.0f,1.0f);v_worldPosition=y;v_normal=z;v_geometryType=float(g);vec2 AA=((y.xy)/Us)*2.0f;AA.y=-AA.y;float AB=y.z/Us.y;float AC=clamp(-AB*Ut,-0.99f,0.99f);if(Uu>0.5f){gl_Position=vec4(AA,AC,1.0f);}else{float AD=0.5f;float AE=1.0f/(1.0f-AB*AD);AA*=AE;gl_Position=vec4(AA,AC,1.0f);}}`;class Ri{constructor(t){o(this,"Xs",0);o(this,"Ys");o(this,"Ks");o(this,"Ws");o(this,"Zs",new Map);this.Ys=new H(t,ot,`#version 300 es
precision highp float;in vec3 v_glyphIndex;in vec4 v_glyphColor;in vec4 v_cellColor;in vec4 v_glyphFlags;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;void main(){int B=int(v_glyphFlags.r>0.5?1:0);int C=int(v_glyphFlags.g>0.5?1:0);int D=int(v_glyphFlags.b>0.5?1:0);float E=float(B|(C<<1)|(D<<2))/255.;o_character=vec4(v_glyphIndex.xy,E,clamp(v_glyphFlags.a,0.,1.));o_primaryColor=vec4(v_glyphColor.rgb,v_glyphColor.a);o_secondaryColor=vec4(v_cellColor.rgb,v_cellColor.a);A=vec4(0.);}`),this.Ks=new H(t,ot,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D U0;uniform sampler2D U1;uniform sampler2D U2;uniform sampler2D U3;uniform vec2 U4;uniform bool U5;uniform bool U6;uniform bool U7;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;void main(){vec2 B=vec2(v_uv.x,1.-v_uv.y);vec2 C=B*U4;vec2 D=(floor(C)+0.5f)/U4;vec4 E=texture(U0,D);vec4 F=U5?texture(U1,D):vec4(0.);if(U5&&F.a==0.){discard;}vec4 G=U6?texture(U2,D):vec4(0.);vec4 H=U7?texture(U3,D):vec4(0.);o_character=E;o_primaryColor=F;o_secondaryColor=G;A=H;}`),this.Ws={id:this.Xs++,shader:this.Ys,uniforms:Object.freeze({}),hash:this.qs(this.Ys,{}),isBuiltIn:!0}}get Vs(){return this.Ws}get tt(){return this.Ks}et(t,i={}){return{id:this.Xs++,shader:t,uniforms:Object.freeze({...i}),hash:0,isBuiltIn:!1}}qs(t,i){const s=Ut(t.program),e=function(r,h){let a=0;const c=Object.keys(r).sort();for(const l of c)a=Z(a,_t(l)),a=Z(a,h(r[l]));return a}(i,this.Js.bind(this));return Z(s,e)}Js(t){return typeof t=="number"||typeof t=="boolean"?function(i){return typeof i=="boolean"?i?1:0:Math.floor(i)}(t):Array.isArray(t)?function(i){let s=0;const e=Array.isArray(i[0])?i.flat():i;for(const r of e)s=Z(s,typeof r=="number"?r:0);return s}(t):t instanceof Float32Array||t instanceof Int32Array?function(i){let s=0;const e=Math.min(i.length,16);for(let r=0;r<e;r++)s=Z(s,i[r]);return s}(t):t instanceof WebGLTexture||X(t)?Ut(t):0}xe(){this.Ys.dispose(),this.Ks.dispose(),this.Zs.clear()}}class Ti{constructor(){o(this,"ti",[]);o(this,"ei",1);o(this,"ns",0)}si(t,i){if(this.ns>=this.ti.length){const e={id:this.ei++,type:t,params:{},state:nt.Bt(),material:i};this.ti.push(e)}const s=this.ti[this.ns];return s.id=this.ei++,s.type=t,s.material=i,this.ns++,s}ii(t,i,s){const e=this.si(P.RECTANGLE,s),r=e.params;return r.width=t.width,r.height=t.height,i.Zt(e.state),e.id}ri(t,i,s){const e=this.si(P.LINE,s),r=e.params;return r.x1=t.x1,r.y1=t.y1,r.x2=t.x2,r.y2=t.y2,r.thickness=t.thickness,i.Zt(e.state),e.id}ni(t,i,s){const e=this.si(P.ELLIPSE,s),r=e.params;return r.width=t.width,r.height=t.height,r.startAngle=t.startAngle,r.endAngle=t.endAngle,r.segments=t.segments,i.Zt(e.state),e.id}hi(t,i,s){const e=this.si(P.ARC,s),r=e.params;return r.width=t.width,r.height=t.height,r.start=t.start,r.stop=t.stop,i.Zt(e.state),e.id}oi(t,i,s){const e=this.si(P.TRIANGLE,s),r=e.params;return r.x1=t.x1,r.y1=t.y1,r.x2=t.x2,r.y2=t.y2,r.x3=t.x3,r.y3=t.y3,i.Zt(e.state),e.id}ai(t,i,s){const e=this.si(P.BEZIER_CURVE,s),r=e.params;return r.x1=t.x1,r.y1=t.y1,r.cp1x=t.cp1x,r.cp1y=t.cp1y,r.cp2x=t.cp2x,r.cp2y=t.cp2y,r.x2=t.x2,r.y2=t.y2,r.thickness=t.thickness,r.segments=t.segments,i.Zt(e.state),e.id}Cs(){this.ns=0}[Symbol.iterator](){let t=0;const i=this.ns,s=this.ti;return{next:()=>t<i?{value:s[t++],done:!1}:{value:void 0,done:!0}}}}class Mi{constructor(t){o(this,"$");o(this,"Is",null);o(this,"ci");o(this,"li");o(this,"ui");o(this,"fi");o(this,"di");o(this,"pi",null);o(this,"gi",{});o(this,"mi",[]);o(this,"_i",[]);o(this,"yi",[]);o(this,"wi",null);o(this,"Ai",[0,0,0,0]);o(this,"bi",1);o(this,"Ci",!0);o(this,"xi",!0);o(this,"Mi",!1);o(this,"Fi",new Float32Array(4));o(this,"$i",new Set);this.$=t,t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clearDepth(1),t.depthMask(!0),this.Ci=!0,this.xi=!0,t.disable(t.CULL_FACE),this.ui=new nt,this.li=new Ri(t),this.fi=new Ti,this.ci=new xi(t),this.di=new ai(t);const i=[0,0,t.canvas.width,t.canvas.height];wt(t,i),this.mi.push(null),this._i.push(i),this.yi.push(1),this.wi=null,this.Ai=i,this.bi=1}X(){this.mi.push(this.wi),this._i.push([...this.Ai]),this.yi.push(this.bi)}q(){const t=this.mi.pop()??null,i=this._i.pop()??[0,0,this.$.canvas.width,this.$.canvas.height],s=this.yi.pop()??1;this.Y(t,i[2],i[3],s)}Y(t,i,s,e=1){const r=this.$;this.wi!==t&&(r.bindFramebuffer(r.FRAMEBUFFER,t),this.wi=t),this.bi=e;const h=[0,0,i,s];this.Ai[0]===h[0]&&this.Ai[1]===h[1]&&this.Ai[2]===h[2]&&this.Ai[3]===h[3]||(r.viewport(...h),wt(r,h),this.Ai=h)}Pi(t){this.Is!==t&&(this.Is=t,t.dt())}Ti(t){if(this.Mi=t,t)this.$i.clear();else{for(const i of this.$i)i.Si();this.$i.clear()}}Ei(){return this.Mi}ki(t,i){return new H(this.$,t,i)}Ri(t){this.pi=t,t&&(this.gi={})}Li(){this.pi=null,this.gi={}}_t(t,i){this.gi[t]=i}gt(t){Object.assign(this.gi,t)}Di(t){return new H(this.$,ot,t)}Oi(t,i,s,e){t instanceof $||!e||t.Hi(e);const r=t.V();this.fi.ii({width:i??t.width,height:s??t.height},this.ui,r),t instanceof $||!t.zi()||this.$i.add(t)}Bi(t,i,s,e){this.di.Ce(t,i,s,e)}Ii(t,i){if(this.pi){const s=this.li.et(this.pi,this.gi);this.fi.ii({width:t,height:i},this.ui,s)}else this.fi.ii({width:t,height:i},this.ui,this.li.Vs)}Gi(t,i,s,e){this.fi.ri({x1:t,y1:i,x2:s,y2:e},this.ui,this.li.Vs)}Ni(t,i){this.fi.ni({width:t,height:i},this.ui,this.li.Vs)}ji(t,i,s,e,r,h){this.fi.oi({x1:t,y1:i,x2:s,y2:e,x3:r,y3:h},this.ui,this.li.Vs)}Qi(t,i,s,e,r,h,a,c){this.fi.ai({x1:t,y1:i,cp1x:s,cp1y:e,cp2x:r,cp2y:h,x2:a,y2:c},this.ui,this.li.Vs)}Xi(t,i,s,e){this.fi.hi({width:t,height:i,start:s,stop:e},this.ui,this.li.Vs)}Yi(t,i,s=1,e={}){return new $(this.$,t,i,s,e,this)}Ki(t,i=t,s=t,e=255){this.ui.pe(t,i??t,s??t,e);const[r,h,a,c]=this.ui.canvasBackgroundColor;this.Wi(r,h,a,c,!1)}Cs(t=0,i=0,s=0,e=0){this.Wi(t,i,s,e,!0)}Wi(t,i,s,e,r){const h=this.$,a=this.Fi;if(this.bi>1){a[0]=r?1:0,a[1]=r?1:0,a[2]=0,a[3]=0,h.clearBufferfv(h.COLOR,0,a),a[0]=0,a[1]=0,a[2]=0,a[3]=0,h.clearBufferfv(h.COLOR,1,a),this.bi>=3&&(a[0]=t,a[1]=i,a[2]=s,a[3]=e,h.clearBufferfv(h.COLOR,2,a)),this.bi>=3&&(a[0]=0,a[1]=0,a[2]=0,a[3]=0);for(let c=3;c<this.bi;c++)h.clearBufferfv(h.COLOR,c,a)}else h.clearColor(t,i,s,e),h.clear(h.COLOR_BUFFER_BIT)}Zi(){const t=[0,0,this.$.canvas.width,this.$.canvas.height];this.$.viewport(...t),wt(this.$,t),this.Ai=t,this._i.length>0&&(this._i[0]=t)}qi(t){this.Ci!==t&&(t?this.$.enable(this.$.DEPTH_TEST):this.$.disable(this.$.DEPTH_TEST),this.Ci=t)}Vi(t){this.xi!==t&&(this.$.depthMask(t),this.xi=t)}Ji(){return this.Ci}tr(){return this.xi}Z(){const t=this.fi;this.ci.js(t),t.Cs(),this.Is=null}xe(){this.li.xe(),this.ci.xe(),this.di.xe()}get context(){return this.$}get state(){return this.ui}get materialManager(){return this.li}}const C={readShort:(n,t)=>(C.t.uint16[0]=n[t]<<8|n[t+1],C.t.int16[0]),readUshort:(n,t)=>n[t]<<8|n[t+1],readUshorts(n,t,i){const s=[];for(let e=0;e<i;e++)s.push(C.readUshort(n,t+2*e));return s},readUint(n,t){const i=C.t.uint8;return i[3]=n[t],i[2]=n[t+1],i[1]=n[t+2],i[0]=n[t+3],C.t.uint32[0]},readASCII(n,t,i){let s="";for(let e=0;e<i;e++)s+=String.fromCharCode(n[t+e]);return s},t:(()=>{const n=new ArrayBuffer(8);return{uint8:new Uint8Array(n),int16:new Int16Array(n),uint16:new Uint16Array(n),uint32:new Uint32Array(n)}})()};function at(n){return n+3&-4}function ct(n,t,i){n[t]=i>>>8&255,n[t+1]=255&i}function B(n,t,i){n[t]=i>>>24&255,n[t+1]=i>>>16&255,n[t+2]=i>>>8&255,n[t+3]=255&i}function Fi(n,t,i){for(let s=0;s<i.length;s++)n[t+s]=255&i.charCodeAt(s)}function xt(n,t,i){const s=t+i;let e=0;const r=C.t;for(let h=t;h<s;h+=4)r.uint8[3]=n[h]||0,r.uint8[2]=n[h+1]||0,r.uint8[1]=n[h+2]||0,r.uint8[0]=n[h+3]||0,e=e+(r.uint32[0]>>>0)>>>0;return e>>>0}class Pi{constructor(t){o(this,"b");o(this,"p",0);o(this,"bitbuf",0);o(this,"bitcnt",0);this.b=t}readBits(t){for(;this.bitcnt<t;){const s=this.b[this.p++]||0;this.bitbuf|=s<<this.bitcnt,this.bitcnt+=8}const i=this.bitbuf&(1<<t)-1;return this.bitbuf>>>=t,this.bitcnt-=t,i}alignToByte(){this.bitbuf=0,this.bitcnt=0}get offset(){return this.p}}function q(n){let t=32,i=0;for(const a of n)a&&(a<t&&(t=a),a>i&&(i=a));if(i===0)return{min:0,max:0,table:new Map};const s=new Uint32Array(i+1);for(const a of n)a&&s[a]++;const e=new Uint32Array(i+1);let r=0;s[0]=0;for(let a=1;a<=i;a++)r=r+s[a-1]<<1,e[a]=r;const h=new Map;for(let a=0;a<n.length;a++){const c=n[a];if(!c)continue;const l=e[c]++;let u=h.get(c);u||(u=[],h.set(c,u)),u[Ci(l,c)]=a}return{min:t,max:i,table:h}}function Et(n,t){let i=0;for(let s=1;s<=t.max;s++){i|=n.readBits(1)<<s-1;const e=t.table.get(s);if(e&&i<e.length){const r=e[i];if(r!==void 0)return r}}throw new Error("Invalid Huffman code")}function Ci(n,t){let i=0;for(let s=0;s<t;s++)i=i<<1|1&n,n>>>=1;return i>>>0}function Si(n){if(n.length<2)throw new Error("ZLIB data too short");const t=n[0],i=n[1];if((15&t)!=8)throw new Error("Unsupported ZLIB compression method");if(((t<<8)+i)%31!=0)throw new Error("Bad ZLIB header check");let s=2;32&i&&(s+=4);const e=[];return function(r,h){const a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],c=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],u=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];let f=0;for(;!f;){f=r.readBits(1);const m=r.readBits(2);if(m===0){r.alignToByte();const p=r.readBits(16);if((65535&(65535^p))!==r.readBits(16))throw new Error("DEFLATE uncompressed LEN/NLEN mismatch");for(let g=0;g<p;g++)h.push(r.readBits(8))}else{if(m!==1&&m!==2)throw new Error("Unsupported DEFLATE type");{let p,g;if(m===1){const d=new Array(288).fill(0);for(let v=0;v<=143;v++)d[v]=8;for(let v=144;v<=255;v++)d[v]=9;for(let v=256;v<=279;v++)d[v]=7;for(let v=280;v<=287;v++)d[v]=8;p=q(d),g=q(new Array(32).fill(5))}else{const d=r.readBits(5)+257,v=r.readBits(5)+1,w=r.readBits(4)+4,A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],y=new Array(19).fill(0);for(let F=0;F<w;F++)y[A[F]]=r.readBits(3);const b=q(y),T=[];for(;T.length<d+v;){const F=Et(r,b);if(F<=15)T.push(F);else if(F===16){const U=r.readBits(2)+3,L=T[T.length-1]||0;for(let pt=0;pt<U;pt++)T.push(L)}else if(F===17){const U=r.readBits(3)+3;for(let L=0;L<U;L++)T.push(0)}else{if(F!==18)throw new Error("Invalid code length symbol");{const U=r.readBits(7)+11;for(let L=0;L<U;L++)T.push(0)}}}const M=T.slice(0,d),S=T.slice(d,d+v);p=q(M),g=q(S)}for(;;){const d=Et(r,p);if(d<256)h.push(d);else{if(d===256)break;if(d>256&&d<286){const v=d-257;let w=a[v];const A=c[v];A&&(w+=r.readBits(A));const y=Et(r,g);if(y>=30)throw new Error("Invalid distance symbol");let b=l[y];const T=u[y];T&&(b+=r.readBits(T));const M=h.length-b;if(M<0)throw new Error("Invalid distance");for(let S=0;S<w;S++)h.push(h[M+S]||0)}else if(d===286||d===287)throw new Error("Reserved length symbol")}}}}}}(new Pi(n.subarray(s)),e),new Uint8Array(e)}function Li(n){const t=C,i=new Uint8Array(n);if(t.readASCII(i,0,4)!=="wOFF")throw new Error("Invalid WOFF signature");const s=t.readUint(i,4),e=t.readUshort(i,12),r=t.readUint(i,16),h=[];let a=44;for(let A=0;A<e;A++){const y=t.readASCII(i,a,4),b=t.readUint(i,a+4),T=t.readUint(i,a+8),M=t.readUint(i,a+12),S=t.readUint(i,a+16);h.push({tag:y,offset:b,compLength:T,origLength:M,checksum:S}),a+=20}for(const A of h){const y=new Uint8Array(i.buffer,A.offset,A.compLength);if(A.compLength===A.origLength)A.data=new Uint8Array(y);else if(A.data=Si(y),A.data.length!==A.origLength)if(A.data.length<A.origLength){const b=new Uint8Array(A.origLength);b.set(A.data),A.data=b}else A.data=A.data.subarray(0,A.origLength)}const c=e;let l=1,u=0;for(;l<<1<=c;)l<<=1,u++;const f=16*l,m=16*c-f;let p=12+16*c;const g={};for(const A of h)g[A.tag]=p,p=at(p+A.data.length);const d=Math.max(r||0,p),v=new Uint8Array(d);B(v,0,s),ct(v,4,c),ct(v,6,f),ct(v,8,u),ct(v,10,m);let w=12;for(const A of h){Fi(v,w,A.tag),w+=4;const y=A.data;if(A.tag==="head"&&y.length>=12){const b=new Uint8Array(y);B(b,8,0),B(v,w,xt(b,0,at(b.length))),w+=4}else B(v,w,xt(y,0,at(y.length))),w+=4;B(v,w,g[A.tag]),w+=4,B(v,w,A.data.length),w+=4}for(const A of h){const y=g[A.tag];v.set(A.data,y)}if(h.find(A=>A.tag==="head")){const A=g.head,y=function(b,T){const M=T+8,S=[b[M],b[M+1],b[M+2],b[M+3]];B(b,M,0);const F=2981146554-(xt(b,0,at(b.length))>>>0)>>>0;return b[M]=S[0],b[M+1]=S[1],b[M+2]=S[2],b[M+3]=S[3],F>>>0}(v,A);B(v,A+8,y)}return v.buffer}const Ni={parseTab(n,t,i){const s={tables:[],ids:{},off:t};n=new Uint8Array(n.buffer,t,i),t=0;const e=C,r=e.readUshort;r(n,t);const h=r(n,t+=2);t+=2;const a=[];for(let c=0;c<h;c++){const l=r(n,t),u=r(n,t+=2);t+=2;const f=e.readUint(n,t);t+=4;const m=`p${l}e${u}`;let p=a.indexOf(f);if(p===-1){let g;p=s.tables.length,a.push(f);const d=r(n,f);g=d===4?this.parse4(n,f):d===12?this.parse12(n,f):{format:d},s.tables.push(g)}s.ids[m]=p}return s},parse4(n,t){const i=C,s=i.readUshort,e=i.readUshorts,r=t,h=s(n,t+=2);s(n,t+=2);const a=s(n,t+=2)>>>1,c={format:4,searchRange:s(n,t+=2),entrySelector:0,rangeShift:0,endCount:[],startCount:[],idDelta:[],idRangeOffset:[],glyphIdArray:[]};t+=2,c.entrySelector=s(n,t),t+=2,c.rangeShift=s(n,t),t+=2,c.endCount=e(n,t,a),t+=2*a,t+=2,c.startCount=e(n,t,a),t+=2*a;for(let l=0;l<a;l++)c.idDelta.push(i.readShort(n,t)),t+=2;return c.idRangeOffset=e(n,t,a),t+=2*a,c.glyphIdArray=e(n,t,r+h-t>>1),c},parse12(n,t){const i=C.readUint;i(n,t+=4),i(n,t+=4);const s=i(n,t+=4);t+=4;const e=new Uint32Array(3*s);for(let r=0;r<3*s;r+=3)e[r]=i(n,t+(r<<2)),e[r+1]=i(n,t+(r<<2)+4),e[r+2]=i(n,t+(r<<2)+8);return{format:12,groups:e}}},_i={parseTab(n,t,i){const s=C;t+=18;const e=s.readUshort(n,t);t+=2,t+=16;const r=s.readShort(n,t);t+=2;const h=s.readShort(n,t);t+=2;const a=s.readShort(n,t);t+=2;const c=s.readShort(n,t);return t+=2,t+=6,{unitsPerEm:e,xMin:r,yMin:h,xMax:a,yMax:c,indexToLocFormat:s.readShort(n,t)}}},Ii={parseTab(n,t,i){const s=C;t+=4;const e=s.readShort,r=s.readUshort;return{ascender:e(n,t),descender:e(n,t+2),lineGap:e(n,t+4),advanceWidthMax:r(n,t+6),minLeftSideBearing:e(n,t+8),minRightSideBearing:e(n,t+10),xMaxExtent:e(n,t+12),caretSlopeRise:e(n,t+14),caretSlopeRun:e(n,t+16),caretOffset:e(n,t+18),res0:e(n,t+20),res1:e(n,t+22),res2:e(n,t+24),res3:e(n,t+26),metricDataFormat:e(n,t+28),numberOfHMetrics:r(n,t+30)}}},Ui={parseTab(n,t,i,s){const e=C,r=[],h=[],a=s.maxp.numGlyphs,c=s.hhea.numberOfHMetrics;let l=0,u=0,f=0;for(;f<c;)l=e.readUshort(n,t+(f<<2)),u=e.readShort(n,t+(f<<2)+2),r.push(l),h.push(u),f++;for(;f<a;)r.push(l),h.push(u),f++;return{aWidth:r,lsBearing:h}}},Bt={cmap:Ni,head:_i,hhea:Ii,maxp:{parseTab(n,t,i){const s=C;return s.readUint(n,t),t+=4,{numGlyphs:s.readUshort(n,t)}}},hmtx:Ui,loca:{parseTab(n,t,i,s){const e=C,r=[],h=s.head.indexToLocFormat,a=s.maxp.numGlyphs+1;if(h===0)for(let c=0;c<a;c++)r.push(e.readUshort(n,t+(c<<1))<<1);else if(h===1)for(let c=0;c<a;c++)r.push(e.readUint(n,t+(c<<2)));return r}},glyf:{parseTab(n,t,i,s){const e=[],r=s.maxp.numGlyphs;for(let h=0;h<r;h++)e.push(null);return e},er(n,t){const i=C,s=n.sr,e=n.loca;if(e[t]===e[t+1])return null;const r=lt.findTable(s,"glyf",n.ir);if(!r)return null;let h=r[0]+e[t];const a={};if(a.noc=i.readShort(s,h),h+=2,a.xMin=i.readShort(s,h),h+=2,a.yMin=i.readShort(s,h),h+=2,a.xMax=i.readShort(s,h),h+=2,a.yMax=i.readShort(s,h),h+=2,a.xMin>=a.xMax||a.yMin>=a.yMax)return null;if(a.noc>0){a.endPts=[];for(let m=0;m<a.noc;m++)a.endPts.push(i.readUshort(s,h)),h+=2;const c=i.readUshort(s,h);if(h+=2,s.length-h<c)return null;h+=c;const l=a.endPts[a.noc-1]+1;a.flags=[];for(let m=0;m<l;m++){const p=s[h];if(h++,a.flags.push(p),8&p){const g=s[h];h++;for(let d=0;d<g;d++)a.flags.push(p),m++}}a.xs=[];for(let m=0;m<l;m++){const p=a.flags[m],g=!!(16&p);2&p?(a.xs.push(g?s[h]:-s[h]),h++):g?a.xs.push(0):(a.xs.push(i.readShort(s,h)),h+=2)}a.ys=[];for(let m=0;m<l;m++){const p=a.flags[m],g=!!(32&p);4&p?(a.ys.push(g?s[h]:-s[h]),h++):g?a.ys.push(0):(a.ys.push(i.readShort(s,h)),h+=2)}let u=0,f=0;for(let m=0;m<l;m++)u+=a.xs[m],f+=a.ys[m],a.xs[m]=u,a.ys[m]=f}else a.parts=[],a.endPts=[],a.flags=[],a.xs=[],a.ys=[];return a}}},lt={parse(n){const t=new Uint8Array(n);C.readASCII(t,0,4)==="wOFF"&&(n=Li(n));const i=new Uint8Array(n),s=Bt,e={},r={sr:i,rr:0,ir:0};for(const h in s){const a=h,c=lt.findTable(i,a,0);if(c){const[l,u]=c;let f=e[l];f==null&&(f=s[a].parseTab(i,l,u,r),e[l]=f),Object.assign(r,{[a]:f})}}return[r]},findTable(n,t,i){const s=C,e=s.readUshort(n,i+4);let r=i+12;for(let h=0;h<e;h++){const a=s.readASCII(n,r,4);s.readUint(n,r+4);const c=s.readUint(n,r+8),l=s.readUint(n,r+12);if(a===t)return[c,l];r+=16}return null},T:Bt,B:C};function Ot(n,t,i){if(n.idRangeOffset[i]===0)return t+n.idDelta[i]&65535;{const s=n.startCount.length,e=n.idRangeOffset[i]/2+(t-n.startCount[i])-(s-i);if(e>=0&&n.glyphIdArray&&e<n.glyphIdArray.length){const r=n.glyphIdArray[e];if(r!==0)return r+n.idDelta[i]&65535}}return 0}class Bi{nr(t){var s;const i=[];return(s=t.cmap)!=null&&s.tables?(t.cmap.tables.forEach(e=>{if(e.format===4){const r=this.hr(e);i.push(...r)}else if(e.format===12){const r=this.ar(e);i.push(...r)}}),[...new Set(i)]):[]}hr(t){const i=[];if(!(t.startCount&&t.endCount&&t.idRangeOffset&&t.idDelta))return i;for(let s=0;s<t.startCount.length;s++){const e=t.startCount[s],r=t.endCount[s];if(e!==65535||r!==65535)for(let h=e;h<=r;h++)Ot(t,h,s)>0&&this.cr(i,h)}return i}ar(t){const i=[];if(!t.groups)return i;for(let s=0;s<t.groups.length;s+=3){const e=t.groups[s],r=t.groups[s+1],h=t.groups[s+2];for(let a=e;a<=r;a++)h+(a-e)>0&&this.cr(i,a)}return i}cr(t,i){try{const s=String.fromCodePoint(i);t.push(s)}catch{}}}class Oi{constructor(t){o(this,"lr");o(this,"ur");o(this,"R");o(this,"P",null);o(this,"dr",0);o(this,"pr",0);this.R=t,this.lr=document.createElement("canvas"),this.ur=this.lr.getContext("2d",{willReadFrequently:!0,alpha:!0})}vr(t,i,s,e){const r=t.length;this.dr=Math.ceil(Math.sqrt(r)),this.pr=Math.ceil(r/this.dr);const h=i.width*this.dr,a=i.height*this.pr;this.gr(h,a),this.mr(t,i,this.dr,s,e),this.P?this.P.width===h&&this.P.height===a||this.P.resize(h,a):this.P=this.R.Yi(h,a,1,{filter:"nearest"}),this.P.j(this.lr)}gr(t,i){this.lr.width=t,this.lr.height=i,this.lr.style.width=t+"px",this.lr.style.height=i+"px",this.ur.imageSmoothingEnabled=!1,this.lr.style.imageRendering="pixelated",this.ur.clearRect(0,0,t,i),this.ur.textBaseline="top",this.ur.textAlign="left",this.ur.fillStyle="white"}mr(t,i,s,e,r){const h=e/r.head.unitsPerEm;for(let a=0;a<t.length;a++){const c=a%s,l=Math.floor(a/s),u=t[a].glyphData;if(!u)continue;const f=u.advanceWidth*h,m=c*i.width,p=l*i.height,g=m+.5*i.width,d=p+.5*i.height,v=Math.round(g-.5*i.width),w=Math.round(d-.5*e),A=v+.5*(i.width-f),y=w+r.hhea.ascender*h;this._r(u,A,y,h)}}_r(t,i,s,e){if(!t||!t.xs||t.noc===0)return;const{xs:r,ys:h,endPts:a,flags:c}=t;if(!(r&&h&&a&&c))return;this.ur.beginPath();let l=0;for(let u=0;u<a.length;u++){const f=a[u];if(!(f<l)){if(f>=l){const m=i+r[l]*e,p=s-h[l]*e;this.ur.moveTo(m,p);let g=l+1;for(;g<=f;)if(1&c[g]){const d=i+r[g]*e,v=s-h[g]*e;this.ur.lineTo(d,v),g++}else{const d=i+r[g]*e,v=s-h[g]*e;if(g+1>f){const A=i+r[l]*e,y=s-h[l]*e;if(1&c[l])this.ur.quadraticCurveTo(d,v,A,y);else{const b=(d+A)/2,T=(v+y)/2;this.ur.quadraticCurveTo(d,v,b,T)}break}const w=g+1;if(1&c[w]){const A=i+r[w]*e,y=s-h[w]*e;this.ur.quadraticCurveTo(d,v,A,y),g=w+1}else{const A=(d+(i+r[w]*e))/2,y=(v+(s-h[w]*e))/2;this.ur.quadraticCurveTo(d,v,A,y),g=w}}this.ur.closePath()}l=f+1}}this.ur.fill()}xe(){var t;(t=this.P)==null||t.dispose(),this.P=null}get framebuffer(){return this.P}get columns(){return this.dr}get rows(){return this.pr}}class zt{yr(t,i){const s=t.cmap;if(!s||!s.tables)return 0;let e=0;for(const r of s.tables)if(r.format===4?e=this.wr(i,r):r.format===12&&(e=this.Ar(i,r)),e>0)break;return e}br(t,i){const s=i.codePointAt(0);return s===void 0?0:this.yr(t,s)}Cr(t,i){const s=t.hmtx;return s&&s.aWidth&&s.aWidth.length!==0?i<s.aWidth.length?s.aWidth[i]:s.aWidth[s.aWidth.length-1]:0}Mr(t,i){const s=i/t.head.unitsPerEm,e=t.hhea.ascender*s,r=t.hhea.descender*s,h=t.hhea.lineGap*s;return{ascender:e,descender:r,lineGap:h,lineHeight:e-r+h,unitsPerEm:t.head.unitsPerEm,scale:s}}wr(t,i){const s=i.endCount.length;let e=-1;for(let r=0;r<s;r++)if(t<=i.endCount[r]){e=r;break}return e===-1||t<i.startCount[e]?0:Ot(i,t,e)}Ar(t,i){const s=i.groups.length/3;for(let e=0;e<s;e++){const r=i.groups[3*e],h=i.groups[3*e+1],a=i.groups[3*e+2];if(t>=r&&t<=h)return a+(t-r)}return 0}}class zi{constructor(){o(this,"Fr");this.Fr=new zt}$r(t,i,s){let e=0;const r=this.Fr.Mr(s,i),h=r.lineHeight;for(const a of t){const c=this.Fr.br(s,a);if(c===0)continue;const l=this.Fr.Cr(s,c)*r.scale;e=Math.max(e,l)}return{width:Math.ceil(e),height:Math.ceil(h)}}}class Di{constructor(){o(this,"Pr");this.Pr=new zt}Tr(t,i){const s=[],e=new Map;return t.forEach((r,h)=>{const a=r.codePointAt(0)||0,c={character:r,unicode:a,color:this.Sr(h),glyphData:this.Er(i,r)};s.push(c),e.set(r,c)}),{array:s,map:e}}Sr(t){return[t%256/255,Math.floor(t/256)%256/255,0]}Er(t,i){const s=i.codePointAt(0)||0,e=this.Pr.yr(t,s);if(e===0)return null;const r=this.Pr.Cr(t,e),h=lt.T.glyf.er(t,e);return h?{...h,advanceWidth:r}:null}}class Q extends tt{constructor(i,s=16){super();o(this,"kr");o(this,"Rr",[]);o(this,"Lr",new Map);o(this,"Dr",16);o(this,"Or",{width:0,height:0});o(this,"Hr");o(this,"zr");o(this,"Br");o(this,"Ir");o(this,"Gr");o(this,"Nr",!1);this.Dr=s,this.zr=new Bi,this.Br=new Oi(i),this.Ir=new zi,this.Gr=new Di}async jr(i){if(this.Nr)return;const s=i||"data:font/woff;base64,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",e=await this.Qr(s);await this.Xr(e)}Yr(i){if(i===void 0)return this.Dr;this.Dr=i,this.Kr()}Kr(){const i=this.Rr.map(s=>s.character);this.Or=this.Ir.$r(i,this.Dr,this.kr),this.Br.vr(this.Rr,this.Or,this.Dr,this.kr)}async Wr(i){try{const s=await this.Qr(i);await this.Xr(s)}catch(s){throw new R(`Failed to load font: ${s instanceof Error?s.message:"Unknown error"}`,{originalError:s})}}async Qr(i){const s=await fetch(i);if(!s.ok)throw new R(`Failed to load font file: ${s.status} ${s.statusText}`);return s.arrayBuffer()}async Xr(i){await this.Zr(i);const s=lt.parse(i);if(!s||s.length===0)throw new Error("Failed to parse font file");this.kr=s[0],await this.qr()}async Zr(i){this.Hr&&document.fonts.delete(this.Hr);const s=Date.now();this.Hr=new FontFace(`CustomFont_${s}`,i),await this.Hr.load(),document.fonts.add(this.Hr)}async qr(){const i=this.zr.nr(this.kr),{array:s,map:e}=this.Gr.Tr(i,this.kr);this.Rr=s,this.Lr=e,this.Kr(),this.Nr=!0}Vr(i){const s=this.Lr.get(i);return s?s.color:[0,0,0]}Jr(i){return Array.from(i).map(s=>{const e=this.Lr.get(s);return e?e.color:[0,0,0]})}dispose(){this.Br.xe(),this.Hr&&document.fonts.delete(this.Hr),super.dispose()}get tn(){return this.Nr}get fontFramebuffer(){return this.Br.framebuffer}get characterMap(){return this.Lr}get characters(){return this.Rr}get textureColumns(){return this.Br.columns}get textureRows(){return this.Br.rows}get maxGlyphDimensions(){return this.Or}get fontSize(){return this.Dr}get font(){return this.kr}}class Dt{constructor(t,i,s){o(this,"en");o(this,"pr");o(this,"M");o(this,"F");o(this,"sn");o(this,"rn");o(this,"nn");o(this,"hn");o(this,"an");o(this,"cn",!1);o(this,"ln",new Set);this.nn=t,this.hn=i,this.an=s,this.reset()}un(){if(this.M=this.en*this.hn,this.F=this.pr*this.an,this.sn=Math.floor((this.nn.width-this.M)/2),this.rn=Math.floor((this.nn.height-this.F)/2),this.ln.size>0)for(const t of this.ln)t()}fn(t){this.ln.add(t)}dn(t){this.ln.delete(t)}reset(){this.cn||(this.en=Math.max(1,Math.floor(this.nn.width/this.hn)),this.pr=Math.max(1,Math.floor(this.nn.height/this.an))),this.un()}pn(t,i){this.hn=t,this.an=i,this.reset()}get cellWidth(){return this.hn}get cellHeight(){return this.an}get cols(){return this.en}set cols(t){this.cn=!0,this.en=Math.max(1,Math.floor(t)),typeof this.pr!="number"&&(this.pr=Math.max(1,Math.floor(this.nn.height/this.an))),this.un()}get rows(){return this.pr}set rows(t){this.cn=!0,this.pr=Math.max(1,Math.floor(t)),typeof this.en!="number"&&(this.en=Math.max(1,Math.floor(this.nn.width/this.hn))),this.un()}get width(){return this.M}get height(){return this.F}get offsetX(){return this.sn}get offsetY(){return this.rn}responsive(){this.cn=!1}vn(t,i){const s=this.nn.getBoundingClientRect(),e=t-s.left,r=i-s.top,h=this.nn.width/s.width,a=r*(this.nn.height/s.height),c=e*h-this.sn,l=a-this.rn,u=Math.floor(c/this.hn),f=Math.floor(l/this.an);return u>=0&&u<this.en&&f>=0&&f<this.pr?{x:u-Math.floor((this.en-1)/2),y:f-Math.floor(this.pr/2)}:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}}xe(){this.ln.clear()}}function ut(n){return parseInt(n,16)}const Yi=/^rgba?\(([^)]+)\)$/i;function z(n){return n=Math.round(n),Number.isNaN(n)?0:I(n,0,255)}function Yt(n,t=!1){if(!n)return null;const i=n.trim().toLowerCase();if(!i)return null;let s=null;return i.startsWith("rgb")&&(s=function(e){const r=Yi.exec(e.trim());if(!r)return null;const h=r[1].split(",").map(f=>f.trim());if(h.length<3)return null;const a=z(parseFloat(h[0])),c=z(parseFloat(h[1])),l=z(parseFloat(h[2]));let u=255;if(h[3]!==void 0){const f=h[3].trim();let m=parseFloat(f);f.endsWith("%")&&(m/=100),u=255*I(m,0,1)}return[a,c,l,Math.round(u)]}(i)),s&&(t||s[3]!==0)?s:null}class kt{constructor(t={}){o(this,"nn");o(this,"gn",null);o(this,"mn",!1);o(this,"_n");o(this,"yn",null);o(this,"wn",!0);o(this,"$",null);if(this.mn=t.overlay??!1,t.gl)this.yn=t.gl,this.nn=t.gl.canvas,this._n=!1,this.wn=!1;else if(this.mn&&t.canvas)this.gn=t.canvas,this.nn=this.An(),this._n=!0,this.bn();else if(t.canvas){if(typeof HTMLVideoElement<"u"&&t.canvas instanceof HTMLVideoElement)throw new R("Video elements are only supported in overlay mode.");this.nn=t.canvas,this._n=!1}else this.nn=this.Cn(t.width,t.height),this._n=!0;typeof HTMLCanvasElement<"u"&&this.nn instanceof HTMLCanvasElement&&(this.nn.style.imageRendering="pixelated")}Cn(t,i){const s=document.createElement("canvas");return s.className="textmodeCanvas",s.style.imageRendering="pixelated",s.width=t||800,s.height=i||600,document.body.appendChild(s),s}An(){const t=document.createElement("canvas");t.className="textmodeCanvas",t.style.imageRendering="pixelated";const i=this.gn.getBoundingClientRect();let s=Math.round(i.width),e=Math.round(i.height);if(typeof HTMLVideoElement<"u"&&this.gn instanceof HTMLVideoElement){const a=this.gn;(s===0||e===0)&&a.videoWidth>0&&a.videoHeight>0&&(s=a.videoWidth,e=a.videoHeight)}t.width=s,t.height=e,t.style.position="absolute";const r=window.getComputedStyle(this.gn);let h=parseInt(r.zIndex||"0",10);return isNaN(h)&&(h=0),t.style.zIndex=(h+1).toString(),t}bn(){var t;this.xn(),this.nn instanceof HTMLCanvasElement&&((t=this.gn.parentNode)==null||t.insertBefore(this.nn,this.gn.nextSibling))}Mn(){const t=[];return this.mn&&this.gn instanceof HTMLElement&&(t.push(this.gn),this.gn.parentElement&&t.push(this.gn.parentElement)),t.push(document.body),t.push(document.documentElement),t}Fn(){const t=this.Mn();for(const i of t){if(!i)continue;const s=Yt(window.getComputedStyle(i).backgroundColor);if(s)return s}return[255,255,255,255]}xn(){if(!this.gn||!(this.nn instanceof HTMLCanvasElement))return;const t=this.gn.getBoundingClientRect(),i=this.gn.offsetParent;if(i&&i!==document.body){const s=i.getBoundingClientRect();this.nn.style.top=t.top-s.top+"px",this.nn.style.left=t.left-s.left+"px"}else this.nn.style.top=t.top+window.scrollY+"px",this.nn.style.left=t.left+window.scrollX+"px"}$n(t,i){if(this.mn){const s=this.gn.getBoundingClientRect();this.nn.width=Math.round(s.width),this.nn.height=Math.round(s.height),this.xn()}else this.nn.width=t??this.nn.width,this.nn.height=i??this.nn.height}Pn(){if(this.yn)return this.yn;const t=this.nn.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!0,stencil:!1,powerPreference:"high-performance"});if(!t)throw new R("`textmode.js` requires WebGL2 support.");return this.$=t,t}xe(){if(!this.wn)return;const t=this.$??this.yn;if(t){const i=t.getExtension("WEBGL_lose_context");i==null||i.loseContext()}this._n&&typeof HTMLCanvasElement<"u"&&this.nn instanceof HTMLCanvasElement&&this.nn.parentNode&&this.nn.parentNode.removeChild(this.nn)}get canvas(){return this.nn}get targetCanvas(){return this.gn}get width(){return this.nn.width}get height(){return this.nn.height}get ownsContext(){return this.wn}}class E{constructor(t,i,s,e){o(this,"Tn");o(this,"Sn");o(this,"r");o(this,"g");o(this,"b");o(this,"a");this.r=z(t),this.g=z(i),this.b=z(s),this.a=z(e)}static En(t,i,s,e){if(E.kn(t))return t;if(Array.isArray(t)){if(t.length<3)throw new Error("Component tuples must include at least RGB values.");const[r,h,a]=t,c=t.length===4?t[3]:255;return E.Rn(r,h,a,c)}if(typeof t=="string"){const r=t.trim();if(r.length===0)throw new Error("Color strings cannot be empty.");const h=Yt(r,!0);return h?E.Rn(...h):E.Ln(r)}if(typeof t=="number")return typeof i=="number"&&typeof s=="number"?E.Rn(t,i,s,e??255):typeof i=="number"?E.Dn(t,i):E.Dn(t,e??255);throw new Error("Unsupported color input passed to TextmodeColor.$from.")}static Rn(t,i,s,e=255){return new E(t,i,s,e)}static Dn(t,i=255){return new E(t,t,t,i)}static Ln(t){return new E(...function(i){const s=i.trim().replace(/^#|0x/gi,"");if(!/^[0-9A-Fa-f]+$/.test(s))throw new Error(`Invalid hex color: ${i}`);const e=(r=s).length===3||r.length===4?r.split("").map(h=>h+h).join(""):r;var r;if(e.length!==6&&e.length!==8)throw new Error(`Invalid hex color: ${i}`);return[ut(e.slice(0,2)),ut(e.slice(2,4)),ut(e.slice(4,6)),e.length===8?ut(e.slice(6,8)):255]}(t))}static On(t,i,s,e){return new E(Math.round(255*t),Math.round(255*i),Math.round(255*s),Math.round(255*e))}get rgb(){return[this.r,this.g,this.b]}get rgba(){return this.Tn||(this.Tn=[this.r,this.g,this.b,this.a]),[...this.Tn]}get normalized(){return this.Sn||(this.Sn=[this.r/255,this.g/255,this.b/255,this.a/255]),[...this.Sn]}withAlpha(t){return new E(this.r,this.g,this.b,t)}static kn(t){return t instanceof E}}class ft extends tt{constructor(i,s,e,r,h,a,c,l){super();o(this,"$");o(this,"R");o(this,"Hn");o(this,"zn");o(this,"Bn");o(this,"M");o(this,"F");o(this,"L",null);o(this,"In",null);o(this,"Gn","brightness");o(this,"Nn",null);o(this,"jn");o(this,"Qn",null);o(this,"Rt",0);o(this,"Gt",0);o(this,"Nt",0);o(this,"Lt",0);o(this,"Xn","sampled");o(this,"Yn","fixed");o(this,"Kn",null);o(this,"Wn",null);o(this,"Zn",null);o(this,"qn",null);o(this,"Vn",null);o(this,"Jn",null);o(this,"Xt",[1,1,1,1]);o(this,"Yt",[0,0,0,1]);o(this,"th",[0,0,0,1]);o(this,"eh",[[.1,0,0]]);o(this,"Qt",null);o(this,"sh",null);o(this,"ih",null);o(this,"rh",null);o(this,"nh",null);this.$=i,this.R=s,this.Hn=e,this.jn=r,this.zn=h,this.Bn=a,this.hh(c,l)}oh(i,s,e){this.R.Ei()?this[i]=e:(this[s]=e,this.L=null)}ah(i,s,e){this.R.Ei()?this[i]=e:(this[s]=e,this.Nn=null,this.L=null)}uh(i,s,e,r,h){this.R.Ei()?this.fh(i,s,e,r,h):(i==="char"?this.dh(this.Xt,s,e,r,h):i==="cell"?this.dh(this.Yt,s,e,r,h):this.dh(this.th,s,e,r,h),this.L=null)}conversionMode(i){return this.ah("_frameConversionMode","_conversionMode",i),this}dispose(){this.Hn&&(this.$.deleteTexture(this.Hn),this.Hn=null),super.dispose()}invert(i=!0){const s=i?1:0;return this.oh("_frameInvert","_invert",s),this}flipX(i=!0){const s=i?1:0;return this.oh("_frameFlipX","_flipX",s),this}flipY(i=!0){const s=i?1:0;return this.oh("_frameFlipY","_flipY",s),this}charRotation(i){const s=Mt(i);return this.oh("_frameCharRotation","_charRotation",s),this}charColorMode(i){return this.oh("_frameCharColorMode","_charColorMode",i),this}cellColorMode(i){return this.oh("_frameCellColorMode","_cellColorMode",i),this}charColor(i,s,e,r){return this.uh("char",i,s,e,r),this}cellColor(i,s,e,r){return this.uh("cell",i,s,e,r),this}background(i,s,e,r){return this.uh("background",i,s,e,r),this}characters(i){if(this.R.Ei()){const s=this.ph(i);this.nh=s.length>0?s:null}else this.Qt=i,this.gh(i),this.L=null;return this}Hi(i){this.In!==i&&(this.In=i,this.Qt&&this.gh(this.Qt),this.L=null)}get texture(){return this.Hn}get width(){return this.M}get height(){return this.F}get originalWidth(){return this.zn}get originalHeight(){return this.Bn}$n(i,s){this.hh(i,s)}V(){return this.mh()?this._h():(this.L||this.J(),this.L)}zi(){return this.mh()}Si(){this.Kn=null,this.Wn=null,this.Zn=null,this.qn=null,this.Vn=null,this.Jn=null,this.sh=null,this.ih=null,this.rh=null,this.nh=null,this.Qn=null}yh(){}wh(){return this.Hn}J(){this.L=this._h()}_h(){this.yh();const i=this.Ah(),s=this.bh(),e=this.Qn??this.Gn,r=this.jn.Ch(e,s),h=i.createUniforms(s);return this.R.materialManager.et(r,h)}dh(i,s,e,r,h){const a=E.En(s,e,r,h);rt(i,a.r,a.g,a.b,a.a)}gh(i){const s=this.ph(i);this.eh=s.length>0?s:this.eh}ph(i){return this.In?this.In.Jr(i).filter(s=>Array.isArray(s)).slice(0,255):[]}hh(i,s){const{width:e,height:r}=function(h,a,c,l){const u=Math.min(c/h,l/a);return{width:Math.max(1,Math.floor(h*u)),height:Math.max(1,Math.floor(a*u)),scale:u}}(this.zn,this.Bn,i,s);this.M=e,this.F=r}createBaseConversionUniforms(){const i=this.Kn??this.Rt,s=this.Wn??this.Gt,e=this.Zn??this.Nt,r=this.qn??this.Lt,h=this.Vn??this.Xn,a=this.Jn??this.Yn,c=this.sh??this.Xt,l=this.ih??this.Yt,u=this.rh??this.th,f=this.nh??this.eh;return{u_image:this.wh(),u_invert:!!i,u_flipX:!!s,u_flipY:!!e,u_charRotation:r,u_charColorFixed:h==="fixed",u_charColor:c,u_cellColorFixed:a==="fixed",u_cellColor:l,u_backgroundColor:u,u_charCount:f.length,u_charList:f}}mh(){return this.Kn!==null||this.Wn!==null||this.Zn!==null||this.qn!==null||this.Vn!==null||this.Jn!==null||this.sh!==null||this.ih!==null||this.rh!==null||this.nh!==null||this.Qn!==null}Ah(){const i=this.Qn??this.Gn;if(this.Nn&&this.Nn.id===i)return this.Nn;const s=this.jn.xh(i);if(!s)throw new Error(`[textmode.js] Conversion mode "${i}" is not registered. If this mode is provided by an add-on, make sure its plugin is installed before loading sources.`);return this.Nn=s,s}fh(i,s,e,r,h){let a;i==="char"?(a=this.sh??[0,0,0,1],this.sh=a):i==="cell"?(a=this.ih??[0,0,0,1],this.ih=a):(a=this.rh??[0,0,0,1],this.rh=a),this.dh(a,s,e,r,h)}bh(){if(!this.In)throw new Error("[textmode.js] Cannot create conversion context: no active font set. Ensure $setActiveFont() is called before rendering.");return{renderer:this.R,gl:this.$,font:this.In,source:this}}}class W extends ft{constructor(t,i,s,e,r,h,a,c){super(t,i,s,e,r,h,a,c)}static Mh(t,i,s,e,r){const h=t.context,{texture:a,width:c,height:l}=yt(h,s);return new W(h,t,a,i,c,l,e,r)}}class Xt{constructor(t=60){o(this,"Fh");o(this,"$h");o(this,"Ph",null);o(this,"Th",0);o(this,"Sh",!0);o(this,"Eh",0);o(this,"kh",0);o(this,"Rh",[]);o(this,"Lh",10);o(this,"Dh",0);o(this,"Oh",0);o(this,"Hh",-1);this.$h=t,this.Fh=1e3/t}zh(t){if(!this.Sh)return;this.Hh===-1&&(this.Hh=performance.now()),this.Th=performance.now();const i=s=>{if(!this.Sh)return void(this.Ph=null);const e=s-this.Th;e>=this.Fh&&(t(),this.Th=s-e%this.Fh),this.Sh&&(this.Ph=requestAnimationFrame(i))};this.Ph=requestAnimationFrame(i)}Bh(){this.Ph&&(cancelAnimationFrame(this.Ph),this.Ph=null)}Ih(){this.Sh&&(this.Sh=!1,this.Bh())}Gh(t){this.Sh||(this.Sh=!0,this.zh(t))}Nh(t,i){if(t===void 0)return this.Eh;this.$h=t,this.Fh=1e3/t,this.Sh&&i&&(this.Bh(),this.zh(i))}jh(){const t=performance.now();if(this.kh>0){const i=t-this.kh;this.Dh=i,this.Rh.push(i),this.Rh.length>this.Lh&&this.Rh.shift();const s=this.Rh.reduce((e,r)=>e+r,0)/this.Rh.length;this.Eh=1e3/s}this.kh=t}get Qh(){return this.Sh}get Xh(){return this.Eh}get Yh(){return this.$h}set Yh(t){this.$h=t,this.Fh=1e3/t}get Kh(){return this.Oh}set Kh(t){this.Oh=t}Wh(){this.Oh++}get Zh(){return this.Hh===-1?0:performance.now()-this.Hh}set Zh(t){this.Hh=performance.now()-t}get qh(){return this.Zh/1e3}set qh(t){this.Zh=1e3*t}get Vh(){return this.Dh}}function Ht(n,t,i){return n?n.vn(t,i):{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}}class Gt{constructor(t,i){o(this,"nn");o(this,"Jh");o(this,"eo",{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY});o(this,"so",{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY});o(this,"io",null);o(this,"ro",0);o(this,"no");o(this,"ho");o(this,"oo");o(this,"ao");o(this,"co");o(this,"lo");o(this,"uo",!1);o(this,"fo");o(this,"do");o(this,"po");o(this,"vo");o(this,"mo");this.nn=t,this.Jh=i}_o(t){const i=performance.now()+Math.max(0,t);i>this.ro&&(this.ro=i)}yo(){return performance.now()<this.ro}wo(t){const i=this.nn.canvas;i.style.cursor=t==null||t===""?"":t}Ao(){if(this.uo)return;const t=this.nn.canvas;this.no=i=>{this.bo(i),this.Co(i)},this.ho=()=>{this.so={...this.eo},this.eo.x=Number.NEGATIVE_INFINITY,this.eo.y=Number.NEGATIVE_INFINITY,this.io=null},this.oo=i=>{this.bo(i),this.xo(i)},this.ao=i=>{this.bo(i),this.Mo(i)},this.co=i=>{this.bo(i),this.Fo(i)},this.lo=i=>{this.bo(i),this.$o(i)},t.addEventListener("mousemove",this.no,{passive:!0}),t.addEventListener("mouseleave",this.ho,{passive:!0}),t.addEventListener("mousedown",this.oo,{passive:!0}),t.addEventListener("mouseup",this.ao,{passive:!0}),t.addEventListener("click",this.co,{passive:!0}),t.addEventListener("wheel",this.lo,{passive:!1}),this.uo=!0}Po(){if(!this.uo)return;const t=this.nn.canvas;t.removeEventListener("mousemove",this.no),t.removeEventListener("mouseleave",this.ho),t.removeEventListener("mousedown",this.oo),t.removeEventListener("mouseup",this.ao),t.removeEventListener("click",this.co),t.removeEventListener("wheel",this.lo),this.uo=!1}To(){if(this.uo)try{if(this.io){const t=new MouseEvent("mousemove",{clientX:this.io.x,clientY:this.io.y,bubbles:!1,cancelable:!1});this.bo(t)}}catch{this.eo.x=Number.NEGATIVE_INFINITY,this.eo.y=Number.NEGATIVE_INFINITY}}So(t){this.fo=t}Eo(t){this.do=t}ko(t){this.po=t}Ro(t){this.vo=t}Lo(t){this.mo=t}Do(){return{x:this.eo.x,y:this.eo.y}}Oo(t,i={}){return{position:{...this.eo},previousPosition:{...this.so},originalEvent:t,...i}}Co(t){this.vo&&!this.yo()&&this.vo(this.Oo(t))}xo(t){this.do&&!this.yo()&&this.do(this.Oo(t,{button:t.button}))}Mo(t){this.po&&!this.yo()&&this.po(this.Oo(t,{button:t.button}))}Fo(t){this.fo&&!this.yo()&&this.fo(this.Oo(t,{button:t.button}))}$o(t){this.mo&&!this.yo()&&this.mo(this.Oo(t,{delta:{x:t.deltaX,y:t.deltaY}}))}bo(t){const i=this.Jh();this.so={...this.eo},this.io={x:t.clientX,y:t.clientY};const s=Ht(i,t.clientX,t.clientY);this.eo.x=s.x,this.eo.y=s.y}}const ki=Object.freeze(Object.defineProperty({__proto__:null,MouseManager:Gt},Symbol.toStringTag,{value:"Module"}));class jt{constructor(){o(this,"Ho",new Map);o(this,"zo",null);o(this,"Bo",null);o(this,"Io");o(this,"Go");o(this,"uo",!1);o(this,"No");o(this,"jo");o(this,"Qo",{ArrowUp:"UP_ARROW",ArrowDown:"DOWN_ARROW",ArrowLeft:"LEFT_ARROW",ArrowRight:"RIGHT_ARROW",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",Enter:"ENTER",Return:"RETURN",Tab:"TAB",Escape:"ESCAPE",Backspace:"BACKSPACE",Delete:"DELETE",Insert:"INSERT",Home:"HOME",End:"END",PageUp:"PAGE_UP",PageDown:"PAGE_DOWN",Shift:"SHIFT",Control:"CONTROL",Alt:"ALT",Meta:"META"," ":"SPACE"})}Ao(){this.uo||(this.Io=t=>{this.Xo(t)},this.Go=t=>{this.Yo(t)},window.addEventListener("keydown",this.Io,{passive:!1}),window.addEventListener("keyup",this.Go,{passive:!1}),this.uo=!0)}Po(){this.uo&&(window.removeEventListener("keydown",this.Io),window.removeEventListener("keyup",this.Go),this.uo=!1,this.Ho.clear(),this.zo=null,this.Bo=null)}Eo(t){this.No=t}ko(t){this.jo=t}Ko(t){const i=this.Wo(t),s=this.Ho.get(t)||this.Ho.get(i);return(s==null?void 0:s.isPressed)||!1}Zo(){return this.zo}qo(){return this.Bo}Vo(){const t=[];for(const[i,s]of this.Ho)s.isPressed&&t.push(i);return t}Jo(){return{ctrl:this.Ko("Control"),shift:this.Ko("Shift"),alt:this.Ko("Alt"),meta:this.Ko("Meta")}}ta(){this.Ho.clear(),this.zo=null,this.Bo=null}Xo(t){const i=t.key,s=Date.now();this.Ho.has(i)||this.Ho.set(i,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const e=this.Ho.get(i);e.isPressed||(e.isPressed=!0,e.lastPressTime=s,this.zo=i,this.No&&this.No(this.Oo(i,!0,t)))}Oo(t,i,s){return{key:t,keyCode:s.keyCode,ctrlKey:s.ctrlKey,shiftKey:s.shiftKey,altKey:s.altKey,metaKey:s.metaKey,isPressed:i,originalEvent:s}}Yo(t){const i=t.key,s=Date.now();this.Ho.has(i)||this.Ho.set(i,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const e=this.Ho.get(i);e.isPressed=!1,e.lastReleaseTime=s,this.Bo=i,this.jo&&this.jo(this.Oo(i,!1,t))}Wo(t){return this.Qo[t]||t.toLowerCase()}}const Xi=Object.freeze(Object.defineProperty({__proto__:null,KeyboardManager:jt},Symbol.toStringTag,{value:"Module"}));class Qt{constructor(t,i,s){o(this,"nn");o(this,"ea");o(this,"Jh");o(this,"sa",new Map);o(this,"ia",new Map);o(this,"ra",new Map);o(this,"na",null);o(this,"ha");o(this,"oa");o(this,"aa");o(this,"ca");o(this,"la");o(this,"ua");o(this,"uo",!1);o(this,"fa");o(this,"da");o(this,"pa");o(this,"va");o(this,"ga");o(this,"ma");o(this,"_a");o(this,"ya");o(this,"wa");o(this,"ba");o(this,"Ca",320);o(this,"xa",350);o(this,"Ma",10);o(this,"Fa",550);o(this,"$a",14);o(this,"Pa",48);o(this,"Ta",650);o(this,"Sa",.02);o(this,"Ea",2);o(this,"Ua",600);o(this,"ka",0);o(this,"Ra",null);this.nn=t,this.Jh=i,this.ea=s;const e=this.nn.canvas;this.ha=e.style.touchAction,this.oa=e.style.userSelect,e.style.touchAction||(e.style.touchAction="none"),e.style.userSelect||(e.style.userSelect="none")}Ao(){if(this.uo)return;const t=this.nn.canvas;this.aa=i=>{this.La(i)},this.ca=i=>{this.Da(i)},this.la=i=>{this.Oa(i)},this.ua=i=>{this.Ha(i)},t.addEventListener("touchstart",this.aa,{passive:!1}),t.addEventListener("touchmove",this.ca,{passive:!1}),t.addEventListener("touchend",this.la,{passive:!1}),t.addEventListener("touchcancel",this.ua,{passive:!1}),this.uo=!0}Po(){if(!this.uo)return;const t=this.nn.canvas;t.removeEventListener("touchstart",this.aa),t.removeEventListener("touchmove",this.ca),t.removeEventListener("touchend",this.la),t.removeEventListener("touchcancel",this.ua),this.uo=!1,this.na=null,this.sa.clear(),this.ia.clear(),this.ra.forEach(i=>{i.longPressTimer!==null&&window.clearTimeout(i.longPressTimer)}),this.ra.clear(),this.Ra=null,this.ka=0,t.style.touchAction=this.ha,t.style.userSelect=this.oa}To(){if(!this.Jh()||this.sa.size===0)return;const t=new Map;for(const i of this.sa.values()){const s=this.za(i.clientX,i.clientY,i.id,i);t.set(i.id,s)}this.sa=t}Ba(){return Array.from(this.sa.values()).map(t=>({...t}))}Ia(t){this.fa=t}Ro(t){this.da=t}Ga(t){this.pa=t}Na(t){this.va=t}ja(t){this.ga=t}Qa(t){this.ma=t}Xa(t){this._a=t}Ya(t){this.ya=t}Ka(t){this.wa=t}Wa(t){this.ba=t}La(t){var e;if(!this.Jh())return;t.preventDefault(),(e=this.ea)==null||e._o(this.Ua);const i=performance.now(),s=this.Za(t.changedTouches);for(const r of s){const h=this.sa.get(r.id);h&&this.ia.set(r.id,this.qa(h)),this.sa.set(r.id,r);const a={id:r.id,startPosition:r,lastPosition:r,startTime:i,lastTime:i,longPressTimer:null,longPressFired:!1};this._a&&(a.longPressTimer=window.setTimeout(()=>{const c=this.sa.get(r.id);c&&(a.longPressFired=!0,this._a({touch:this.qa(c),duration:performance.now()-a.startTime,originalEvent:t}))},this.Fa)),this.ra.set(r.id,a),this.fa&&this.fa(this.Va(r,t,void 0,i))}this.sa.size===2&&this.Ja()}Da(t){var e;if(!this.Jh())return;t.preventDefault(),(e=this.ea)==null||e._o(this.Ua);const i=performance.now(),s=this.Za(t.changedTouches);for(const r of s){const h=this.sa.get(r.id),a=h?this.qa(h):void 0;a&&this.ia.set(r.id,a),this.sa.set(r.id,r);const c=this.ra.get(r.id);c&&(c.lastPosition=r,c.lastTime=i,a)&&st(a.clientX,a.clientY,r.clientX,r.clientY)>this.$a&&c.longPressTimer!==null&&(window.clearTimeout(c.longPressTimer),c.longPressTimer=null),this.da&&this.da(this.Va(r,t,a,i))}this.sa.size===2?this.tc(t):this.na=null}Oa(t){if(!this.Jh())return;t.preventDefault();const i=performance.now(),s=this.Za(t.changedTouches);for(const e of s){const r=this.sa.get(e.id),h=r?this.qa(r):void 0,a=this.ra.get(e.id);a&&a.longPressTimer!==null&&(window.clearTimeout(a.longPressTimer),a.longPressTimer=null),this.pa&&this.pa(this.Va(e,t,h,i)),a&&this.ec(a,t),this.ra.delete(e.id),this.ia.delete(e.id),this.sa.delete(e.id)}this.sa.size<2&&(this.na=null)}Ha(t){if(!this.Jh())return;t.preventDefault();const i=performance.now(),s=this.Za(t.changedTouches);for(const e of s){const r=this.sa.get(e.id),h=r?this.qa(r):void 0,a=this.ra.get(e.id);a&&a.longPressTimer!==null&&(window.clearTimeout(a.longPressTimer),a.longPressTimer=null),this.va&&this.va(this.Va(e,t,h,i)),this.ra.delete(e.id),this.ia.delete(e.id),this.sa.delete(e.id)}this.sa.size<2&&(this.na=null)}Za(t){const i=[];for(let s=0;s<t.length;s+=1){const e=t.item(s);e&&i.push(this.sc(e))}return i}sc(t){return this.za(t.clientX,t.clientY,t.identifier,{id:t.identifier,x:-1,y:-1,clientX:t.clientX,clientY:t.clientY,pressure:t.force,radiusX:t.radiusX,radiusY:t.radiusY,rotationAngle:t.rotationAngle})}za(t,i,s,e){const r=Ht(this.Jh(),t,i);return{id:s,x:r.x,y:r.y,clientX:t,clientY:i,pressure:e.pressure,radiusX:e.radiusX,radiusY:e.radiusY,rotationAngle:e.rotationAngle}}Va(t,i,s,e){const r=this.ra.get(t.id),h=Array.from(this.ia.values()).map(l=>this.qa(l)),a=Array.from(this.sa.values()).map(l=>this.qa(l)),c=this.Za(i.changedTouches);return{touch:this.qa(t),previousTouch:s?this.qa(s):void 0,touches:a,previousTouches:h,changedTouches:c,deltaTime:r?e-r.lastTime:0,originalEvent:i}}Ja(){if(this.sa.size!==2)return void(this.na=null);const t=Array.from(this.sa.values()),[i,s]=t,e=st(i.x,i.y,s.x,s.y),r=Tt(i.clientX,i.clientY,s.clientX,s.clientY);this.na={ids:[i.id,s.id],initialDistance:Math.max(e,1e-4),initialAngle:r,lastScale:1,lastRotation:0}}tc(t){if(this.na||this.Ja(),!this.na)return;const[i,s]=this.na.ids,e=this.sa.get(i),r=this.sa.get(s);if(!e||!r)return;const h=st(e.x,e.y,r.x,r.y)/this.na.initialDistance,a=h-this.na.lastScale;this.wa&&Math.abs(a)>this.Sa&&(this.wa({touches:[this.qa(e),this.qa(r)],scale:h,deltaScale:a,center:this.rc(e,r),originalEvent:t}),this.na.lastScale=h);let c=Tt(e.clientX,e.clientY,r.clientX,r.clientY)-this.na.initialAngle;c=(c+180)%360-180;const l=c-this.na.lastRotation;this.ba&&Math.abs(l)>this.Ea&&(this.ba({touches:[this.qa(e),this.qa(r)],rotation:c,deltaRotation:l,center:this.rc(e,r),originalEvent:t}),this.na.lastRotation=c)}rc(t,i){const s=(t.clientX+i.clientX)/2,e=(t.clientY+i.clientY)/2,r=this.za(s,e,-1,{id:-1,x:-1,y:-1,clientX:s,clientY:e});return{x:r.x,y:r.y}}ec(t,i){const s=performance.now(),e=s-t.startTime,r=t.lastPosition.clientX-t.startPosition.clientX,h=t.lastPosition.clientY-t.startPosition.clientY,a=Math.hypot(r,h);if(!t.longPressFired&&e<=this.Ca&&a<=this.Ma)this.nc(t.lastPosition,s)&&this.ma?this.ma({touch:this.qa(t.lastPosition),taps:2,originalEvent:i}):this.ga&&this.ga({touch:this.qa(t.lastPosition),taps:1,originalEvent:i});else if(!t.longPressFired&&e<=this.Ta&&a>=this.Pa){const c=Math.max(a,1e-4),l={x:r/c,y:h/c},u={x:r/e,y:h/e};this.ya&&this.ya({touch:this.qa(t.lastPosition),direction:l,distance:c,velocity:u,originalEvent:i})}this.ka=s,this.Ra=this.qa(t.lastPosition)}nc(t,i){return!this.Ra||i-this.ka>this.xa?!1:st(t.clientX,t.clientY,this.Ra.clientX,this.Ra.clientY)<=this.Ma}qa(t){return{...t}}}const Hi=Object.freeze(Object.defineProperty({__proto__:null,TouchManager:Qt},Symbol.toStringTag,{value:"Module"}));class K extends ft{constructor(i,s,e,r,h,a,c,l,u){super(i,s,e,r,h,a,c,l);o(this,"hc");this.hc=u}static oc(i,s,e,r,h){const a=i.context,{texture:c,width:l,height:u}=yt(a,e);return new K(a,i,c,s,l,u,r,h,e)}update(){this.hc instanceof HTMLVideoElement?this.hc.readyState>=this.hc.HAVE_CURRENT_DATA&&et(this.$,this.Hn,this.hc):et(this.$,this.Hn,this.hc)}V(){return this.L=null,super.V()}yh(){this.update()}get source(){return this.hc}}class D extends K{constructor(t,i,s,e,r,h,a,c,l){super(t,i,s,e,h,a,c,l,r)}dispose(){super.dispose(),this.ac.pause(),this.ac.src="",this.ac.load()}static async cc(t){const i=document.createElement("video");return i.crossOrigin="anonymous",i.loop=!0,i.muted=!0,i.playsInline=!0,await new Promise((s,e)=>{i.addEventListener("loadedmetadata",()=>s(),{once:!0}),i.addEventListener("error",r=>{var a;const h=r.target;e(new Error(`Failed to load video: ${((a=h.error)==null?void 0:a.message)||"Unknown error"}`))},{once:!0}),i.src=t}),i}static oc(t,i,s,e,r){const h=t.context,{texture:a,width:c,height:l}=yt(h,s,h.LINEAR,h.LINEAR,h.CLAMP_TO_EDGE,h.CLAMP_TO_EDGE);return new D(h,t,a,i,s,c,l,e,r)}static async Mh(t,i,s,e,r){const h=await D.cc(s);return D.oc(t,i,h,e,r)}async play(){await this.ac.play()}pause(){this.ac.pause()}stop(){this.ac.pause(),this.ac.currentTime=0}speed(t){return this.ac.playbackRate=t,this}loop(t=!0){return this.ac.loop=t,this}time(t){return this.ac.currentTime=t,this}volume(t){return this.ac.volume=I(t,0,1),this}get videoElement(){return this.ac}get currentTime(){return this.ac.currentTime}get duration(){return this.ac.duration}get isPlaying(){return!this.ac.paused&&!this.ac.ended}get ac(){return this.hc}}async function dt(n){if(n.startsWith("./")||n.startsWith("../")||n.endsWith(".vert")||n.endsWith(".frag")||n.endsWith(".glsl")){const t=await fetch(n);if(!t.ok)throw new Error(`Failed to load shader from ${n}: ${t.statusText}`);return await t.text()}return n}const Gi=n=>class extends n{rotate(t=0,i=0,s=0){this.R.state.Jt(t),this.R.state.te(i),this.R.state.ee(s)}rotateX(t){if(t===void 0)return it(this.R.state.rotationX);this.R.state.Jt(t)}rotateY(t){if(t===void 0)return it(this.R.state.rotationY);this.R.state.te(t)}rotateZ(t){if(t===void 0)return it(this.R.state.rotationZ);this.R.state.ee(t)}translate(t=0,i=0,s=0){this.R.state.se(t,i,s)}translateX(t){if(t===void 0)return this.R.state.translationX;this.R.state.se(t,0,0)}translateY(t){if(t===void 0)return this.R.state.translationY;this.R.state.se(0,t,0)}translateZ(t){if(t===void 0)return this.R.state.translationZ;this.R.state.se(0,0,t)}ortho(){this.R.state.ve(!0)}push(){this.R.state.K()}pop(){this.R.state.W()}color(t,i,s,e){return E.En(t,i,s,e)}rect(t=1,i=1){this.R.Ii(t,i)}point(){this.R.Ii(1,1)}line(t,i,s,e){this.R.Gi(t,i,s,e)}lineWeight(t){if(t===void 0)return this.R.state.lineWeight;this.R.state.qt(t)}background(t,i,s,e=255){if(t===void 0){const[h,a,c,l]=this.R.state.canvasBackgroundColor;return E.On(h,a,c,l)}const r=E.En(t,i,s,e);this.R.Ki(r.r,r.g,r.b,r.a)}char(t){if(t===void 0)return this.R.state.characterString;let i;typeof t=="number"?i=this.font.characters[t].character:i=t;const s=Array.from(i);if(s.length===0)throw new Error("char() requires at least one character.");const e=s[0];this.R.state.he(this.font.Vr(e)),this.R.state.oe(e)}Xt(t,i,s,e){if(t===void 0){const[h,a,c,l]=this.R.state.charColor;return E.On(h,a,c,l)}const r=E.En(t,i,s,e);this.R.state.ae(r.r,r.g,r.b,r.a)}charColor(t,i,s,e){return this.Xt(t,i,s,e)}stroke(t,i,s,e){return this.Xt(t,i,s,e)}Yt(t,i,s,e){if(t===void 0){const[h,a,c,l]=this.R.state.cellColor;return E.On(h,a,c,l)}const r=E.En(t,i,s,e);this.R.state.ce(r.r,r.g,r.b,r.a)}cellColor(t,i,s,e){return this.Yt(t,i,s,e)}fill(t,i,s,e){return this.Yt(t,i,s,e)}flipX(t){if(t===void 0)return this.R.state.flipX;this.R.state.le(t)}flipY(t){if(t===void 0)return this.R.state.flipY;this.R.state.ue(t)}charRotation(t){if(t===void 0)return 360*this.R.state.charRotation;this.R.state.de(t)}invert(t){if(t===void 0)return this.R.state.invert;this.R.state.fe(t)}clear(){this.R.Cs(0,0,0,0)}ellipse(t=1,i=1){this.R.Ni(t/2,i/2)}triangle(t,i,s,e,r,h){this.R.ji(t,i,s,e,r,h)}bezierCurve(t,i,s,e,r,h,a,c){this.R.Qi(t,i,s,e,r,h,a,c)}arc(t,i,s,e){this.R.Xi(t/2,i/2,s,e)}shader(t){this.R.Ri(t)}resetShader(){this.R.Li()}setUniform(t,i){this.R._t(t,i)}setUniforms(t){this.R.gt(t)}async createFilterShader(t){const i=await dt(t),s=this.R.Di(i);return this.lc(s),s}async createShader(t,i){const s=await dt(t),e=await dt(i),r=this.R.ki(s,e);return this.lc(r),r}createFramebuffer(t){const i=this.R.Yi(t.width??this.grid.cols,t.height??this.grid.rows,t.attachments??3);return this.lc(i),i}image(t,i,s){this.R.Oi(t,i,s,this.font),t instanceof $&&this.R.Z()}async loadImage(t){const i=t,s=new Promise((a,c)=>{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>a(l),l.onerror=u=>c(u),l.src=i}),[e]=await Promise.all([s,this.uc]),r=this.grid;if(!r)throw new Error("[textmode.js] Cannot load image before grid initialization completes.");const h=W.Mh(this.R,this.jn,e,r.cols,r.rows);return this.lc(h),h}async loadVideo(t){const[i]=await Promise.all([D.cc(t),this.uc]),s=this.grid;if(!s)throw new Error("[textmode.js] Cannot load video before grid initialization completes.");const e=D.oc(this.R,this.jn,i,s.cols,s.rows);return this.lc(e),e}createTexture(t){const i=this.grid,s=K.oc(this.R,this.jn,t,(i==null?void 0:i.cols)??1,(i==null?void 0:i.rows)??1);return this.lc(s),s}},ji=n=>class extends n{get frameCount(){return this.fc.Kh}set frameCount(t){this.fc.Kh=t}frameRate(t){return t===void 0?this.fc.Xh:this.fc.Nh(t,()=>this.dc())}targetFrameRate(t){if(t===void 0)return this.fc.Yh;this.fc.Yh=t}noLoop(){this.fc.Ih()}loop(){this.fc.Gh(()=>this.dc())}redraw(t=1){if(At.m(typeof t=="number"&&t>0&&Number.isInteger(t),"Redraw count must be a positive integer.",{method:"redraw",providedValue:t}))for(let i=0;i<t;i++)this.dc()}isLooping(){return this.fc.Qh}get millis(){return this.fc.Zh}set millis(t){this.fc.Zh=t}get secs(){return this.fc.qh}set secs(t){this.fc.qh=t}deltaTime(){return this.fc.Vh}},Qi=n=>class extends n{constructor(...t){super(...t)}mouseClicked(t){this.ea.So(t)}mousePressed(t){this.ea.Eo(t)}mouseReleased(t){this.ea.ko(t)}mouseMoved(t){this.ea.Ro(t)}mouseScrolled(t){this.ea.Lo(t)}get mouse(){return this.ea.Do()}cursor(t){this.ea.wo(t)}},Vi=n=>class extends n{constructor(...t){super(...t)}touchStarted(t){this.vc.Ia(t)}touchMoved(t){this.vc.Ro(t)}touchEnded(t){this.vc.Ga(t)}touchCancelled(t){this.vc.Na(t)}tap(t){this.vc.ja(t)}doubleTap(t){this.vc.Qa(t)}longPress(t){this.vc.Xa(t)}swipe(t){this.vc.Ya(t)}pinch(t){this.vc.Ka(t)}rotateGesture(t){this.vc.Wa(t)}get touches(){return this.vc.Ba()}},$i=n=>class extends n{constructor(...t){super(...t)}keyPressed(t){this.gc.Eo(t)}keyReleased(t){this.gc.ko(t)}isKeyPressed(t){return this.gc.Ko(t)}get lastKeyPressed(){return this.gc.Zo()}get lastKeyReleased(){return this.gc.qo()}get pressedKeys(){return this.gc.Vo()}get modifierState(){return this.gc.Jo()}};class Vt{constructor(t){o(this,"mc");o(this,"_c",new Map);o(this,"yc",[]);o(this,"wc",new Map);o(this,"bc",new Map);o(this,"Cc",new Map);o(this,"xc",new Map);o(this,"Mc",new Map);o(this,"Fc",new Map);o(this,"$c",new Map);o(this,"Pc",new Map);this.mc=t}Tc(t){for(const i of t){if(this._c.has(i.name))return void console.warn(`[textmode.js] Plugin "${i.name}" is already installed.`);const s=this.Sc(i.name);try{const e=i.install(this.mc,s);e instanceof Promise&&e.catch(r=>{console.error(`[textmode.js] Async plugin "${i.name}" installation error:`,r),this.Ec(i.name)})}catch(e){throw this.Ec(i.name),e}this._c.set(i.name,i),this.yc.push(i.name)}}async kc(t){for(const i of t){if(this._c.has(i.name))return void console.warn(`[textmode.js] Plugin "${i.name}" is already installed.`);const s=this.Sc(i.name);try{await i.install(this.mc,s)}catch(e){throw this.Ec(i.name),e}this._c.set(i.name,i),this.yc.push(i.name)}}async Rc(t){const i=this._c.get(t);if(!i)return;const s=this.Sc(t);i.uninstall&&await i.uninstall(this.mc,s),this._c.delete(t),this.yc.splice(this.yc.indexOf(t),1),this.Ec(t)}Lc(){this.Dc(this.wc,t=>t())}Oc(){this.Dc(this.bc,t=>t())}Hc(t){this.Dc(this.Cc,i=>i(t))}zc(t){this.Dc(this.xc,i=>i(t))}Bc(t){this.Dc(this.Mc,i=>i(t))}async Ic(){await this.Gc(this.Fc,t=>t())}async Nc(){await this.Gc(this.$c,t=>t())}async jc(){const t=[...this._c.keys()];for(const i of t)await this.Rc(i)}Sc(t){const i=this.mc,s=this;return{get renderer(){return i.R},get canvas(){return i.nn},get layerManager(){return i.layers},get font(){return i.layers.base.font},get grid(){return i.layers.base.grid},get drawFramebuffer(){return i.layers.base.drawFramebuffer},get asciiFramebuffer(){return i.layers.base.asciiFramebuffer},registerPreDrawHook:e=>s.Qc(s.wc,t,e),registerPostDrawHook:e=>s.Qc(s.bc,t,e),registerLayerDisposedHook:e=>s.Qc(s.Cc,t,e),registerLayerPreRenderHook:e=>s.Qc(s.xc,t,e),registerLayerPostRenderHook:e=>s.Qc(s.Mc,t,e),registerPreSetupHook:e=>s.Qc(s.Fc,t,e),registerPostSetupHook:e=>s.Qc(s.$c,t,e),extendLayer:(e,r)=>{s.Xc(t,e,r)},removeLayerExtension:e=>{s.Yc(t,e)}}}Qc(t,i,s){const e=t.get(i)??new Set;return e.add(s),t.set(i,e),()=>{const r=t.get(i);r&&(r.delete(s),r.size===0&&t.delete(i))}}Ec(t){this.wc.delete(t),this.bc.delete(t),this.Cc.delete(t),this.xc.delete(t),this.Mc.delete(t),this.Fc.delete(t),this.$c.delete(t);const i=this.Pc.get(t);if(i){for(const s of i.keys())this.Kc(s);this.Pc.delete(t)}}Dc(t,i){for(const s of this.yc){const e=t.get(s);e&&e.forEach(i)}}async Gc(t,i){for(const s of this.yc){const e=t.get(s);if(e)for(const r of e)await i(r)}}Xc(t,i,s){let e=this.Pc.get(t);e||(e=new Map,this.Pc.set(t,e));for(const[r,h]of this.Pc)r!==t&&h.has(i)&&console.warn(`[textmode.js] Plugin "${t}" is overwriting layer method "${i}" previously added by plugin "${r}".`);e.set(i,s),this.Wc(i,s)}Yc(t,i){const s=this.Pc.get(t);if(!s)return;s.delete(i);let e=!1;for(const[r,h]of this.Pc)if(r!==t&&h.has(i)){e=!0;const a=h.get(i);this.Wc(i,a);break}e||this.Kc(i)}Wc(t,i){const s=Object.getPrototypeOf(this.mc.layers.base);Object.defineProperty(s,t,{value:i,writable:!0,configurable:!0,enumerable:!1})}Kc(t){const i=Object.getPrototypeOf(this.mc.layers.base),s=Object.getOwnPropertyDescriptor(i,t);s&&s.configurable&&delete i[t]}}const Zi=Object.freeze(Object.defineProperty({__proto__:null,TextmodePluginManager:Vt},Symbol.toStringTag,{value:"Module"})),J=`#version 300 es
layout(location=0)in vec2 A;layout(location=1)in vec2 B;out vec2 v_uv;void main(){v_uv=B;gl_Position=vec4(A,0.,1.);}`,$t=`#version 300 es
precision highp float;uniform sampler2D u_texture;in vec2 v_uv;out vec4 fragColor;void main(){fragColor=texture(u_texture,v_uv);}`;class Zt{constructor(){o(this,"Zc",new Map);o(this,"qc",[]);o(this,"Vc",0);o(this,"Jc",0);o(this,"tl")}get el(){return this.Vc}get sl(){if(this.Vc===0)return 0;let t=0;for(const i of this.qc){const s=this.Zc.get(i);s&&(t+=I(s.progress,0,1)*s.weight)}return Math.min(1,t/this.Vc)}il(t){this.tl=t}rl(t,i=1){const s=`phase-${this.qc.length+1}-${Date.now()}`,e={id:s,label:t,weight:Math.max(.001,i),progress:0,status:"running"};return this.Zc.set(s,e),this.qc.push(s),this.Vc+=e.weight,s}nl(t,i){const s=this.Zc.get(t);if(!s)return;s.progress=I(i,0,1),s.status=s.progress>=1?"complete":"running";const e=this.sl;Math.abs(e-this.Jc)>.001&&(this.Jc=e,this.tl&&this.tl(e))}hl(t){const i=this.Zc.get(t);i&&(i.progress=1,i.status="complete",this.nl(t,1))}ol(t){const i=this.Zc.get(t);i&&(i.status="failed")}al(){return this.qc.map(t=>{const i=this.Zc.get(t);return i?{id:i.id,label:i.label,weight:i.weight,progress:i.progress,status:i.status}:{id:t,label:t,weight:1,progress:0,status:"pending"}})}}class qt{constructor(t="active"){o(this,"cl");o(this,"ll","");o(this,"ul","");this.cl=t}get fl(){return this.cl}get dl(){return this.cl!=="disabled"}get pl(){return this.cl==="active"||this.cl==="transitioning"||this.cl==="error"}get vl(){return this.ll}get ml(){return this.ul}_l(){this.cl!=="done"&&this.cl!=="transitioning"||(this.cl="active")}yl(){this.cl!=="disabled"&&(this.cl="done")}wl(){this.cl!=="disabled"&&(this.cl="transitioning")}Al(){this.cl==="transitioning"&&(this.cl="done")}bl(t){this.cl!=="disabled"&&(this.cl="error",t instanceof Error?(this.ll=t.message,this.ul=t.stack||""):(this.ll=t,this.ul=""))}Cl(){this.cl="disabled"}}class Wt{constructor(t,i){o(this,"xl",0);o(this,"Ml",1);o(this,"Fl");o(this,"$l");this.Fl=t,this.$l=i}get Pl(){return this.Ml}get Tl(){return this.Ml<1}zh(){this.Fl!=="none"&&this.$l>0&&(this.xl=performance.now())}j(){if(this.Fl==="none"||this.$l===0)return this.Ml=1,!1;const t=performance.now()-this.xl,i=Math.min(1,t/this.$l);return i>=1?(this.Ml=0,!0):(this.Ml=1-i,!1)}He(){this.Ml=1,this.xl=0}}function Rt(n,t){const i=n.tone??"auto";let s="dark";return i==="light"||i==="dark"?s=i:t&&(s=function(e){if(!e)return 0;const[r,h,a]=e.map(l=>l/255),c=l=>l<=.04045?l/12.92:Math.pow((l+.055)/1.055,2.4);return .2126*c(r)+.7152*c(h)+.0722*c(a)}(t)>.5?"light":"dark"),{mode:s,background:t,textColor:s==="light"?"#1A1A1A":"#F8F8F8",subtleColor:s==="light"?"#4A4A4A":"#C0C0C0"}}function Kt(n){return n.mode==="light"?["#E91E63","#9C27B0","#FF6F00"]:["#8EF9F3","#F15BB5","#FF9B71"]}function Jt(n,t){return n.length?n.map(i=>E.En(i)):[t.color("#FFFFFF")]}class ti{constructor(t,i,s,e){this.Sl=t,this.id=i,this.label=s,this.El=e}report(t){this.Sl.nl(this.id,t)}complete(){this.Sl.hl(this.id)}fail(t){this.Sl.ol(this.id),this.El&&this.El(t??new Error(`Loading phase "${this.label}" failed`))}async track(t){try{const i=typeof t=="function"?await t():await t;return this.complete(),i}catch(i){throw this.fail(i instanceof Error?i:String(i)),i}}}const qi=({textmodifier:n,grid:t,progress:i,frameCount:s,message:e,palette:r,theme:h,phases:a,transitionOpacity:c,isError:l,errorMessage:u})=>{const f="|/-\\",m=Math.floor(s/6)%4,p=E.En(h.textColor),g=Math.floor(255*c),d=n.color(p.r,p.g,p.b,g);if(n.charColor(d),n.cellColor(0,0,0,0),l){const v=E.En(h.mode==="light"?"#D32F2F":"#FF6B6B").withAlpha(g);n.charColor(v),n.push(),n.translate(0,-2,0),n.char("X"),n.rect(1,1),n.pop();const w="SETUP ERROR",A=-Math.floor(w.length/2);n.push(),n.translate(A,0,0);for(const y of w)n.char(y),n.rect(1,1),n.translateX(1);if(n.pop(),u){const y=E.En(h.subtleColor),b=n.color(y.r,y.g,y.b,g);n.charColor(b);const T=Math.floor(.8*t.cols),M=u.split(" "),S=[];let F="";for(const L of M)(F+" "+L).length<=T?F=F?F+" "+L:L:(F&&S.push(F),F=L);F&&S.push(F);const U=S.slice(0,3);S.length>3&&(U[2]=U[2].substring(0,T-3)+"..."),U.forEach((L,pt)=>{const cs=-Math.floor(L.length/2);n.push(),n.translate(cs,3+pt,0);for(const ls of L)n.char(ls),n.rect(1,1),n.translateX(1);n.pop()})}return}if(n.push(),n.translate(0,0,0),n.char(f[m]),n.rect(1,1),n.pop(),i>0||a.some(v=>v.status!=="pending")){const v=Math.max(6,Math.floor(.6*t.cols)),w=-Math.floor(v/2),A=Math.floor(v*i),y=r.length?r:[n.color("#FFFFFF")];n.push(),n.translate(w,3,0);for(let b=0;b<v;b++){const T=b<A?"*":".",M=y[b%y.length],S=n.color(M.r,M.g,M.b,g);n.charColor(S),n.char(T),n.rect(1,1),n.translateX(1)}n.pop()}if(e){const v=E.En(h.subtleColor),w=n.color(v.r,v.g,v.b,g);n.charColor(w);const A=-Math.floor(e.length/2);n.push(),n.translate(A,5,0);for(const y of e)n.char(y),n.rect(1,1),n.translateX(1);n.pop()}};class gt{constructor(t,i={}){o(this,"kl");o(this,"Pl");o(this,"Rl");o(this,"Ll");o(this,"Dl");o(this,"Ol");o(this,"Hl");o(this,"zl");o(this,"Bl");o(this,"Il");o(this,"kr");o(this,"Gl");o(this,"Nl");o(this,"jl");o(this,"Ql");o(this,"Xl",()=>{});o(this,"Yl",[]);o(this,"Kl",new Map);this.kl=i.visible??!0,this.Pl=i.opacity??1,this.Rl=i.blendMode??"normal",this.Ll=i.offsetX??0,this.Dl=i.offsetY??0,this.Ol=i.rotationZ??0,this.Hl=i.fontSize??16,this.zl=i.fontSource,i.fontSource instanceof Q?this.kr=i.fontSource:this.kr=new Q(t,this.Hl)}async Wl(t){this.Bl=t,this.kr.tn||await this.kr.jr(this.zl);const i=this.kr.maxGlyphDimensions;this.Il=new Dt(this.Bl.canvas.canvas,i.width,i.height);const s=this.Il;this.Gl=this.Bl.createFramebuffer(s.cols,s.rows,3),this.Nl=this.Bl.createFramebuffer(s.width,s.height,1),this.jl=this.Bl.createFramebuffer(s.width,s.height,1),this.Ql=[this.Bl.createFramebuffer(s.width,s.height,1,{depth:!1}),this.Bl.createFramebuffer(s.width,s.height,1,{depth:!1})],this.Il.fn(()=>{var e,r,h;this.Gl.resize(this.Il.cols,this.Il.rows),this.Nl.resize(this.Il.width,this.Il.height),(e=this.jl)==null||e.resize(this.Il.width,this.Il.height),(r=this.Ql)==null||r[0].resize(this.Il.width,this.Il.height),(h=this.Ql)==null||h[1].resize(this.Il.width,this.Il.height)})}draw(t){this.Xl=t}show(){this.kl=!0}hide(){this.kl=!1}opacity(t){if(t===void 0)return this.Pl;this.Pl=I(t,0,1)}blendMode(t){if(t===void 0)return this.Rl;this.Rl=t}offset(t,i=0){if(t===void 0)return{x:this.Ll,y:this.Dl};this.Ll=t,this.Dl=i}rotateZ(t){if(t===void 0)return this.Ol;this.Ol=t}filter(t,i){this.Yl.push({name:t,params:i})}setPluginState(t,i){this.Kl.set(t,i)}getPluginState(t){return this.Kl.get(t)}hasPluginState(t){return this.Kl.has(t)}deletePluginState(t){return this.Kl.delete(t)}fontSize(t){if(t===void 0)return this.kr.fontSize;At.m(typeof t=="number"&&t>0,"Font size must be a positive number greater than 0.",{method:"fontSize",providedValue:t})&&this.kr.fontSize!==t&&(this.kr.Yr(t),this.Zl())}async loadFont(t){if(!this.kr)throw new Error("Layer font not initialized. Ensure layer is attached before loading fonts.");return t instanceof Q?(this.kr!==t&&this.kr.dispose(),this.kr=t,this.kr.tn||await this.kr.jr()):await this.kr.Wr(t),this.Zl(),this.kr}dc(t,i){if(!this.kl||!this.Gl||!this.Nl)return;const s=this.Bl.renderer,e=this.Il;t.ql.zc(this),this.Gl.begin(),s.state.Vt(),t.Vl=this;try{this.Xl.call(t)}finally{t.Vl=void 0}this.Gl.end(),t.ql.Bc(this);const r=this.Yl.length>0,h=r?this.jl:this.Nl;h.begin(),s.Pi(i),i.gt({u_characterTexture:this.kr.fontFramebuffer,u_charsetDimensions:[this.kr.textureColumns,this.kr.textureRows],Ud:this.Gl.textures[0],Ue:this.Gl.textures[1],Uf:this.Gl.textures[2],Ug:[e.cols,e.rows],Uh:[h.width,h.height],Ui:[0,0,0,0]}),s.Bi(0,0,e.width,e.height),h.end(),r&&this.Bl.filterManager.Jl(this.jl.textures[0],this.Nl,this.Yl,this.Nl.width,this.Nl.height,this.Ql),this.Yl=[]}$n(){var t;this.Gl&&this.Nl&&((t=this.Il)==null||t.reset())}xe(){var t,i,s,e,r,h,a;(t=this.Gl)==null||t.dispose(),(i=this.Nl)==null||i.dispose(),(s=this.jl)==null||s.dispose(),(e=this.Ql)==null||e[0].dispose(),(r=this.Ql)==null||r[1].dispose(),(h=this.kr)==null||h.dispose(),(a=this.Il)==null||a.xe()}get texture(){var t;return(t=this.Nl)==null?void 0:t.textures[0]}get grid(){return this.Il}get font(){return this.kr}get width(){return this.Nl?this.Nl.width:0}get height(){return this.Nl?this.Nl.height:0}get drawFramebuffer(){return this.Gl}get asciiFramebuffer(){return this.Nl}Zl(){if(!this.Il||!this.kr)return;const t=this.kr.maxGlyphDimensions;this.Il.pn(t.width,t.height),this.Gl&&this.Nl&&this.$n()}}const Wi={message:"LOADING...",tone:"auto",transition:"fade",transitionDuration:500};class ii{constructor(t,i,s){o(this,"mc");o(this,"l");o(this,"tu");o(this,"Sl");o(this,"eu");o(this,"su");o(this,"iu");o(this,"ru");o(this,"nu",[]);o(this,"hu");o(this,"ou",performance.now());o(this,"au",0);o(this,"cu",!1);o(this,"Nr",!1);o(this,"du");this.mc=t,this.l={...Wi,...i??{}},this.tu=new qt("active"),this.Sl=new Zt,this.eu=new Wt(this.l.transition,this.l.transitionDuration),this.su=new Xt(60),this.hu=Rt(this.l,s);const e=Kt(this.hu);this.nu=Jt(e,this.mc),this.ru=this.lu(),this.Sl.il(r=>{r>=.999&&this.yl()})}async jr(){if(this.Nr)return;const t=this.mc.R,i=this.mc.nn;this.iu=new gt(t,{visible:!0,opacity:1,fontSize:16}),await this.iu.Wl({renderer:t,canvas:i,filterManager:null,createFramebuffer:(s,e,r=1,h)=>t.Yi(s,e,r,h)}),this.Nr=!0}get pl(){return this.tu.pl&&this.cu}zh(){this.cu||(this.cu=!0,this.ou=performance.now(),this.au=0,this.su.zh(()=>this.uu()))}Bh(){this.cu&&(this.cu=!1,this.su.Bh())}$n(){this.Nr&&this.iu.$n()}xe(){this.Bh(),this.Nr&&(this.iu.xe(),this.Nr=!1)}get progress(){return this.Sl.sl}message(t){return typeof t=="string"&&(this.l.message=t),this.l.message}addPhase(t,i=1){this.tu._l();const s=this.Sl.rl(t,i);return new ti(this.Sl,s,t,e=>this.error(e))}yl(){this.tu.fl!=="error"&&(this.l.transition!=="none"&&this.l.transitionDuration>0?(this.tu.wl(),this.eu.zh()):(this.tu.yl(),this.Bh(),this.fu()))}fu(){this.du&&this.du()}pu(t){this.du=t}error(t){this.tu.bl(t)}uu(){if(this.tu.pl){if(this.au++,this.tu.fl==="transitioning"&&this.eu.j())return this.tu.Al(),this.fu(),void this.Bh();this.vu()}}vu(){if(!this.Nr)return;const t=this.iu,i=t.grid,s=this.mc.R,e={textmodifier:this.mc,grid:i,progress:this.progress,elapsedMs:performance.now()-this.ou,frameCount:this.au,message:this.l.message,palette:this.nu,theme:this.hu,phases:this.Sl.al(),transitionOpacity:this.eu.Pl,isError:this.tu.fl==="error",errorMessage:this.tu.vl||void 0,errorDetails:this.tu.ml||void 0};t.draw(()=>{this.mc.resetShader(),this.mc.clear(),this.mc.push();try{this.ru(e)}finally{this.mc.pop()}}),t.dc(this.mc,this.mc.gu);const r=t.texture;r&&(s.Cs(...s.state.canvasBackgroundColor),s.Pi(this.mc.mu),this.mc.mu.gt({u_texture:r}),s.Bi(i.offsetX,i.offsetY,i.width,i.height))}_u(t){this.hu=Rt(this.l,t)}lu(){const t=this.l.renderer||qi;return i=>{t(i),this.yu(i)}}yu(t){const{textmodifier:i,grid:s,frameCount:e,theme:r,transitionOpacity:h}=t,a=[116,101,120,116,109,111,100,101,46,106,115].map(f=>String.fromCharCode(f)).join(""),c=(s.rows+1>>1)-2,l=2-(s.cols+1>>1),u=r.mode==="light"?[[233,30,99],[156,39,176],[255,111,0]]:[[142,249,243],[241,91,181],[255,155,113]];i.push(),i.translate(l,c,0);for(let f=0;f<a.length;f++){const m=a[f],p=Math.floor(.1*e+.5*f)%u.length,[g,d,v]=u[p],w=Math.floor(255*h),A=i.color(g,d,v,w);i.charColor(A),i.char(m),i.point(),i.translateX(1)}i.pop()}}const si={normal:0,additive:1,multiply:2,screen:3,subtract:4,darken:5,lighten:6,overlay:7,softLight:8,hardLight:9,colorDodge:10,colorBurn:11,difference:12,exclusion:13};class ei{constructor(t,i,s){o(this,"R");o(this,"wu");o(this,"Ql");o(this,"Au",0);this.R=t,this.wu=t.ki(J,`#version 300 es
precision highp float;uniform sampler2D Uj;uniform sampler2D Uk;uniform vec2 Ul;uniform vec2 Um;uniform vec2 Un;uniform float Uo;uniform float Up;uniform int Uq;in vec2 v_uv;out vec4 fragColor;const int A=0;const int B=1;const int C=2;const int D=3;const int E=4;const int F=5;const int G=6;const int H=7;const int I=8;const int J=9;const int K=10;const int L=11;const int M=12;const int N=13;vec3 O(vec3 P,vec3 Q){return Q;}vec3 R(vec3 P,vec3 Q){return P+Q;}vec3 S(vec3 P,vec3 Q){return P*Q;}vec3 T(vec3 P,vec3 Q){return 1.-(1.-P)*(1.-Q);}vec3 U(vec3 P,vec3 Q){return max(P-Q,0.);}vec3 V(vec3 P,vec3 Q){return min(P,Q);}vec3 W(vec3 P,vec3 Q){return max(P,Q);}vec3 X(vec3 P,vec3 Q){return mix(2.*P*Q,1.-2.*(1.-P)*(1.-Q),step(0.5,P));}vec3 Y(vec3 P,vec3 Q){return mix(P-(1.-2.*Q)*P*(1.-P),mix(P+(2.*Q-1.)*(P*(3.-2.*P)-P),P+(2.*Q-1.)*(sqrt(P)-P),step(0.25,P)),step(0.5,Q));}vec3 Z(vec3 P,vec3 Q){return mix(2.*P*Q,1.-2.*(1.-P)*(1.-Q),step(0.5,Q));}vec3 a(vec3 P,vec3 Q){return mix(min(vec3(1.),P/max(1.-Q,0.0001)),vec3(1.),step(1.,Q));}vec3 b(vec3 P,vec3 Q){return mix(1.-min(vec3(1.),(1.-P)/max(Q,0.0001)),vec3(0.),step(Q,vec3(0.)));}vec3 c(vec3 P,vec3 Q){return abs(P-Q);}vec3 d(vec3 P,vec3 Q){return P+Q-2.*P*Q;}vec3 e(int f,vec3 P,vec3 Q){if(f==A)return O(P,Q);if(f==B)return R(P,Q);if(f==C)return S(P,Q);if(f==D)return T(P,Q);if(f==E)return U(P,Q);if(f==F)return V(P,Q);if(f==G)return W(P,Q);if(f==H)return X(P,Q);if(f==I)return Y(P,Q);if(f==J)return Z(P,Q);if(f==K)return a(P,Q);if(f==L)return b(P,Q);if(f==M)return c(P,Q);if(f==N)return d(P,Q);return O(P,Q);}void main(){vec4 g=texture(Uk,v_uv);vec2 h=v_uv*Ul;vec2 i=h-Un;vec2 j=Um*0.5;vec2 k=i-j;float l=cos(-Up);float m=sin(-Up);vec2 n=vec2(k.x*l-k.y*m,k.x*m+k.y*l);i=n+j;bool o=any(lessThan(i,vec2(0.)))||any(greaterThanEqual(i,Um));if(o){fragColor=g;return;}vec2 p=(floor(i)+0.5)/Um;vec4 q=texture(Uj,p);float r=q.a*Uo;if(r<=0.){fragColor=g;return;}vec3 s=e(Uq,g.rgb,q.rgb);vec3 t=mix(g.rgb,s,r);float u=g.a+r*(1.-g.a);fragColor=vec4(t,u);}`),this.Ql=[this.R.Yi(i,s,1),this.R.Yi(i,s,1)]}bu(t){const{base:i,targetFramebuffer:s,backgroundColor:e,layers:r,canvasWidth:h,canvasHeight:a}=t,c=this.R.Ji(),l=this.R.tr();this.R.qi(!1),this.R.Vi(!1);const u=this.Ql[0];u.begin(),this.R.Cs(...e),u.end(),this.Au=0,i.layer.kl&&this.Cu(i.texture,h,a,i.width,i.height,i.layer.Pl,i.offsetX,i.offsetY,i.layer.Ol,"normal");for(const f of r){const m=f.layer;m.kl&&this.Cu(f.texture,h,a,f.width,f.height,m.Pl,f.offsetX,f.offsetY,m.Ol,m.Rl)}this.xu(s,h,a),this.R.Vi(l),this.R.qi(c)}Cu(t,i,s,e,r,h,a,c,l,u){const f=this.Ql[this.Au],m=this.Au===0?1:0,p=this.Ql[m],g=k(l);p.begin(),this.R.Pi(this.wu),this.wu.gt({Uj:t,Uk:f.textures[0],Ul:[i,s],Um:[e,r],Un:[a,c],Uo:h,Up:g,Uq:si[u]}),this.R.Bi(0,0,f.width,f.height),p.end(),this.Au=m}xu(t,i,s){const e=this.Ql[this.Au];t.begin(),this.R.Pi(this.wu),this.wu.gt({Uj:e.textures[0],Uk:e.textures[0],Ul:[i,s],Um:[e.width,e.height],Un:[0,0],Uo:1,Up:0,Uq:si.normal}),this.R.Bi(0,0,i,s),t.end()}$n(t,i){this.Ql[0].resize(t,i),this.Ql[1].resize(t,i)}xe(){this.wu.dispose(),this.Ql[0].dispose(),this.Ql[1].dispose()}}class Ki{constructor(t={}){o(this,"Mu",[]);o(this,"Fu",[]);o(this,"$u",!1);o(this,"l");this.l=t}async initialize(t){var i,s;for(const e of this.Fu)t&&await t(e),this.Mu.push(e),(s=(i=this.l).onAdd)==null||s.call(i,e);this.Fu=[],this.$u=!0}get isReady(){return this.$u}add(t){var i,s;return this.$u?(this.Mu.push(t),(s=(i=this.l).onAdd)==null||s.call(i,t)):this.Fu.push(t),t}addMany(t){for(const i of t)this.add(i);return t}remove(t){const i=this.Mu.indexOf(t);if(i!==-1)return this.Mu.splice(i,1),this.Pu(t),!0;const s=this.Fu.indexOf(t);return s!==-1&&(this.Fu.splice(s,1),this.Pu(t),!0)}removeAt(t){if(t<0||t>=this.Mu.length)return;const[i]=this.Mu.splice(t,1);return this.Pu(i),i}move(t,i){var r,h;const s=this.Mu.indexOf(t);if(s!==-1){this.Mu.splice(s,1);const a=I(i,0,this.Mu.length);return this.Mu.splice(a,0,t),(h=(r=this.l).onMove)==null||h.call(r,t,s,a),!0}const e=this.Fu.indexOf(t);if(e!==-1){this.Fu.splice(e,1);const a=I(i,0,this.Fu.length);return this.Fu.splice(a,0,t),!0}return!1}swap(t,i){var a,c;if(t===i)return!0;const s=this.Mu.indexOf(t),e=this.Mu.indexOf(i);if(s!==-1&&e!==-1)return this.Mu[s]=i,this.Mu[e]=t,(c=(a=this.l).onSwap)==null||c.call(a,t,i,s,e),!0;const r=this.Fu.indexOf(t),h=this.Fu.indexOf(i);return r!==-1&&h!==-1&&(this.Fu[r]=i,this.Fu[h]=t,!0)}clear(){for(const t of this.Mu)this.Pu(t);this.Mu=[];for(const t of this.Fu)this.Pu(t);this.Fu=[]}dispose(){this.clear(),this.$u=!1}get all(){return this.Mu}get pending(){return this.Fu}get length(){return this.Mu.length}get totalLength(){return this.Mu.length+this.Fu.length}get isEmpty(){return this.Mu.length===0}get(t){return this.Mu[t]}get first(){return this.Mu[0]}get last(){return this.Mu[this.Mu.length-1]}indexOf(t){return this.Mu.indexOf(t)}has(t){return this.Mu.includes(t)||this.Fu.includes(t)}[Symbol.iterator](){return this.Mu[Symbol.iterator]()}Pu(t){var i,s,e,r;(s=(i=this.l).onRemove)==null||s.call(i,t),(r=(e=this.l).onDispose)==null||r.call(e,t)}}class ri{constructor(t){o(this,"R");o(this,"Tu",new Map);o(this,"Su",new Map);o(this,"Ks");o(this,"Ql");o(this,"Nr",!1);this.R=t,this.Ks=t.ki(J,$t),this.Eu()}async register(t,i,s={}){const e=Object.entries(s),r=e.length>0?e[0][1][0]:null;let h;if(typeof i=="string"){const c=await dt(i);h=this.R.ki(J,c),this.Su.set(t,h)}else h=i,this.Su.set(t,h);const a={id:t,createShader:()=>h,createUniforms:(c,l)=>{const u={u_resolution:[l.width,l.height]};for(const[f,[m,p]]of e){let g=p;if(c!=null){if(typeof c=="number"&&m===r)g=c;else if(typeof c=="object"&&m in c){const d=c[m];St(d)&&(g=d)}}u[f]=g}return u}};this.Tu.set(t,a)}unregister(t){const i=this.Su.get(t);return i&&(i.dispose(),this.Su.delete(t)),this.Tu.delete(t)}has(t){return this.Tu.has(t)}jr(t,i){this.Nr||(this.Ql=[this.R.Yi(t,i,1,{depth:!1}),this.R.Yi(t,i,1,{depth:!1})],this.Nr=!0)}ku(t,i,s,e,r){this.Ql[0].width===e&&this.Ql[0].height===r||(this.Ql[0].resize(e,r),this.Ql[1].resize(e,r)),this.Jl(t,i,s,e,r,this.Ql)}Jl(t,i,s,e,r,h){if(s.length===0)return void this.Ru(t,i,e,r);this.Ru(t,h[0],e,r);let a=0;for(let c=0;c<s.length;c++){const l=s[c],u=c===s.length-1,f=a===0?1:0,m=u?i:h[f];this.Lu(l,h[a],m,e,r),u||(a=f)}}Lu(t,i,s,e,r){const h=this.Tu.get(t.name);if(!h)return console.warn(`[textmode.js] Unknown filter: "${t.name}". Skipping.`),void this.Ru(i.textures[0],s,e,r);const a=this.Du(t.name,h,e,r),c={renderer:this.R,gl:this.R.context,width:e,height:r};s.begin(),this.R.Pi(a),a.gt({u_texture:i.textures[0]});const l=h.createUniforms(t.params,c);a.gt(l),this.R.Bi(0,0,e,r),s.end()}Du(t,i,s,e){let r=this.Su.get(t);if(!r&&i){const h={renderer:this.R,gl:this.R.context,width:s,height:e};r=i.createShader(h),this.Su.set(t,r)}return r}Ru(t,i,s,e){i.begin(),this.R.Pi(this.Ks),this.Ks.gt({u_texture:t,u_resolution:[s,e]}),this.R.Bi(0,0,s,e),i.end()}$n(t,i){this.Ql&&(this.Ql[0].resize(t,i),this.Ql[1].resize(t,i))}xe(){for(const t of this.Su.values())t.dispose();this.Su.clear(),this.Tu.clear(),this.Ks.dispose(),this.Ql&&(this.Ql[0].dispose(),this.Ql[1].dispose()),this.Nr=!1}Eu(){this.register("invert",`#version 300 es
precision highp float;uniform sampler2D u_texture;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);fragColor=vec4(1.-A.rgb,A.a);}`,{}),this.register("grayscale",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float U8;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);float B=dot(A.rgb,vec3(0.299,0.587,0.114));vec3 C=mix(A.rgb,vec3(B),U8);fragColor=vec4(C,A.a);}`,{U8:["amount",1]}),this.register("sepia",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float U8;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);vec3 B;B.r=dot(A.rgb,vec3(0.393,0.769,0.189));B.g=dot(A.rgb,vec3(0.349,0.686,0.168));B.b=dot(A.rgb,vec3(0.272,0.534,0.131));vec3 C=mix(A.rgb,B,U8);fragColor=vec4(C,A.a);}`,{U8:["amount",1]}),this.register("threshold",`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform float Uc;in vec2 v_uv;out vec4 fragColor;void main(){vec4 A=texture(u_texture,v_uv);float B=dot(A.rgb,vec3(0.299,0.587,0.114));float C=step(Uc,B);fragColor=vec4(vec3(C),A.a);}`,{Uc:["threshold",.5]})}}const Ji=Object.freeze(Object.defineProperty({__proto__:null,TextmodeFilterManager:ri},Symbol.toStringTag,{value:"Module"}));class ni{constructor(t,i){o(this,"mc");o(this,"R");o(this,"Ou");o(this,"Hu");o(this,"zu");o(this,"Bu");o(this,"$u",!1);o(this,"Iu",new Set);o(this,"Gu",[]);o(this,"Nu");o(this,"ju");this.mc=t,this.R=t.R,this.Hu=new ri(this.R),this.Ou=new ei(this.R,this.mc.nn.width,this.mc.nn.height),this.zu=new Ki({onRemove:s=>this.mc.ql.Hc(s),onDispose:s=>s==null?void 0:s.xe()}),this.Bu=new gt(this.R,{visible:!0,opacity:1,fontSize:i.fontSize,fontSource:i.fontSource})}async jr(){await this.Qu(this.Bu);const t=this.mc.nn;this.Nu=this.R.Yi(t.width,t.height,1),this.ju=this.R.Yi(t.width,t.height,1),this.Hu.jr(t.width,t.height),await this.zu.initialize(i=>this.Qu(i)),this.$u=!0}Xu(t,i){this.Gu.push({name:t,params:i})}Yu(){this.Gu=[]}add(t={}){const i=new gt(this.R,t);return this.zu.isReady&&this.Qu(i),this.zu.add(i),i}remove(t){this.zu.remove(t)}move(t,i){this.zu.move(t,i)}swap(t,i){this.zu.swap(t,i)}clear(){this.zu.clear()}Ku(t){this.mc.ql.Lc(),this.Bu.dc(this.mc,this.mc.gu);const i=[...this.R.state.canvasBackgroundColor];this.zu.all.forEach(s=>s.dc(this.mc,this.mc.gu)),this.Wu(t,i)}Zu(){this.Ku(this.Nu);let t=this.Nu.textures[0];if(this.Gu.length>0){const s=this.mc.nn;this.Hu.ku(this.Nu.textures[0],this.ju,this.Gu,s.width,s.height),t=this.ju.textures[0],this.Gu=[]}const i=this.mc.nn;this.R.Cs(0,0,0,0),this.R.Pi(this.mc.mu),this.mc.mu.gt({u_texture:t}),this.R.Bi(0,0,i.width,i.height),this.mc.ql.Oc()}Wu(t,i){const s=this.mc.nn,e=this.Bu.grid,r=this.Bu.texture;if(!r)return;const h={layer:this.Bu,texture:r,width:e.width,height:e.height,offsetX:e.offsetX+this.Bu.Ll,offsetY:e.offsetY+this.Bu.Dl},a=this.zu.all.filter(c=>!!c.grid&&!!c.texture).map(c=>{const l=c.grid;return{layer:c,texture:c.texture,width:l.width,height:l.height,offsetX:l.offsetX+c.Ll,offsetY:l.offsetY+c.Dl}});this.Ou.bu({base:h,layers:a,targetFramebuffer:t,backgroundColor:i,canvasWidth:s.width,canvasHeight:s.height})}$n(){var i,s,e;if(!this.$u)return;const t=this.mc.nn;this.Bu.$n(),this.zu.all.forEach(r=>r.$n()),this.Ou.$n(t.width,t.height),(i=this.Nu)==null||i.resize(t.width,t.height),(s=this.ju)==null||s.resize(t.width,t.height),(e=this.Hu)==null||e.$n(t.width,t.height)}xe(){var t,i;this.zu.dispose(),this.mc.ql.Hc(this.Bu),this.Bu.xe(),this.Hu.xe(),this.Ou.xe(),(t=this.Nu)==null||t.dispose(),(i=this.ju)==null||i.dispose(),this.Gu=[]}get all(){return this.zu.all}get base(){return this.Bu}get filters(){return this.Hu}get resultFramebuffer(){return this.ju}qu(){const t=this.zu.all;for(let i=t.length-1;i>=0;i--){const s=t[i];if(s.kl&&s.grid)return s.grid}return this.Bu.grid}Vu(t){this.Iu.add(t)}Ju(){for(const t of this.Iu)t()}async Qu(t){var s;const i={renderer:this.R,canvas:this.mc.nn,filterManager:this.Hu,createFramebuffer:(e,r,h=1,a)=>this.R.Yi(e,r,h,a)};await t.Wl(i),(s=t.grid)==null||s.fn(()=>this.Ju())}}const ts={id:"brightness",createShader:({gl:n})=>new H(n,ot,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D u_image;uniform bool u_invert;uniform bool u_flipX;uniform bool u_flipY;uniform float u_charRotation;uniform bool u_charColorFixed;uniform vec4 u_charColor;uniform bool u_cellColorFixed;uniform vec4 u_cellColor;uniform vec4 u_backgroundColor;uniform int u_charCount;uniform vec3 u_charList[255];layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 A;float B(vec3 C){return dot(C,vec3(0.299f,0.587f,0.114f));}void main(){vec2 D=vec2(v_uv.x,1.0f-v_uv.y);vec4 E=texture(u_image,D);float F=B(E.rgb);vec2 G=vec2(0.);if(u_charCount>0){float H=float(u_charCount);float I=clamp(F*(H-1.0f),0.0f,H-1.0f);int J=int(floor(I+0.5f));vec3 K=u_charList[J];G=K.xy;}else{G=vec2(0.0f,0.0f);}vec4 L=u_charColorFixed?u_charColor:E;vec4 M=u_cellColorFixed?u_cellColor:E;if(E.a<0.01f){discard;}o_primaryColor=vec4(L.rgb,L.a);o_secondaryColor=vec4(M.rgb,M.a);A=vec4(0.);int N=int(u_invert?1:0);int O=int(u_flipX?1:0);int P=int(u_flipY?1:0);float Q=float(N|(O<<1)|(P<<2))/255.;o_character=vec4(G,Q,clamp(u_charRotation,0.0f,1.0f));}`),createUniforms:({source:n})=>n.createBaseConversionUniforms()};class hi{constructor(){o(this,"tf",new Map);o(this,"Su",new Map);this.ef()}register(t){this.tf.set(t.id,t)}unregister(t){const i=this.Su.get(t);return i&&(i.dispose(),this.Su.delete(t)),this.tf.delete(t)}has(t){return this.tf.has(t)}xh(t){return this.tf.get(t)}Ch(t,i){let s=this.Su.get(t);if(!s){const e=this.tf.get(t);if(!e)throw new Error(`[textmode.js] Conversion mode "${t}" is not registered.`);s=e.createShader(i),this.Su.set(t,s)}return s}xe(){for(const t of this.Su.values())t.dispose();this.Su.clear(),this.tf.clear()}ef(){this.register(ts)}}const is=Object.freeze(Object.defineProperty({__proto__:null,TextmodeConversionManager:hi},Symbol.toStringTag,{value:"Module"}));class oi extends function(i,...s){return s.reduce((e,r)=>r(e),i)}(class{},Gi,ji,Qi,Vi,$i){constructor(i={}){super();o(this,"R");o(this,"gu");o(this,"mu");o(this,"nn");o(this,"fc");o(this,"ea");o(this,"vc");o(this,"gc");o(this,"sf");o(this,"if");o(this,"Vl");o(this,"jn");o(this,"rf",new Set);o(this,"ql");o(this,"uc");o(this,"nf");o(this,"hf",!1);o(this,"Mi",!1);o(this,"af",!1);o(this,"cf",!1);o(this,"lf",()=>{});o(this,"uf",()=>{});o(this,"ff");o(this,"df");o(this,"pf");o(this,"mn",!1);o(this,"vf");o(this,"gf");this.ql=new Vt(this),this.mn=i.overlay??!1,this.uc=new Promise(e=>{this.nf=e}),this.nn=new kt(i),this.R=new Mi(this.nn.Pn()),this.gu=this.R.ki(J,`#version 300 es
precision highp float;uniform sampler2D u_characterTexture;uniform vec2 u_charsetDimensions;uniform sampler2D Ue;uniform sampler2D Uf;uniform sampler2D Ud;uniform vec2 Ug;uniform vec2 Uh;uniform vec4 Ui;in vec2 v_uv;out vec4 fragColor;mat2 A(float B){float C=sin(B);float D=cos(B);return mat2(D,-C,C,D);}void main(){vec2 E=gl_FragCoord.xy/Uh;vec2 F=E*Ug;vec2 G=floor(F);vec2 H=(G+0.5)/Ug;vec4 I=texture(Ue,H);vec4 J=texture(Uf,H);vec4 K=texture(Ud,H);int L=int(K.b*255.+0.5);bool M=(L&1)!=0;bool N=(L&2)!=0;bool O=(L&4)!=0;int P=int(K.r*255.+0.5)+int(K.g*255.+0.5)*256;int Q=int(u_charsetDimensions.x);int R=P/Q;int S=P-(R*Q);float T=(u_charsetDimensions.y-1.)-float(R);vec2 U=1./u_charsetDimensions;vec2 V=vec2(float(S),T)*U;vec2 W=V+U;float X=-K.a*360.*0.017453292;vec2 Y=fract(F)-0.5f;vec2 Z=vec2(N?-1.:1.,O?-1.:1.);Y*=Z;Y=A(X)*Y+0.5;vec2 a=V+clamp(Y,0.,1.)*U;const float b=0.0001;if(any(lessThan(a,V-b))||any(greaterThan(a,W+b))){fragColor=M?I:J;return;}vec4 c=texture(u_characterTexture,a);if(M)c.rgb=mix(c.rgb,1.-c.rgb,float(M));vec4 d=mix(Ui,J,J.a);fragColor=mix(d,I,c);}`),this.mu=this.R.ki(J,$t),this.fc=new Xt(i.frameRate??60),this.sf=new ii(this,i.loadingScreen,this.nn.Fn()),this.sf.pu(()=>{this.fc.Kh=0,this.cf=!0}),this.if=new ni(this,i);const s=()=>this.mf();this.ea=new Gt(this.nn,s),this.vc=new Qt(this.nn,s,this.ea),this.gc=new jt,this.jn=new hi,this.ql.Tc(i.plugins??[]),this.sf.zh(),this._f()}lc(i){var s;this.rf.add(i),(s=i.C)==null||s.call(i,()=>{this.rf.delete(i)})}yf(){var r;const i=(r=this.if)==null?void 0:r.base.grid;if(!i)return;const s=i.cols,e=i.rows;for(const h of this.rf)h instanceof ft&&h.$n(s,e);this.vf&&this.vf.$n(s,e)}async _f(){await this.if.jr(),this.nf(),await this.sf.jr();const i=this.if.base.grid;this.yf(),this.if.Vu(()=>{this.ea.To(),this.vc.To()}),this.mn&&(this.vf=W.Mh(this.R,this.jn,this.nn.targetCanvas,i.cols,i.rows)),this.wf(),i.fn(()=>{this.yf()}),this.fc.zh(()=>this.dc());try{await this.ql.Ic(),await this.lf(),await this.ql.Nc(),this.sf.yl()}catch(s){console.error("Error during setup:",s),this.sf.error(s)}}wf(){this.ff=()=>{this.mn&&this.resizeCanvas(this.nn.targetCanvas.width,this.nn.targetCanvas.height),this.uf()},window.addEventListener("resize",this.ff),this.ea.Ao(),this.vc.Ao(),this.gc.Ao(),this.df=()=>{this.gc.ta()},window.addEventListener("blur",this.df),this.mn&&(this.pf=new ResizeObserver(()=>{this.resizeCanvas(this.nn.targetCanvas.width,this.nn.targetCanvas.height)}),this.pf.observe(this.nn.targetCanvas))}dc(){if(!this.sf.pl&&this.cf){this.Mi=!0,this.R.Ti(!0);try{this.fc.jh(),this.fc.Wh(),this.mn&&et(this.R.context,this.vf.texture,this.nn.targetCanvas),this.if.Zu()}finally{this.Mi=!1,this.R.Ti(!1),this.hf&&!this.af&&this.Af()}}}resizeCanvas(i,s){var e;this.nn.$n(i,s),this.sf._u(this.nn.Fn()),this.sf.$n(),(e=this.if)==null||e.$n(),this.R.Zi(),this.dc()}destroy(){this.af||this.hf||(this.hf=!0,this.fc.Ih(),this.Mi||this.Af())}Af(){var i,s,e,r;this.hf=!1,this.nn.xe(),this.sf.xe(),this.ql.jc(),window.removeEventListener("resize",this.ff),window.removeEventListener("blur",this.df),(i=this.pf)==null||i.disconnect(),this.ea.Po(),this.vc.Po(),this.gc.Po(),(s=this.if)==null||s.xe(),(e=this.jn)==null||e.xe();for(const h of this.rf)h.dispose();this.rf.clear(),this.gu.dispose(),this.mu.dispose(),this.R.xe(),(r=this.vf)==null||r.dispose(),this.af=!0}filter(i,s){this.if.Xu(i,s)}draw(i){this.if.base.draw(i)}async loadFont(i,s=!0){if(s)return await this.if.base.loadFont(i),this.if.base.font;if(i instanceof Q)return i.tn||await i.jr(),i;const e=new Q(this.R);return await e.jr(i),this.lc(e),e}fontSize(i){return this.if.base.fontSize(i)}inputGrid(i){return i===void 0?this.gf??"topmost":i==="topmost"?(this.gf=void 0,this.ea.To(),void this.vc.To()):(this.gf=i,this.ea.To(),void this.vc.To())}mf(){return this.gf?this.gf:this.if.qu()}async setup(i){this.lf=i}windowResized(i){this.uf=i}get grid(){var i;return((i=this.Vl)==null?void 0:i.grid)??this.if.base.grid}get font(){var i;return((i=this.Vl)==null?void 0:i.font)??this.if.base.font}get width(){return this.nn.width}get height(){return this.nn.height}get canvas(){return this.nn.canvas}get isDisposed(){return this.af}get overlay(){return this.vf}get loading(){return this.sf}get layers(){return this.if}get filters(){return this.if.filters}get conversions(){return this.jn}get isRenderingFrame(){return this.Mi}}class mt{constructor(){}static create(t={}){return new oi(t)}static setErrorLevel(t){At._(t)}static get version(){return"0.10.0"}}const ss=Object.freeze(Object.defineProperty({__proto__:null,LoadingPhase:ti,LoadingPhaseTracker:Zt,LoadingScreenManager:ii,LoadingScreenStateMachine:qt,LoadingScreenTransition:Wt,resolveColorInputs:Jt,resolveDefaultPalette:Kt,resolveTheme:Rt},Symbol.toStringTag,{value:"Module"})),es=Object.freeze(Object.defineProperty({__proto__:null,TextmodeFont:Q,TextmodeImage:W,TextmodeSource:ft,TextmodeTexture:K,TextmodeVideo:D},Symbol.toStringTag,{value:"Module"})),rs=Object.freeze(Object.defineProperty({__proto__:null,keyboard:Xi,mouse:ki,touch:Hi},Symbol.toStringTag,{value:"Module"})),ns=Object.freeze(Object.defineProperty({__proto__:null,LayerCompositor:ei,TextmodeLayer:gt,TextmodeLayerManager:ni},Symbol.toStringTag,{value:"Module"})),hs=mt.create,os=mt.setErrorLevel,as=mt.version;x.TextmodeCanvas=kt,x.TextmodeColor=E,x.TextmodeError=R,x.TextmodeErrorLevel=O,x.TextmodeFramebuffer=$,x.TextmodeGrid=Dt,x.TextmodeShader=H,x.Textmodifier=oi,x.conversion=is,x.create=hs,x.filters=Ji,x.input=rs,x.layering=ns,x.loadables=es,x.loading=ss,x.plugins=Zi,x.setErrorLevel=os,x.textmode=mt,x.version=as,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
